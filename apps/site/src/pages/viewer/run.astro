---

const title = "3DSL Viewer – Astro Host";

// When embedded via /app/viewer, we want /viewer to be a pure viewport
// (no promo ticker / doc caption / meta side panel) so host can own the UI.
const sp = Astro.url.searchParams;
const embed = sp.get("embed") === "1";
---

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>{title}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/viewer/viewer.css" />
  </head>

  <body class="bg-black text-neutral-200 overflow-hidden">
    <div
      id="viewer-layout"
      class={
        embed
          ? "viewer-layout grid grid-cols-1 h-[100dvh]"
          : "viewer-layout grid grid-cols-1 lg:[grid-template-columns:minmax(0,1fr)_300px] h-[100dvh]"
      }
    >
      <!-- =========================================================
           左カラム：3D ビュー本体 + 全オーバーレイ
           ====================================================== -->
      <main
        id="viewer-main"
        class="viewer-main relative bg-black overflow-hidden touch-none"
      >
        <!-- 3D シーン -->
        <canvas
          id="viewer-canvas"
          data-role="viewer-canvas"
          class="viewer-canvas w-full h-full block touch-none"
        ></canvas>

        <!-- =======================================================
             上段オーバーレイ：広告 / プロモ / HUD
             ==================================================== -->

        {embed ? null : (
          <div id="promo-ticker-bar">
            <div class="promo-ticker-shell">
              <div class="promo-ticker-line">
                <span>往還構造 / 分水嶺 / エントロピー × 知識トポス …</span>
                <span>時間逆行の議論と同型の 3DSD 図解をもっと見る</span>
              </div>
            </div>
          </div>
        )}

        <!-- HUD: 一時メッセージ用トースト -->
        <div
          id="viewer-hud"
          data-role="viewer-hud"
          class="viewer-hud hud-hidden absolute left-1/2 top-12 max-w-[60%]
                 -translate-x-1/2 -translate-y-2 transform origin-top
                 px-4 py-2 rounded-full text-xs leading-relaxed
                 text-neutral-100 pointer-events-none opacity-0
                 transition-transform transition-opacity duration-200 ease-out"
        ></div>


        <!-- =======================================================
            document caption（シーンビューポート右上）
            ==================================================== -->
        {embed ? null : (
          <section id="doc-caption" class="doc-caption-card">
            <div
              id="doc-caption-title"
              data-role="doc-caption-title"
              class="doc-caption-title"
            ></div>
            <div
              id="doc-caption-body"
              data-role="doc-caption-body"
              class="doc-caption-body"
            ></div>
          </section>
        )}

        <!-- =======================================================
             下段オーバーレイ：frame / viewer settings / gizmo / camera
             ==================================================== -->

        <!-- 左下：フレーム操作 + viewer settings -->
        <section
          id="viewer-toolbar"
          class="viewer-toolbar absolute left-3 bottom-3 text-xs text-neutral-100 pointer-events-auto
                 origin-bottom-left scale-[0.67] sm:scale-75 lg:scale-100"
        >
          <!-- フレーム操作パネル -->
          <div
            id="frame-panel"
            data-role="frame-block"
            class="frame-panel frame-block flex flex-col gap-2 px-3 py-2"
          >
            <!-- ⑥ filter 縦３連 -->
            <div
              id="frame-filters"
              class="frame-filters flex flex-col gap-1"
            >
              <button
                type="button"
                id="filter-lines"
                data-role="filter-lines"
                data-filter="lines"
                class="filter-toggle filter-on"
              >
                <span class="filter-icon filter-icon-on">
                  <img
                    src="/viewer/assets/icons/visibility-on.svg"
                    alt=""
                    class="filter-icon-img"
                  />
                </span>
                <span class="filter-icon filter-icon-off">
                  <img
                    src="/viewer/assets/icons/visibility-off.svg"
                    alt=""
                    class="filter-icon-img"
                  />
                </span>
                <span class="filter-label">lines</span>
              </button>

              <button
                type="button"
                id="filter-points"
                data-role="filter-points"
                data-filter="points"
                class="filter-toggle filter-on"
              >
                <span class="filter-icon filter-icon-on">
                  <img
                    src="/viewer/assets/icons/visibility-on.svg"
                    alt=""
                    class="filter-icon-img"
                  />
                </span>
                <span class="filter-icon filter-icon-off">
                  <img
                    src="/viewer/assets/icons/visibility-off.svg"
                    alt=""
                    class="filter-icon-img"
                  />
                </span>
                <span class="filter-label">points</span>
              </button>

              <button
                type="button"
                id="filter-aux"
                data-role="filter-aux"
                data-filter="aux"
                class="filter-toggle filter-on"
              >
                <span class="filter-icon filter-icon-on">
                  <img
                    src="/viewer/assets/icons/visibility-on.svg"
                    alt=""
                    class="filter-icon-img"
                  />
                </span>
                <span class="filter-icon filter-icon-off">
                  <img
                    src="/viewer/assets/icons/visibility-off.svg"
                    alt=""
                    class="filter-icon-img"
                  />
                </span>
                <span class="filter-label">aux</span>
              </button>
            </div>

            <!-- ⑤ 再生ボタン 横５連 -->
            <div
              id="frame-controls"
              data-role="frame-controls"
              class="frame-controls row-continuous flex gap-1 items-center mt-1"
            >
              <button
                id="btn-rew"
                data-role="btn-rew"
                type="button"
                class="frame-btn frame-btn-edge px-3.2 py-0.4 border border-white/20
                       bg-white/40 text-[10px] text-neutral-100 hover:bg-white/20"
                title="最初のフレームへ（min までジャンプ）"
              >
                <img
                  src="/viewer/assets/icons/frame-first.svg"
                  alt=""
                  class="frame-icon-img"
                />
              </button>

              <button
                id="btn-step-back"
                data-role="btn-step-back"
                type="button"
                class="frame-btn frame-btn-step px-3.2 py-0.4 border border-white/20
                       bg-white/60 text-[10px] text-neutral-100 hover:bg-white/20"
                title="1 フレーム戻る (PgDn)"
              >
                <img
                  src="/viewer/assets/icons/frame-prev.svg"
                  alt=""
                  class="frame-icon-img"
                />
              </button>

              <button
                id="btn-play"
                data-role="btn-play"
                type="button"
                class="frame-btn frame-btn-play px-4 py-0.4 border border-white/20
                       bg-white/80 text-[10px] text-neutral-100 hover:bg-white/20"
                title="連続再生 / 一時停止 (Space)"
              >
                <span class="frame-play-icon">
                  <img
                    src="/viewer/assets/icons/frame-play.svg"
                    alt=""
                    class="frame-icon-img"
                  />
                </span>
                <span class="frame-pause-icon">
                  <img
                    src="/viewer/assets/icons/frame-pause.svg"
                    alt=""
                    class="frame-icon-img"
                  />
                </span>
              </button>

              <button
                id="btn-step-forward"
                data-role="btn-step-forward"
                type="button"
                class="frame-btn frame-btn-step px-3.2 py-0.4 border border-white/20
                       bg-white/60 text-[10px] text-neutral-100 hover:bg-white/20"
                title="1 フレーム進む (PgUp)"
              >
                <img
                  src="/viewer/assets/icons/frame-next.svg"
                  alt=""
                  class="frame-icon-img"
                />
              </button>

              <button
                id="btn-ff"
                data-role="btn-ff"
                type="button"
                class="frame-btn frame-btn-edge px-3.2 py-0.4 border border-white/20
                       bg-white/40 text-[10px] text-neutral-100 hover:bg-white/20"
                title="最後のフレームへ（max までジャンプ）"
              >
                <img
                  src="/viewer/assets/icons/frame-last.svg"
                  alt=""
                  class="frame-icon-img"
                />
              </button>
            </div>

            <!-- ④ + ①〜③ フレームバー＋ラベル -->
            <div
              id="frame-slider-wrapper"
              data-role="frame-slider-wrapper"
              class="frame-slider-wrapper relative mt-1"
            >
              <div
                id="frame-label-current"
                data-role="frame-label-current"
                class="frame-label-current"
              >
                0
              </div>

              <input
                id="frame-slider"
                data-role="frame-slider"
                class="frame-slider"
                type="range"
                min="0"
                max="0"
                step="1"
                value="0"
              />

              <div class="frame-labels">
                <span
                  id="frame-label-min"
                  data-role="frame-label-min"
                  class="frame-label frame-label-min"
                >
                  0
                </span>

                <span
                  id="frame-label-zero"
                  data-role="frame-label-zero"
                  class="frame-label frame-label-zero"
                >
                  0
                </span>

                <div
                  id="frame-zero-line"
                  data-role="frame-zero-line"
                  class="frame-zero-line"
                ></div>

                <span
                  id="frame-label-max"
                  data-role="frame-label-max"
                  class="frame-label frame-label-max"
                >
                  0
                </span>
              </div>
            </div>
          </div>
        </section>

        <!-- 右下：Gizmo 本体 -->
        <section
          id="gizmo-wrapper"
          class="gizmo-wrapper absolute right-3 bottom-3
                 w-[140px] h-[140px] sm:w-[170px] sm:h-[170px] lg:w-[210px] lg:h-[210px]
                 pointer-events-auto z-20"
        >
          <!-- three.js 用の枠（JS がキャンバスを差し込む） -->
          <div
            id="gizmo-slot"
            data-role="gizmo-slot"
            class="gizmo-slot absolute inset-0 rounded-2xl border border-white/20
                   bg-black/60 shadow-lg overflow-hidden"
          ></div>

          <!-- モード表示（右上テキスト） -->
          <div
            id="gizmo-mode-indicator"
            class="gizmo-mode-indicator absolute right-2 top-2
                   text-[11px] text-neutral-100 pointer-events-none"
          >
            <span
              id="gizmo-mode-label"
              data-role="gizmo-mode-label"
              class="tracking-[0.12em] lowercase"
            >
              macro
            </span>
          </div>

          <!-- 下辺オーバーレイ：
               左 = world-axis トグル
               中央 = gizmo-axis-row（JS がボタンを突っ込む）
               右 = preset view -->
          <div
            class="gizmo-bottom-row absolute left-1 right-1 bottom-1
                   flex items-center justify-between gap-1 z-30"
          >
            <!-- coord. トグル（world-axis） -->
            <div
              class="world-axes-toggle flex items-center gap-1 text-xs text-neutral-200"
            >
              <button
                id="world-axes-toggle"
                data-role="world-axes-toggle"
                type="button"
                aria-pressed="false"
                data-visible="false"
                class="world-axes-pill inline-flex items-center gap-1 px-1 py-0.5
                       rounded-full bg-white/5 text-[11px] text-neutral-100
                       border border-white/15"
              >
                <!-- on: 軸あり -->
                <span class="coordinate-icon" data-icon="on">
                  <img
                    src="/viewer/assets/icons/coordinate-on.svg"
                    alt=""
                    class="coordinate-icon-img"
                  />
                </span>
                <!-- off: 軸なし -->
                <span class="coordinate-icon" data-icon="off">
                  <img
                    src="/viewer/assets/icons/coordinate-off.svg"
                    alt=""
                    class="coordinate-icon-img"
                  />
                </span>
              </button>
            </div>

            <!-- 軸ボタン（JS がここに配置） -->
            <div
             data-role="gizmo-axis-row"
             class="gizmo-axis-row flex gap-1">
            </div>

            <!-- view preset ボタン（JS生成） -->
            <div
             data-role="gizmo-view-row"
             class="gizmo-view-row flex gap-1">
            </div>

            <!-- preset view ボタン（右下） -->
            <button
              id="gizmo-presets-toggle"
              data-role="gizmo-presets-toggle"
              class="keycap gizmo-presets-toggle flex flex-col items-stretch px-1 py-0.5 text-[10px]"
              type="button"
              title="Preset views"
            >
              <span class="w-full text-left leading-tight text-[11px]">
                preset
              </span>
              <span class="w-full text-right leading-tight text-[11px]">
                view
              </span>
            </button>
          </div>
        </section>

        <!-- Gizmo 左：autoOrbit -->
        <section
          id="camera-bottom-row"
          class="camera-bottom-row absolute right-[230px] bottom-3 z-25 pointer-events-auto"
        >
          <div id="auto-orbit-slot" data-role="auto-orbit-slot" class="auto-orbit-slot">
            <div class="auto-orbit-pill">
              <!-- 左：CW（Z+ から見て時計回り） -->
              <button
                type="button"
                class="auto-orbit-btn auto-orbit-btn-dir"
                data-role="auto-orbit-cw"
                data-dir="cw"
              >
                <span class="auto-orbit-icon auto-orbit-icon-cw">
                  <img
                    src="/viewer/assets/icons/360-cw.svg"
                    alt=""
                    class="auto-orbit-icon-img"
                  />
                </span>
              </button>

              <!-- 中央：autoOrbit（2 段組） -->
              <button
                type="button"
                id="auto-orbit-toggle"
                data-role="auto-orbit-toggle"
                class="auto-orbit-btn auto-orbit-center"
              >
                <span class="auto-orbit-text-top">auto</span>
                <span class="auto-orbit-text-bottom">Orbit</span>
              </button>

              <!-- 右：CCW（Z+ から見て反時計回り） -->
              <button
                type="button"
                class="auto-orbit-btn auto-orbit-btn-dir"
                data-role="auto-orbit-ccw"
                data-dir="ccw"
              >
                <span class="auto-orbit-icon auto-orbit-icon-ccw">
                  <img
                    src="/viewer/assets/icons/360-ccw.svg"
                    alt=""
                    class="auto-orbit-icon-img"
                  />
                </span>
              </button>
            </div>
          </div>
        </section>
      </main>

      <!-- =========================================================
           右カラム：メタ情報エリア
           ====================================================== -->
      {embed ? null : (
      <aside
        id="viewer-meta"
        class="viewer-meta hidden lg:flex bg-neutral-900 border-l border-neutral-700 p-3 text-sm
               flex-col min-h-0"
      >
        <!-- ロゴ -->
        <header
          id="meta-header"
          class="meta-header border-b border-white/10 px-3
                 h-16 flex items-center justify-start"
        >
          <a
            id="meta-logo-link"
            href="/viewer/"
            class="block w-full"
          >
            <img
              id="meta-logo"
              src="/viewer/assets/logo/3DSD-viewer.svg"
              alt="3DSD-viewer"
              style="display:block;height:80px;width:auto;"
              class="invert"
            />
          </a>
        </header>

        <!-- File 情報 -->
        <section
          id="meta-file"
          data-role="meta-file"
          class="meta-file basis-[20%] shrink overflow-y-auto"
        >
          <h3
            class="text-[11px] font-medium tracking-[0.03em]
                   uppercase opacity-90 mb-1"
          >
            File
          </h3>
          <div class="text-xs text-neutral-300">(no file yet)</div>
        </section>

        <!-- Model 情報 + detail -->
        <section
          id="meta-model"
          data-role="meta-model"
          class="meta-model flex-1 min-h-0 px-2 pt-2 pb-3 overflow-y-auto"
        >
          <h3
            class="text-[11px] font-medium tracking-[0.03em]
                   uppercase opacity-90 mb-1"
          >
            Model
          </h3>

          <div
            id="meta-model-log"
            data-role="meta-model-log"
            class="meta-log text-xs leading-snug text-neutral-300 space-y-1"
          >
            (logs will appear here)
          </div>
          <div
            id="viewer-detail"
            data-role="viewer-detail"
          >
          </div>
        </section>
      </aside>
      )}
    </div>
    <!-- auto boot -->
    <!-- embed=1 fallback for static output (query params are client-side) -->
<script is:inline>
  (function () {
    try {
      const sp = new URLSearchParams(location.search);
      if (sp.get('embed') === '1') {
        document.documentElement.classList.add('is-embed');
      }
    
    // ui-mobile: compact HUD layout for small screens (avoid overlaps)
    const mq = (typeof window !== 'undefined' && window.matchMedia)
      ? window.matchMedia('(max-width: 520px)')
      : null;
    if (mq) {
      const apply = () => document.documentElement.classList.toggle('ui-mobile', mq.matches);
      apply();
      if (mq.addEventListener) mq.addEventListener('change', apply);
      else if (mq.addListener) mq.addListener(apply);
      window.addEventListener('resize', apply, { passive: true });
      window.addEventListener('orientationchange', apply, { passive: true });
    }

} catch {}
  })();
</script>
<style is:inline>
  .is-embed #promo-ticker-bar,
  .is-embed #doc-caption,
  .is-embed #viewer-meta {
    display: none !important;
  }
  .is-embed #viewer-layout {
    grid-template-columns: minmax(0, 1fr) !important;
  }
</style>

<script type="module" src="/viewer/viewerHostBoot.js"></script>
  </body>
</html>

