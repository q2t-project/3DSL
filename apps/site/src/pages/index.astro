---
import Layout from "../layouts/Layout.astro";
import TopText from "../content/pages/top.md";

import fs from "node:fs/promises";

const demoModel = "/3dss/scenes/top/top.3dss.json";

// Featured examples
// NOTE: This file is generated by `npm run sync:3dss-content` and mirrored into `public/`.
type LibraryIndexItem = {
  id: string;
  title: string;
  summary?: string | null;
  tags?: string[] | null;
  published?: boolean | null;
};

const libraryIndexUrl = new URL("../../public/_data/library/library_index.json", import.meta.url);

let featured: LibraryIndexItem[] = [];
try {
  const raw = await fs.readFile(libraryIndexUrl, "utf8");
  const parsed = JSON.parse(raw);
  const items = Array.isArray(parsed?.items) ? (parsed.items as LibraryIndexItem[]) : [];
  const isOk = (it: LibraryIndexItem) => {
    const title = (it.title ?? "").toLowerCase();
    const tags = Array.isArray(it.tags) ? it.tags : [];
    // Avoid obvious stress/perf fixtures in the homepage showcase
    if (title.includes("stress")) return false;
    if (title.includes("load test")) return false;
    if (tags.some((t) => String(t).toLowerCase().includes("stress"))) return false;
    return true;
  };
  const normTags = (it: LibraryIndexItem) => (Array.isArray(it.tags) ? it.tags.map(String) : []);

  const isTop = (it: LibraryIndexItem) => normTags(it).includes("m:top");
  const isDefault = (it: LibraryIndexItem) => normTags(it).includes("m:default");

  const uniq = (arr: LibraryIndexItem[]) => {
    const seen = new Set<string>();
    const out: LibraryIndexItem[] = [];
    for (const it of arr) {
      if (!it?.id) continue;
      if (seen.has(it.id)) continue;
      seen.add(it.id);
      out.push(it);
    }
    return out;
  };

  const ok = items.filter(isOk);
  // Prefer curated items first (m:top -> m:default), then fill with the rest.
  featured = uniq([
    ...ok.filter(isTop),
    ...ok.filter((it) => !isTop(it) && isDefault(it)),
    ...ok.filter((it) => !isTop(it) && !isDefault(it)),
  ]).slice(0, 3);
} catch {
  featured = [];
}

const featuredPrimary = featured?.[0]?.id ? `/library/${featured[0].id}` : "/library";
const ctaHref = featuredPrimary;
---

<Layout
  title="3DSL"
  description="3DSL は、概念や関係を三次元の座標に配置し、拡大縮小しながら局面と総体を行き来できる表現基盤です。"
>
  <!-- Hero: information-dense, business-like UI (surface + clear hierarchy) -->
  <section class="grid gap-6 lg:grid-cols-12">
    <div class="ui-surface p-6 sm:p-8 lg:col-span-8 flex flex-col">
      <div class="mt-4 max-w-[52ch] prose prose-invert prose-neutral prose-p:my-3 hero-copy home-poem font-content">
        <TopText />
      </div>

      <div class="mt-6 pt-2">
        <div class="home-peek ui-border ui-shadow" aria-hidden="true" data-swipe-ignore>
          <iframe
            class="home-peek__frame"
            src={`/viewer/peek.html?embed=1&model=${encodeURIComponent(demoModel)}&v=20260110b`}
            loading="lazy"
            title="3DSL demo preview"
            tabindex="-1"
            aria-hidden="true"
          ></iframe>
          <div class="home-peek__fade"></div>
        </div>
      </div>
    </div>

    <aside class="lg:col-span-4 grid gap-4">
	      <div class="ui-surface p-6">
	        <h2 class="text-lg font-semibold tracking-tight">このサイトでできること</h2>
        <ul class="mt-3 text-sm text-neutral-300 list-disc pl-5 space-y-2">
          <li>Library：作品を眺めて、刺さったものだけ詳細へ</li>
          <li>Viewer：拡大縮小・視点操作で、局面↔総体を行き来</li>
          <li>Docs / Concept：用語・運用・背景の整理</li>
        </ul>
      </div>
    </aside>
  </section>

  <!-- Entry cards: consistent UI components -->
  <section class="mt-10">
    <div class="flex items-end justify-between gap-3">
      <h2 class="text-lg font-medium">入口</h2>
    </div>

    <div class="mt-4 grid gap-4 md:grid-cols-2">
      <a href="/library" class="ui-card p-6">
        <div class="flex items-center justify-between">
	          <h3 class="text-lg font-semibold tracking-tight">Library</h3>
          
        </div>
        <p class="mt-2 text-sm text-neutral-300">
          サムネで眺めて、刺さったものだけ詳細へ。操作による探索は Viewer へのリンクで行います。
        </p>
      </a>

      
      <a href="/app/viewer" class="ui-card p-6">
        <div class="flex items-center justify-between">
	          <h3 class="text-lg font-semibold tracking-tight">Viewer</h3>
          
        </div>
        <p class="mt-2 text-sm text-neutral-300">
          拡大縮小・視点操作で、局面と総体を往復。言語の積み上げ無しで「何か」を掴む入口。
        </p>
      </a>

      <a href="/docs" class="ui-card p-6">
        <div class="flex items-center justify-between">
	          <h3 class="text-lg font-semibold tracking-tight">Docs</h3>
          
        </div>
        <p class="mt-2 text-sm text-neutral-300">
          用語、設計、運用（引用・権利表記）のハブ。クローラにも意味密度を持たせる領域。
        </p>
      </a>

      <a href="/concept" class="ui-card p-6">
        <div class="flex items-center justify-between">
	          <h3 class="text-lg font-semibold tracking-tight">Concept</h3>
          
        </div>
        <p class="mt-2 text-sm text-neutral-300">
          分節化と言語化の限界、図＝関係、マルチスケールの意味。抽象の受け皿。
        </p>
      </a>
    </div>
  </section>

  <!-- Home: lower half (rewrite) -->
  <section class="mt-16 space-y-14">
    {/* 3DSLとは */}
    <section class="ui-surface p-6 sm:p-10">
      <header class="flex flex-col gap-3">
        <h2 class="text-2xl sm:text-3xl font-semibold tracking-tight">3DSLとは何か</h2>
        <p class="text-sm sm:text-base text-neutral-200 leading-7 max-w-[78ch]">
          三次元構造言語（3DSL）は、思考や概念を「立体構造」として表現・共有するための記述体系です。
          文章や図だけでは捉えきれない関係性・階層・方向性を、三次元空間上の構造として扱います。
        </p>
        <div class="pt-2">
          <a class="ui-btn inline-flex" href="/concept">詳しく見る：Concept</a>
        </div>
      </header>

      <div class="mt-10 grid gap-8 sm:gap-10 lg:grid-cols-2">
        <div class="space-y-3">
          <h3 class="text-lg sm:text-xl font-semibold">なぜ「三次元」なのか</h3>
          <p class="text-sm sm:text-base text-neutral-200 leading-7">
            言葉や図は、基本的に一次元・二次元の表現です。
            しかし実際の思考や理解は、複数の軸・視点・粒度を同時に行き来しています。
            3DSLは、その同時性を失わずに扱うために、三次元という表現空間を採用しています。
          </p>
        </div>

        <div class="space-y-3">
          <h3 class="text-lg sm:text-xl font-semibold">3DSLでできること</h3>
          <ul class="mt-2 space-y-2 text-sm sm:text-base text-neutral-200 leading-7 list-disc pl-5">
            <li>概念・要素・関係を点と線として配置する</li>
            <li>視点やスケールを切り替えて構造を読み直す</li>
            <li>構造そのものをデータとして保存・再利用する</li>
          </ul>
          <p class="mt-4 text-sm text-neutral-300 leading-7">
            これらを通して、「考える」「説明する」「共有する」行為を支援します。
          </p>
        </div>
      </div>
    </section>

    {/* このサイトでできること（操作点） */}
    <section class="ui-surface p-6 sm:p-10">
      <header class="flex flex-col gap-3">
        <h2 class="text-2xl sm:text-3xl font-semibold tracking-tight">このサイトでできること</h2>
        <p class="text-sm sm:text-base text-neutral-200 leading-7 max-w-[78ch]">
          3DSLを体験・閲覧・理解するための入口です。まずは作品を見るか、Viewerで触ってみてください。
        </p>
      </header>

      <div class="mt-8 grid gap-4 sm:gap-5 lg:grid-cols-4">
        <article class="rounded-2xl border border-white/10 bg-white/5 p-5 sm:p-6">
          <h3 class="text-base sm:text-lg font-semibold">Library</h3>
          <p class="mt-2 text-sm text-neutral-200 leading-7">
            構造モデルを一覧で眺め、興味のあるものを選んで詳しく見られます。
          </p>
          <div class="mt-4">
            <a class="ui-btn inline-flex" href="/library">作品を見る</a>
          </div>
        </article>

        <article class="rounded-2xl border border-white/10 bg-white/5 p-5 sm:p-6">
          <h3 class="text-base sm:text-lg font-semibold">Viewer</h3>
          <p class="mt-2 text-sm text-neutral-200 leading-7">
            回転・拡大縮小しながら、関係性や配置を直感的に把握できます。
          </p>
          <div class="mt-4">
            <a class="ui-btn inline-flex" href="/viewer">Viewerへ</a>
          </div>
        </article>

        <article class="rounded-2xl border border-white/10 bg-white/5 p-5 sm:p-6">
          <h3 class="text-base sm:text-lg font-semibold">Docs</h3>
          <p class="mt-2 text-sm text-neutral-200 leading-7">
            用語・設計・運用（引用・権利表記）などを文章で整理しています。
          </p>
          <div class="mt-4">
            <a class="ui-btn inline-flex" href="/docs">Docsを読む</a>
          </div>
        </article>

        <article class="rounded-2xl border border-white/10 bg-white/5 p-5 sm:p-6">
          <h3 class="text-base sm:text-lg font-semibold">Concept</h3>
          <p class="mt-2 text-sm text-neutral-200 leading-7">
            背景思想と方針。3DSLの「狙い」と「限界」を言語化します。
          </p>
          <div class="mt-4">
            <a class="ui-btn inline-flex" href="/concept">Conceptへ</a>
          </div>
        </article>
      </div>
    </section>

    {/* 代表的な作例 */}
    <section class="ui-surface p-6 sm:p-10">
      <header class="flex flex-col gap-3">
        <h2 class="text-2xl sm:text-3xl font-semibold tracking-tight">代表的な作例</h2>
        <p class="text-sm sm:text-base text-neutral-200 leading-7 max-w-[78ch]">
          3DSLを使った具体的な構造表現の例です。各作例ページには短い解説と、Viewerでの閲覧導線があります。
        </p>
      </header>

      <div class="mt-8 grid gap-4 sm:gap-5 lg:grid-cols-3">
        {featuredItems.map((it) => (
          <a
            href={`/library/${it.id}`}
            class="block rounded-2xl border border-white/10 bg-white/5 p-5 sm:p-6 hover:bg-white/10 transition"
          >
            <div class="text-xs text-neutral-400">{it.id}</div>
            <div class="mt-1 text-base font-semibold">{it.title}</div>
            <p class="mt-2 text-sm text-neutral-200 leading-7">{it.summary || "—"}</p>
            <div class="mt-4 text-sm text-neutral-300">→ この作例を見る</div>
          </a>
        ))}
      </div>

      <div class="mt-8">
        <a class="ui-btn inline-flex" href="/library">事例一覧を見る：Library</a>
      </div>
    </section>

    {/* どんな人に向いているか + CTA */}
    <section class="grid gap-4 sm:gap-5 lg:grid-cols-2">
      <section class="ui-surface p-6 sm:p-10">
        <h2 class="text-2xl sm:text-3xl font-semibold tracking-tight">どんな人に向いているか</h2>
        <ul class="mt-6 space-y-2 text-sm sm:text-base text-neutral-200 leading-7 list-disc pl-5">
          <li>複雑な概念や関係性を整理したい人</li>
          <li>文章や図だけでは説明しきれない構造を扱う人</li>
          <li>思考や知識を「形」として残したい人</li>
          <li>研究・設計・教育・思考整理など、用途は限定していません</li>
        </ul>
      </section>

      <section class="ui-surface p-6 sm:p-10">
        <h2 class="text-2xl sm:text-3xl font-semibold tracking-tight">まずは触ってみる</h2>
        <p class="mt-3 text-sm sm:text-base text-neutral-200 leading-7">
          はじめての方は、まずおすすめの作例を開いて、Viewerで回してみてください。
        </p>

        <div class="mt-6 flex flex-col sm:flex-row gap-3">
          <a class="ui-btn inline-flex justify-center" href={ctaHref}>おすすめのモデルを開く</a>
          <a class="ui-btn inline-flex justify-center" href="/docs">使い方を見る（Docs）</a>
        </div>

        <p class="mt-4 text-xs text-neutral-400 leading-6">
          ※ 作品ページからViewerに移動して閲覧します。
        </p>
      </section>
    </section>
  </section>


  <style>
    /* Home-only typography (poetic tone) */
    .home-poem {
      letter-spacing: 0.01em;
      font-weight: 300;
      text-rendering: geometricPrecision;
    }
    .home-poem :is(h1, h2, h3, strong) {
      font-weight: 400;
    }
    .home-poem p {
      line-height: 1.95;
      margin: 0 0 0.85em;
    }
    .home-poem p:last-child {
      margin-bottom: 0;
    }

    /* Demo peek: show part of the viewer to invite scrolling */
    .home-peek {
      position: relative;
      height: min(52vh, 520px);
      overflow: hidden;
      border-radius: 18px;
      background: #0b0f14;
    }
    .home-peek__frame {
      position: absolute;
      inset: -12px;
      width: calc(100% + 24px);
      height: calc(100% + 24px);
      border: 0;
      pointer-events: auto; /* interactive (orbit) */
      transform: translateY(-18%);
      filter: saturate(0.9) contrast(1.05);
    }
    .home-peek__fade {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: linear-gradient(
        to bottom,
        rgba(0, 0, 0, 0.7) 0%,
        rgba(0, 0, 0, 0.15) 22%,
        rgba(0, 0, 0, 0) 45%,
        rgba(0, 0, 0, 0.25) 78%,
        rgba(0, 0, 0, 0.75) 100%
      );
    }
    .home-peek__hint {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 2;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
  </style>

</Layout>
