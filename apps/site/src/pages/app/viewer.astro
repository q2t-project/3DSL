---
import LayoutApp from "../../layouts/LayoutApp.astro";

const DEFAULT_MODEL = "/3dss/sample/core_viewer_baseline.3dss.json";
const sp = Astro.url.searchParams;

function normalizeModelUrl(raw) {
  const v = (raw ?? "").trim();
  if (!v) return DEFAULT_MODEL;
  // Allow absolute URLs (useful for local/proxy testing). Otherwise force root-absolute.
  if (/^https?:\/\//i.test(v)) return v;
  if (v.startsWith("/")) return v;
  if (v.startsWith("3dss/")) return `/${v}`;
  return `/${v}`;
}

// Canonical param is `model`; keep `src` alias.
// Library pages use `id` (short) => /3dss/library/<id>/model.3dss.json
const id = (sp.get("id") ?? "").trim();
const model = normalizeModelUrl(
  // canonical
  sp.get("model") ??
  // legacy alias (typo in older links)
  sp.get("mode") ??
  // other legacy alias
  sp.get("src") ??
  (id ? `/3dss/library/${encodeURIComponent(id)}/model.3dss.json` : "")
);
const back = (sp.get("back") || "/library").trim() || "/library";

// /viewer stays pure; /app/viewer adds ads + simple top chrome.
// embed=1: keep the embedded viewer free of its own chrome.
// Use explicit index.html to avoid any server differences around "/viewer/" resolution.
const iframeSrc = `/viewer/index.html?model=${encodeURIComponent(model)}&embed=1`;
---

<LayoutApp title="Viewer">
  <!--
    Full-viewport fixed app shell:
    - prevents browser scroll restoration from showing the UI "stuck" at the bottom
    - makes the vertical stack (ad / ticker / viewer) deterministic
  -->
  <div id="appviewer-root" class="appviewer-root fixed inset-0 flex h-[100dvh] w-full flex-col overflow-hidden bg-black">
    <!-- iOS/Android safe-area (top) -->
    <div class="app-safe-top lg:hidden" aria-hidden="true"></div>

    <!-- 1) Mobile: Top ad (320x100) - fixed height -->
    <div id="app-adbar" class="lg:hidden shrink-0 border-b border-white/10 bg-neutral-950">
      <div class="app-ad-wrap app-chrome-pad">
        <div class="app-ad-label" aria-hidden="true">Sponsored</div>
        <div class="app-ad-box rounded-xl border border-white/10 bg-white/5 grid place-items-center text-xs text-neutral-400">
          Ad Slot (320×100)
        </div>
      </div>
    </div>

    <!-- 2) Ticker (single line, marquee) - fixed height -->
    <div id="app-tickerbar" class="shrink-0 border-b border-white/10 bg-neutral-950">
      <div class="app-ticker-wrap app-chrome-pad">
        <div class="overflow-hidden whitespace-nowrap text-[11px] text-neutral-200/90">
          <div id="app-ticker" class="inline-block will-change-transform">
            <span id="app-ticker-text" class="opacity-90">Loading…</span>
            <span class="mx-8 opacity-50">•</span>
            <span id="app-ticker-text-2" class="opacity-90">Loading…</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 3) Left: Back / Right: document_meta - fixed height -->
    <div id="app-metabar" class="shrink-0 border-b border-white/10 bg-neutral-950">
      <div class="app-meta-wrap app-chrome-pad flex items-center justify-between gap-3">
        <div class="flex items-center gap-2 shrink-0">
          <a
            id="app-btn-back"
            href={back}
            class="shrink-0 rounded-full border border-white/15 bg-white/5 px-4 py-2 text-sm text-neutral-100 hover:bg-white/10"
          >
            ← 戻る
          </a>
        </div>

        <div class="min-w-0 text-right">
          <div id="app-doc-title" class="truncate text-sm font-medium text-neutral-100">(no title)</div>
          <div class="truncate text-xs text-neutral-400">
            <span id="app-doc-author">(no author)</span>
            <span class="mx-2 opacity-40">/</span>
            <span id="app-doc-path" class="opacity-80">{model}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 4) Viewer area (no scroll) -->
    <div id="app-stage" class="min-h-0 flex-1">
      <div class="flex h-full">
        <div class="min-w-0 flex-1 bg-black">
          <iframe
            id="app-viewer-iframe"
            src={iframeSrc}
            class="block h-full w-full"
            loading="lazy"
            referrerpolicy="no-referrer"
            allowfullscreen
          />
        </div>

        <!-- Desktop: right rail ad 300x600 -->
	        <aside id="app-adrail" class="hidden lg:block w-[300px] shrink-0 border-l border-white/10 bg-neutral-950">
          <div class="p-3">
            <div class="text-xs text-neutral-500">Sponsored</div>
            <div class="mt-2 h-[600px] rounded-xl border border-white/10 bg-white/5 grid place-items-center text-xs text-neutral-400">
              300×600 AD
            </div>
          </div>
        </aside>
      </div>
    </div>

    <!-- iOS/Android safe-area (bottom) -->
    <div class="app-safe-bottom lg:hidden" aria-hidden="true"></div>
  </div>

  <script type="module" is:inline>
  const DEFAULT_MODEL = '/3dss/sample/core_viewer_baseline.3dss.json';

  const sp = new URLSearchParams(location.search);

  function normalizeModelUrl(raw) {
    const v = (raw ?? '').trim();
    if (!v) return DEFAULT_MODEL;
    if (/^https?:\/\//i.test(v)) return v;
    if (v.startsWith('/')) return v;
    if (v.startsWith('3dss/')) return `/${v}`;
    return `/${v}`;
  }

  const id = (sp.get('id') || '').trim();
  const model = normalizeModelUrl(
    sp.get('model') ||
    sp.get('mode') || // legacy alias (typo)
    sp.get('src') ||
    (id ? `/3dss/library/${encodeURIComponent(id)}/model.3dss.json` : '')
  );
  const back = (sp.get('back') || '/library').trim() || '/library';

  // Keep /viewer pure; host owns the chrome.
  // Use explicit index.html for stability (dev/prod behavior can differ for /viewer/).
  const iframeSrc = `/viewer/index.html?model=${encodeURIComponent(model)}&embed=1`;

  const $iframe = document.getElementById('app-viewer-iframe');
  if ($iframe) $iframe.src = iframeSrc;

  const $backBtn = document.getElementById('app-btn-back');
  if ($backBtn) $backBtn.href = back;
  const $title = document.getElementById('app-doc-title');
  const $author = document.getElementById('app-doc-author');
  const $path = document.getElementById('app-doc-path');
  const $t1 = document.getElementById('app-ticker-text');
  const $t2 = document.getElementById('app-ticker-text-2');

  if ($path) $path.textContent = model;

  function pick(obj, paths, fallback = '') {
    for (const p of paths) {
      let cur = obj;
      let ok = true;
      for (const k of p) {
        if (!cur || typeof cur !== 'object' || !(k in cur)) { ok = false; break; }
        cur = cur[k];
      }
      if (ok && typeof cur === 'string' && cur.trim()) return cur;
    }
    return fallback;
  }

  async function loadMeta() {
    try {
      const res = await fetch(model, { cache: 'no-store' });
      if (!res.ok) throw new Error(String(res.status));
      const json = await res.json();

      const title = pick(json, [[ 'document_meta', 'document_title' ]], '(no title)');
      const author = pick(json, [[ 'document_meta', 'author' ]], '(no author)');
      const summary = pick(json, [[ 'document_meta', 'document_summary' ]], title);

      if ($title) $title.textContent = title;
      if ($author) $author.textContent = author;
      if ($t1) $t1.textContent = summary;
      if ($t2) $t2.textContent = summary;

      // simple marquee: translateX loop
      const ticker = document.getElementById('app-ticker');
      if (ticker) {
        const dur = Math.max(12, Math.min(30, (summary.length / 6)));
        ticker.style.animation = `appTickerMarquee ${dur}s linear infinite`;
      }
    } catch (e) {
      if ($title) $title.textContent = '(failed to load meta)';
    }
  }


  loadMeta();
</script>

  <style is:inline>
    @keyframes appTickerMarquee {
      0%   { transform: translateX(0%); }
      100% { transform: translateX(-50%); }
    }

    /* Make the ticker content wide enough for looping */
    #app-ticker { padding-right: 100%; }

	    /* Layout invariants */
	    #app-stage { min-height: 0; flex: 1 1 auto; }
	    #app-stage iframe { width: 100%; height: 100%; border: 0; display: block; }

	    /*
	      Force ad placements by viewport width (do not rely on Tailwind breakpoints).
	      - Mobile: top bar (320x100), no side rail
	      - Desktop: side rail (300x600), no top bar
	    */
	    @media (max-width: 1023px) {
	      #app-adbar { display: block !important; }
	      #app-adrail { display: none !important; }
	    }
	    @media (min-width: 1024px) {
	      #app-adbar { display: none !important; height: 0 !important; }
	      #app-adrail { display: block !important; }
	    }

    /* Mobile: fixed heights + safe-area */
    @media (max-width: 1023px) {
      .appviewer-root {
        overscroll-behavior: none;
        -webkit-overflow-scrolling: auto;
      }

      .app-safe-top {
        height: env(safe-area-inset-top);
        background: rgb(10 10 10);
      }

      .app-safe-bottom {
        height: env(safe-area-inset-bottom);
        background: rgb(0 0 0);
      }

      .app-chrome-pad {
        padding-left: calc(16px + env(safe-area-inset-left));
        padding-right: calc(16px + env(safe-area-inset-right));
      }

      /* Vertical stack heights */
      #app-adbar { height: 100px; }
      #app-tickerbar { height: 28px; }
      #app-metabar { height: 44px; }

      /* Ad: keep the 320x100 slot, overlay label (does not change height) */
      #app-adbar .app-ad-wrap {
        height: 100%;
        position: relative;
        display: flex;
        align-items: center;
      }
      #app-adbar .app-ad-label {
        position: absolute;
        top: 6px;
        left: calc(8px + env(safe-area-inset-left));
        font-size: 11px;
        line-height: 1;
        color: rgba(163, 163, 163, 0.9);
        pointer-events: none;
      }
      #app-adbar .app-ad-box {
        height: 100%;
      }

      /* Ticker/meta rows: no vertical padding (height is fixed), center contents */
      #app-tickerbar .app-ticker-wrap,
      #app-metabar .app-meta-wrap {
        height: 100%;
        padding-top: 0;
        padding-bottom: 0;
        align-items: center;
      }

      /* Stage: keep iframe inside safe left/right on notch devices */
      #app-stage {
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
      }
      #app-stage iframe {
        display: block;
      }
    }
  </style>
</LayoutApp>
