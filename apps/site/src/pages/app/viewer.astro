---
/**
 * Viewer Embed Contract (SSOT)
 * - /app/viewer はサイト共通レイアウトから隔離（flex/grid配下に置かない）
 * - iframe は viewport 固定（position:fixed; inset:0; width:100vw; height:100dvh）
 * - 親要素由来の min-width/overflow/transform 等で幅が膨らむ余地を作らない
 *
 * NOTE:
 *   Astro は static build のため、ビルド時に `Astro.url.search` は常に空。
 *   query (model/open/back 等) の受け渡しはブラウザ側で行う。
 */
---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>3DSL Viewer</title>
  </head>

  <body>
    <iframe
      id="app-viewer-iframe"
      class="app-viewer-iframe"
      src="about:blank"
      title="3DSL Viewer"
      allow="fullscreen"
      loading="eager"
      referrerpolicy="no-referrer"
    ></iframe>

    <button id="app-viewer-back" class="app-viewer-back" type="button" aria-label="戻る">← 戻る</button>

    <script is:inline>
      (() => {
        const iframe = document.getElementById("app-viewer-iframe");
        const backBtn = document.getElementById("app-viewer-back");
        if (!iframe) return;

        const sp = new URLSearchParams(window.location.search);

        // defaults
        if (!sp.has("embed")) sp.set("embed", "0");
        if (!sp.has("mode")) sp.set("mode", "prod");

        // compat: legacy `open=`
        if (!sp.has("model") && sp.has("open")) {
          const v = sp.get("open");
          if (v) sp.set("model", v);
        }

        const back = sp.get("back");

        iframe.src = `/viewer/index.html?${sp.toString()}`;

        if (backBtn) {
          backBtn.addEventListener("click", () => {
            if (back && typeof back === "string" && back.length) {
              window.location.assign(back);
            } else {
              history.back();
            }
          });
        }
      })();
    </script>
  </body>
</html>

<style is:global>
  html,
  body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #000;
  }

  .app-viewer-iframe {
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100dvh;
    border: 0;
    display: block;
    overflow: hidden;
    min-width: 0;
    min-height: 0;
    background: #000;
  }

  .app-viewer-back {
    position: fixed;
    top: calc(env(safe-area-inset-top) + 10px);
    left: calc(env(safe-area-inset-left) + 10px);
    z-index: 50;

    border: 1px solid rgba(255, 255, 255, 0.18);
    background: rgba(0, 0, 0, 0.55);
    color: #fff;
    border-radius: 999px;
    padding: 6px 10px;
    font: 13px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;

    -webkit-backdrop-filter: blur(8px);
    backdrop-filter: blur(8px);
    cursor: pointer;
  }

  @media (hover: hover) and (pointer: fine) {
    .app-viewer-back:hover {
      background: rgba(0, 0, 0, 0.7);
    }
  }
</style>
