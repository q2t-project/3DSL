---
/**
 * Viewer Embed Contract (SSOT)
 * - /app/viewer はサイト共通レイアウトから隔離（flex/grid配下に置かない）
 * - iframe は viewport 固定（position:fixed; inset:0; width:100vw; height:100dvh）
 * - 親要素由来の min-width/overflow/transform 等で幅が膨らむ余地を作らない
 *
 * Host categories (fixed):
 * - Full App Host: /viewer/index.html (UI付き)
 * - Minimal Host: /viewer/peek.html (UIなし/entryのみ; entry module = /viewer/peekBoot.js)
 * - Embed Host: /app/viewer (this file)
 * - Dev Host: /viewer/viewer_dev.html (dev限定)
 *
 * Minimal Host rules (summary):
 * - 入口は /viewer/peek.html（entry module は /viewer/peekBoot.js）に固定（例外追加は契約更新）
 * - import は viewer/runtime・viewer/renderer 等の基盤のみ（viewer/ui/** は禁止）
 * - DOM 必須は canvas ([data-role="viewer-canvas"] or #viewer-canvas) のみ
 *
 * SSOT: apps/site/DEVOPS_site.md (Viewer Embed Contract)
 *
 * NOTE:
 *   Astro は static build のため、ビルド時に `Astro.url.search` は常に空。
 *   query (model/open/back 等) の受け渡しはブラウザ側で行う。
 */
---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>3DSL Viewer</title>
  </head>

  <body>
    <iframe
      id="app-viewer-iframe"
      class="app-viewer-iframe"
      src="about:blank"
      title="3DSL Viewer"
      allow="fullscreen"
      loading="eager"
      referrerpolicy="no-referrer"
    ></iframe>

    <button id="app-viewer-back" class="app-viewer-back" type="button" aria-label="戻る">← 戻る</button>

    <script is:inline>
    (() => {
      const iframe = document.getElementById("app-viewer-iframe");
      const backBtn = document.getElementById("app-viewer-back");
      if (!iframe) return;

      const sp = new URLSearchParams(window.location.search);

      // defaults for inner viewer
      const inner = new URLSearchParams(sp);
      if (!inner.has("embed")) inner.set("embed", "0");
      if (!inner.has("mode")) inner.set("mode", "prod");

      // compat: legacy `open=`
      if (!inner.has("model") && inner.has("open")) {
        const v = inner.get("open");
        if (v) inner.set("model", v);
      }

      // host-only params (do not pass into iframe)
      const back = sp.get("back");
      const returnTo = sp.get("return");
      const scrollRaw = sp.get("scroll");

      inner.delete("back");
      inner.delete("return");
      inner.delete("scroll");

      iframe.src = `/viewer/index.html?${inner.toString()}`;

      function sameOriginPath(urlLike) {
        const u = new URL(urlLike, window.location.origin);
        if (u.origin !== window.location.origin) return "";
        return `${u.pathname}${u.search}${u.hash}`;
      }

      function normalizeScroll(s) {
        const y = Number(s);
        if (!Number.isFinite(y) || y < 0) return "";
        return String(Math.floor(y));
      }

      if (backBtn) {
        backBtn.addEventListener("click", () => {
          const y = normalizeScroll(scrollRaw);
          let target = "";

          if (returnTo && returnTo.length) {
            const p = sameOriginPath(returnTo);
            if (p) {
              const u = new URL(p, window.location.origin);
              if (y) u.searchParams.set("scroll", y);
              target = `${u.pathname}${u.search}${u.hash}`;
            }
          }

          if (!target && back && back.length) {
            // legacy back= : allow only same-origin
            target = sameOriginPath(back);
          }

          if (target) window.location.assign(target);
          else history.back();
        });
      }
    })();
    </script>
  </body>
</html>

<style is:global>
  html,
  body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #000;
  }

  .app-viewer-iframe {
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100dvh;
    border: 0;
    display: block;
    overflow: hidden;
    min-width: 0;
    min-height: 0;
    background: #000;
  }

  .app-viewer-back {
    position: fixed;
    top: calc(env(safe-area-inset-top) + 10px);
    left: calc(env(safe-area-inset-left) + 10px);
    z-index: 50;

    border: 1px solid rgba(255, 255, 255, 0.18);
    background: rgba(0, 0, 0, 0.55);
    color: #fff;
    border-radius: 999px;
    padding: 6px 10px;
    font: 13px/1.2 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;

    -webkit-backdrop-filter: blur(8px);
    backdrop-filter: blur(8px);
    cursor: pointer;
  }

  @media (hover: hover) and (pointer: fine) {
    .app-viewer-back:hover {
      background: rgba(0, 0, 0, 0.7);
    }
  }
</style>
