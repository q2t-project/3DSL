---
import LayoutApp from "../../layouts/LayoutApp.astro";

const DEFAULT_MODEL = "/3dss/sample/core_viewer_baseline.3dss.json";
const sp = Astro.url.searchParams;

function normalizeModelUrl(raw) {
  const v = (raw ?? "").trim();
  if (!v) return DEFAULT_MODEL;
  // Allow absolute URLs (useful for local/proxy testing). Otherwise force root-absolute.
  if (/^https?:\/\//i.test(v)) return v;
  if (v.startsWith("/")) return v;
  if (v.startsWith("3dss/")) return `/${v}`;
  return `/${v}`;
}

// Canonical param is `model`; keep `src` alias.
// Library pages use `id` (short) => /3dss/library/<id>/model.3dss.json
const id = (sp.get("id") ?? "").trim();
const model = normalizeModelUrl(
  // canonical
  sp.get("model") ??
    // legacy alias (typo in older links)
    sp.get("mode") ??
    // other legacy alias
    sp.get("src") ??
    (id ? `/3dss/library/${encodeURIComponent(id)}/model.3dss.json` : "")
);
const back = (sp.get("back") || "/library").trim() || "/library";

// /viewer stays pure; /app/viewer adds ads + simple top chrome.
// NOTE: layout復旧を優先するため、viewer側のHUD(UIボタン配置)も表示する。
// Use explicit index.html to avoid any server differences around "/viewer/" resolution.
const iframeSrc = `/viewer/index.html?model=${encodeURIComponent(model)}`;
---

<LayoutApp title="Viewer">
  <div id="appviewer-root" class="appviewer-root">
    <!-- iOS/Android safe-area (top) -->
    <div class="app-safe-top" aria-hidden="true"></div>

    <!-- 1) Mobile: Top ad (320x100) - fixed height -->
    <div id="app-adbar" class="app-adbar">
      <div class="app-ad-wrap app-chrome-pad">
        <div class="app-ad-label" aria-hidden="true">Sponsored</div>
        <div class="app-ad-box">Ad Slot (320×100)</div>
      </div>
    </div>

    <!-- 2) Ticker (single line, marquee) - fixed height -->
    <div id="app-tickerbar" class="app-tickerbar">
      <div class="app-ticker-wrap app-chrome-pad">
        <div class="app-ticker-viewport">
          <div id="app-ticker" class="app-ticker">
            <span id="app-ticker-text" class="app-ticker-text">Loading…</span>
            <span class="app-ticker-sep">•</span>
            <span id="app-ticker-text-2" class="app-ticker-text">Loading…</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 3) Left: Back / Right: document_meta - fixed height -->
    <div id="app-metabar" class="app-metabar">
      <div class="app-meta-wrap app-chrome-pad">
        <a id="app-btn-back" href={back} class="app-btn-back">← 戻る</a>
        <div class="app-docmeta">
      <div id="app-doc-title" class="app-doc-title">(no title)</div>
      <div class="app-doc-sub">
        <span id="app-doc-file" class="app-doc-path" title="">(no file)</span>
      </div>
    </div>
      </div>
    </div>

    <!-- 4) Viewer area (no scroll) -->
    <div id="app-stage" class="app-stage">
      <div class="app-stage-inner">
        <div class="app-viewer-wrap">
          <iframe
            id="app-viewer-iframe"
            src={iframeSrc}
            class="app-viewer-iframe"
            referrerpolicy="no-referrer"
            allowfullscreen
          ></iframe>
        </div>

        <!-- Desktop: right rail ad 300x600 -->
        <aside id="app-adrail" class="app-adrail">
          <div class="app-rail-pad">
            <div class="app-rail-label">Sponsored</div>
            <div class="app-rail-box">300×600 AD</div>
          </div>
        </aside>
      </div>
    </div>

    <!-- iOS/Android safe-area (bottom) -->
    <div class="app-safe-bottom" aria-hidden="true"></div>
  </div>

  <script type="module" is:inline>
    const MODEL = {JSON.stringify(model)};
    const BACK = {JSON.stringify(back)};
    const IFRAME_SRC = {JSON.stringify(iframeSrc)};

    const $iframe = document.getElementById('app-viewer-iframe');
    if ($iframe && $iframe.getAttribute('src') !== IFRAME_SRC) $iframe.setAttribute('src', IFRAME_SRC);

    const $backBtn = document.getElementById('app-btn-back');
    if ($backBtn && $backBtn.getAttribute('href') !== BACK) $backBtn.setAttribute('href', BACK);

    const $title = document.getElementById('app-doc-title');
    const $file = document.getElementById('app-doc-file');
    const $t1 = document.getElementById('app-ticker-text');
    const $t2 = document.getElementById('app-ticker-text-2');

    const modelUrl = String(MODEL ?? '');
    const fileName = modelUrl.split('?')[0].split('/').filter(Boolean).pop() || modelUrl;
    if ($file) { $file.textContent = fileName; $file.title = modelUrl; }

    function pick(obj, paths, fallback = '') {
      for (const p of paths) {
        let cur = obj;
        let ok = true;
        for (const k of p) {
          if (!cur || typeof cur !== 'object' || !(k in cur)) { ok = false; break; }
          cur = cur[k];
        }
        if (ok && typeof cur === 'string' && cur.trim()) return cur;
      }
      return fallback;
    }

    async function loadMeta() {
      try {
        const res = await fetch(MODEL, { cache: 'no-store' });
        if (!res.ok) throw new Error(String(res.status));
        const json = await res.json();

        const title = pick(json, [[ 'document_meta', 'document_title' ]], '(no title)');
        const summary = pick(json, [[ 'document_meta', 'document_summary' ]], title);

        if ($title) $title.textContent = title;
        if ($t1) $t1.textContent = summary;
        if ($t2) $t2.textContent = summary;

        const ticker = document.getElementById('app-ticker');
        if (ticker) {
          const dur = Math.max(12, Math.min(30, (summary.length / 6)));
          ticker.style.animation = `appTickerMarquee ${dur}s linear infinite`;
        }
      } catch (e) {
        if ($title) $title.textContent = '(failed to load meta)';
        if ($file) $file.textContent = fileName;
      }
    }

    loadMeta();
  </script>

  <style is:inline>
    :root {
      color-scheme: dark;
    }

    /* Marquee */
    @keyframes appTickerMarquee {
      0%   { transform: translateX(0%); }
      100% { transform: translateX(-50%); }
    }

    /* Root: deterministic vertical stack (safe-area + fixed heights) */
    #appviewer-root {
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
      --adbar-h: 100px;
      --ticker-h: 28px;
      --meta-h: 44px;
      --rail-w: 0px;

      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-rows: var(--safe-top) var(--adbar-h) var(--ticker-h) var(--meta-h) 1fr var(--safe-bottom);
      background: #000;
      overflow: hidden;
      overscroll-behavior: none;
    }

    .app-safe-top { grid-row: 1; height: var(--safe-top); background: rgb(10 10 10); }
    .app-safe-bottom { grid-row: 6; height: var(--safe-bottom); background: rgb(0 0 0); }

    #app-adbar { grid-row: 2; height: var(--adbar-h); }
    #app-tickerbar { grid-row: 3; height: var(--ticker-h); }
    #app-metabar { grid-row: 4; height: var(--meta-h); }
    #app-stage { grid-row: 5; min-height: 0; }

    /* Desktop switches */
    @media (min-width: 1024px) {
      #appviewer-root {
        --safe-top: 0px;
        --safe-bottom: 0px;
        --adbar-h: 0px;
        --rail-w: 300px;
      }
      .app-safe-top, .app-safe-bottom { display: none; }
      #app-adbar { display: none; }
    }

    /* Chrome padding with safe-area (mobile) */
    .app-chrome-pad {
      padding-left: calc(16px + env(safe-area-inset-left));
      padding-right: calc(16px + env(safe-area-inset-right));
    }

    /* Bars */
    .app-adbar,
    .app-tickerbar,
    .app-metabar {
      background: #0a0a0a;
      border-bottom: 1px solid rgba(255, 255, 255, 0.10);
    }

    /* Ad (mobile) */
    .app-ad-wrap {
      height: 100%;
      position: relative;
      display: flex;
      align-items: center;
    }
    .app-ad-label {
      position: absolute;
      top: 6px;
      left: calc(8px + env(safe-area-inset-left));
      font-size: 11px;
      line-height: 1;
      color: rgba(163, 163, 163, 0.9);
      pointer-events: none;
    }
    .app-ad-box {
      width: 100%;
      height: 100%;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.10);
      background: rgba(255, 255, 255, 0.04);
      display: grid;
      place-items: center;
      font-size: 12px;
      color: rgba(163, 163, 163, 0.9);
    }

    /* Ticker */
    .app-ticker-wrap {
      height: 100%;
      display: flex;
      align-items: center;
    }
    .app-ticker-viewport {
      width: 100%;
      overflow: hidden;
      white-space: nowrap;
      font-size: 11px;
      color: rgba(229, 229, 229, 0.92);
    }
    #app-ticker {
      display: inline-flex;
      align-items: center;
      gap: 32px;
      padding-right: 100%;
      will-change: transform;
    }
    .app-ticker-sep { opacity: 0.55; }

    /* Meta */
    .app-meta-wrap {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .app-btn-back {
      flex: 0 0 auto;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(255, 255, 255, 0.05);
      color: rgba(245, 245, 245, 0.98);
      text-decoration: none;
      font-size: 14px;
      line-height: 1;
    }
    .app-btn-back:hover { background: rgba(255, 255, 255, 0.10); }

    .app-docmeta {
      min-width: 0;
      flex: 1 1 auto;
      text-align: right;
    }
    .app-doc-title {
      font-size: 14px;
      font-weight: 600;
      color: rgba(245, 245, 245, 0.98);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .app-doc-sub {
      margin-top: 2px;
      font-size: 12px;
      color: rgba(163, 163, 163, 0.95);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .app-doc-sep { margin: 0 8px; opacity: 0.45; }
    .app-doc-path { opacity: 0.85; }

    /* Stage: keep iframe deterministic */
    #app-stage {
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    .app-stage-inner {
      height: 100%;
      min-width: 0;
      display: grid;
      grid-template-columns: 1fr var(--rail-w);
    }
    .app-viewer-wrap {
      min-width: 0;
      background: #000;
    }
    .app-viewer-iframe {
      width: 100%;
      height: 100%;
      border: 0;
      display: block;
    }

    /* Right rail (desktop) */
    .app-adrail {
      width: var(--rail-w);
      border-left: 1px solid rgba(255, 255, 255, 0.10);
      background: #0a0a0a;
      overflow: hidden;
      display: none;
    }
    @media (min-width: 1024px) {
      .app-adrail { display: block; }
    }
    .app-rail-pad { padding: 12px; }
    .app-rail-label { font-size: 12px; color: rgba(163, 163, 163, 0.9); }
    .app-rail-box {
      margin-top: 8px;
      height: 600px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.10);
      background: rgba(255, 255, 255, 0.04);
      display: grid;
      place-items: center;
      font-size: 12px;
      color: rgba(163, 163, 163, 0.9);
    }

    /* If something outside forces scroll, still keep app isolated */
    body.app-shell { overscroll-behavior: none; }
  </style>
</LayoutApp>
