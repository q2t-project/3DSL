---
import Layout from "../../layouts/Layout.astro";
import AdSlot from "../../components/AdSlot.astro";
import { ADSENSE_SLOTS } from "../../lib/adsense";
import { getLibraryItemBySlug, getLibraryItems } from "../../lib/libraryIndex";
import { getEntry, render } from "astro:content";
import fs from "node:fs";
import path from "node:path";

type AnyObj = Record<string, any>;
type Attachment = { name: string; url: string };

export function getStaticPaths() {
  const items = getLibraryItems();
  return items.map((it) => ({ params: { slug: it.slug } }));
}

const slug = String(Astro.params.slug ?? "");
const item = getLibraryItemBySlug(slug);
if (!item) {
  throw new Error(`[library/[slug]] item not found: ${slug}`);
}

const dataDir = item.data_dir ?? `/_data/library/${slug}`;
const modelUrl = item.model_url ?? `${dataDir}/model.3dss.json`;
// Library -> Viewer entry: mark origin for host-side behaviors (e.g. small ads)
const viewerUrl =
  item.viewer_url ??
  `/viewer/index.html?model=${encodeURIComponent(modelUrl)}&from=library`;
const peekUrl = `/viewer/peek.html?model=${encodeURIComponent(modelUrl)}&from=library`;

function filePathFromPublic(urlPath: string): string {
  const p = String(urlPath || "").replace(/^\/+/, "");
  return path.join(process.cwd(), "public", p);
}

const metaPath = filePathFromPublic(`${dataDir}/_meta.json`);
const meta: AnyObj | null = fs.existsSync(metaPath)
  ? JSON.parse(fs.readFileSync(metaPath, "utf8"))
  : null;

const seoTitle = meta?.seo?.title ?? item.meta_title ?? item.title;
const seoDescription =
  meta?.seo?.description ?? item.meta_description ?? item.summary ?? "";

// Per-item page config (optional)
const pageConf = meta?.page ?? {};
const adAllow = new Set<string>(
  Array.isArray(pageConf?.ads) ? pageConf.ads : ["mobile_top", "desktop_rail"]
);
const showAdMobileTop = adAllow.has("mobile_top");
const showAdDesktopRail = adAllow.has("desktop_rail");
const showAdInline1 = adAllow.has("inline_1");

function listFilesPublicDir(urlDir: string): Attachment[] {
  const abs = filePathFromPublic(urlDir);
  if (!fs.existsSync(abs)) return [];

  let ents: fs.Dirent[] = [];
  try {
    ents = fs.readdirSync(abs, { withFileTypes: true });
  } catch {
    return [];
  }

  return ents
    .filter((d) => d.isFile())
    .map((d) => ({
      name: d.name,
      url: `${urlDir.replace(/\/+$/, "")}/${encodeURIComponent(d.name)}`,
    }))
    .sort((a, b) => a.name.localeCompare(b.name));
}

const attachments = listFilesPublicDir(`${dataDir}/attachments`);

// Markdown body (optional)
let RenderedContent: any = null;
try {
  const entry = await getEntry("library_items", slug);
  if (entry) {
    const rendered = await render(entry);
    RenderedContent = rendered.Content;
  }
} catch {
  RenderedContent = null;
}

const tags = Array.isArray(meta?.tags) ? meta!.tags : item.tags ?? [];
const descriptionLong = meta?.description ?? "";
const createdAt = item.created_at ?? meta?.created_at ?? "";
const updatedAt = item.updated_at ?? meta?.updated_at ?? "";

function hasNonEmptyString(x: unknown): x is string {
  return typeof x === "string" && x.trim().length > 0;
}

const authors: AnyObj[] = Array.isArray(meta?.authors) ? meta!.authors : [];
const references: AnyObj[] = Array.isArray(meta?.references) ? meta!.references : [];
const rights: AnyObj | null = meta?.rights ?? null;

const referencesMeaningful = references.filter(
  (r) =>
    hasNonEmptyString(r?.title) ||
    hasNonEmptyString(r?.url) ||
    hasNonEmptyString(r?.authors)
);

const thirdParty = Array.isArray(rights?.third_party)
  ? rights.third_party.filter(
      (t: AnyObj) =>
        hasNonEmptyString(t?.name) ||
        hasNonEmptyString(t?.url) ||
        hasNonEmptyString(t?.license)
    )
  : [];
---

<Layout title={seoTitle} description={seoDescription}>
  <div class="mx-auto max-w-[1200px] px-4 py-6">
    <div class="text-xs text-neutral-500">
      <a href="/library" class="hover:underline">Library</a>
      <span class="mx-2">/</span>
      <span class="text-neutral-400">{item.title}</span>
    </div>

    <div class="mt-3">
      <h1 class="text-2xl font-semibold tracking-tight text-neutral-100">{item.title}</h1>
      {item.summary ? (
        <p class="mt-2 max-w-[75ch] text-sm leading-relaxed text-neutral-300">{item.summary}</p>
      ) : null}
    </div>

    {showAdMobileTop ? (
      <div class="mt-4 lg:hidden">
        <AdSlot slot={ADSENSE_SLOTS.slot_300x250} class="w-full" />
      </div>
    ) : null}

    <div class="mt-6 grid grid-cols-1 gap-6 lg:grid-cols-[minmax(0,1fr)_300px]">
      <main class="min-w-0">
        <section class="rounded-2xl border border-neutral-800 bg-neutral-950/40 p-4">
          <div class="grid grid-cols-1 gap-4 lg:grid-cols-2">
            <div class="min-w-0">
              <a
                href={viewerUrl}
                class="group relative block w-full overflow-hidden rounded-xl border border-neutral-800 bg-black h-[min(46vw,220px)] sm:h-[min(56.25vw,280px)]"
                aria-label="全画面表示（Viewer）"
              >
                <iframe
                  class="absolute inset-0 block h-full w-full pointer-events-none"
                  src={`${peekUrl}&embed=1&noads=1&swipe=1&t=${Date.now()}`}
                  title={`Preview: ${item.title}`}
                  loading="lazy"
                  allow="fullscreen"
                />
                <div class="pointer-events-none absolute inset-0 ring-1 ring-inset ring-white/0 transition group-hover:ring-white/15" aria-hidden="true"></div>
              </a>
              <div class="mt-2 sm:mt-3 flex flex-wrap items-center gap-2">
                <a
                  href={viewerUrl}
                  class="inline-flex items-center gap-2 rounded-full border border-neutral-700 bg-neutral-900 px-4 py-2 text-sm text-neutral-100 hover:bg-neutral-800"
                >
                  全画面表示
                </a>
                <a
                  href={modelUrl}
                  class="inline-flex items-center gap-2 rounded-full border border-neutral-800 bg-transparent px-4 py-2 text-sm text-neutral-300 hover:bg-neutral-900"
                >
                  JSONコード
                </a>

                <div class="flex items-center gap-2 sm:ml-auto">
                  <button
                    type="button"
                    data-lib-action="share"
                    class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-neutral-800 bg-neutral-950/30 text-neutral-200 hover:bg-neutral-900"
                    title="このページを共有"
                    aria-label="このページを共有"
                  >
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M18 5a3 3 0 1 0-2.82-4H15a3 3 0 0 0 3 3Z"></path>
                      <path d="M6 14a3 3 0 1 0 2.82 4H9a3 3 0 0 0-3-3Z"></path>
                      <path d="M18 19a3 3 0 1 0-2.82 4H15a3 3 0 0 0 3-3Z"></path>
                      <path d="M8.7 15.7 15.3 19.3"></path>
                      <path d="M15.3 4.7 8.7 8.3"></path>
                    </svg>
                  </button>

                  <button
                    type="button"
                    data-lib-action="copy"
                    class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-neutral-800 bg-neutral-950/30 text-neutral-200 hover:bg-neutral-900"
                    title="リンクをコピー"
                    aria-label="リンクをコピー"
                  >
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M8 8a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H10a2 2 0 0 1-2-2V8Z"></path>
                      <path d="M16 6V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h2"></path>
                    </svg>
                  </button>

                  <button
                    type="button"
                    data-lib-action="qr"
                    class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-neutral-800 bg-neutral-950/30 text-neutral-200 hover:bg-neutral-900"
                    title="QRを表示"
                    aria-label="QRを表示"
                  >
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M6 3h4v4H6z"></path>
                      <path d="M14 3h4v4h-4z"></path>
                      <path d="M6 11h4v4H6z"></path>
                      <path d="M14 11h2"></path>
                      <path d="M14 14h4"></path>
                      <path d="M18 11v4"></path>
                      <path d="M21 14v7"></path>
                      <path d="M14 18h2"></path>
                      <path d="M14 21h7"></path>
                      <path d="M3 3h7"></path>
                      <path d="M3 11h7"></path>
                      <path d="M3 19h7"></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            <div class="min-w-0">
              {hasNonEmptyString(descriptionLong) ? (
                <p class="text-sm leading-relaxed text-neutral-300">{descriptionLong}</p>
              ) : null}

              {Array.isArray(tags) && tags.length ? (
                <div class="mt-3 flex flex-wrap gap-2">
                  {tags.map((t) => (
                    <span class="rounded-full border border-neutral-800 bg-neutral-900 px-2 py-0.5 text-xs text-neutral-300">{t}</span>
                  ))}
                </div>
              ) : null}

              <div class="mt-4 grid grid-cols-1 gap-2 text-xs text-neutral-400">
                {hasNonEmptyString(createdAt) ? (
                  <div><span class="text-neutral-500">created:</span> {createdAt}</div>
                ) : null}
                {hasNonEmptyString(updatedAt) ? (
                  <div><span class="text-neutral-500">updated:</span> {updatedAt}</div>
                ) : null}
              </div>

              {Array.isArray(authors) && authors.length ? (
                <div class="mt-4">
                  <div class="text-xs font-semibold text-neutral-400">authors</div>
                  <ul class="mt-2 space-y-1 text-xs text-neutral-300">
                    {authors.map((a) => (
                      <li>
                        {a?.url ? (
                          <a class="hover:underline" href={a.url} target="_blank" rel="noreferrer">{a?.name ?? a.url}</a>
                        ) : (
                          <span>{a?.name ?? ""}</span>
                        )}
                        {a?.role ? <span class="ml-2 text-neutral-500">({a.role})</span> : null}
                      </li>
                    ))}
                  </ul>
                </div>
              ) : null}
            </div>
          </div>
        </section>

        {RenderedContent ? (
          <section class="mt-8 rounded-2xl border border-neutral-800 bg-neutral-950/40 p-5">
            <h2 class="text-base font-semibold text-neutral-100">本文</h2>
            <div class="prose prose-invert mt-4 max-w-none">
              <RenderedContent />
            </div>
          </section>
        ) : null}

        {showAdInline1 ? (
          <div class="mt-8">
            <AdSlot slot={ADSENSE_SLOTS.slot_300x250} class="w-full" />
          </div>
        ) : null}

        {attachments.length ? (
          <section class="mt-8 rounded-2xl border border-neutral-800 bg-neutral-950/40 p-5">
            <h2 class="text-base font-semibold text-neutral-100">添付ファイル</h2>
            <ul class="mt-3 list-disc space-y-1 pl-5 text-sm text-neutral-300">
              {attachments.map((f) => (
                <li><a class="hover:underline" href={f.url} target="_blank" rel="noreferrer">{f.name}</a></li>
              ))}
            </ul>
          </section>
        ) : null}

        {referencesMeaningful.length ? (
          <section class="mt-8 rounded-2xl border border-neutral-800 bg-neutral-950/40 p-5">
            <h2 class="text-base font-semibold text-neutral-100">参考</h2>
            <div class="mt-3 space-y-3 text-sm text-neutral-300">
              {referencesMeaningful.map((r) => (
                <div class="rounded-xl border border-neutral-800 bg-neutral-950/40 p-3">
                  {hasNonEmptyString(r?.title) ? <div class="font-medium text-neutral-100">{r.title}</div> : null}
                  <div class="mt-1 text-xs text-neutral-400">
                    {hasNonEmptyString(r?.authors) ? <span>{r.authors}</span> : null}
                    {hasNonEmptyString(r?.year) ? <span class="ml-2">({r.year})</span> : null}
                    {hasNonEmptyString(r?.publisher_or_venue) ? <span class="ml-2">{r.publisher_or_venue}</span> : null}
                  </div>
                  {hasNonEmptyString(r?.url) ? (
                    <div class="mt-2">
                      <a class="text-xs text-neutral-300 hover:underline" href={r.url} target="_blank" rel="noreferrer">{r.url}</a>
                    </div>
                  ) : null}
                  {hasNonEmptyString(r?.scope_note) ? (
                    <div class="mt-2 text-xs text-neutral-400">{r.scope_note}</div>
                  ) : null}
                </div>
              ))}
            </div>
          </section>
        ) : null}

        {(hasNonEmptyString(rights?.license) || hasNonEmptyString(rights?.copyright) || thirdParty.length) ? (
          <section class="mt-8 rounded-2xl border border-neutral-800 bg-neutral-950/40 p-5">
            <h2 class="text-base font-semibold text-neutral-100">権利</h2>
            <div class="mt-3 space-y-2 text-sm text-neutral-300">
              {hasNonEmptyString(rights?.license) ? (
                <div><span class="text-neutral-500">license:</span> {rights.license}</div>
              ) : null}
              {hasNonEmptyString(rights?.copyright) ? (
                <div><span class="text-neutral-500">copyright:</span> {rights.copyright}</div>
              ) : null}
              {thirdParty.length ? (
                <div class="mt-4">
                  <div class="text-xs font-semibold text-neutral-400">third-party</div>
                  <ul class="mt-2 list-disc space-y-1 pl-5 text-xs text-neutral-300">
                    {thirdParty.map((t: AnyObj) => (
                      <li>
                        <span>{t.name}</span>
                        {hasNonEmptyString(t?.license) ? <span class="ml-2 text-neutral-400">{t.license}</span> : null}
                        {hasNonEmptyString(t?.url) ? (
                          <a class="ml-2 hover:underline" href={t.url} target="_blank" rel="noreferrer">source</a>
                        ) : null}
                      </li>
                    ))}
                  </ul>
                </div>
              ) : null}
            </div>
          </section>
        ) : null}
      </main>

      <aside class="hidden lg:block">
        <div class="sticky top-6 space-y-6">
          {showAdDesktopRail ? (
            <div class="rounded-2xl border border-neutral-800 bg-neutral-950/40 p-3">
              <AdSlot slot={ADSENSE_SLOTS.slot_300x600} class="w-full" />
            </div>
          ) : null}

          <div class="rounded-2xl border border-neutral-800 bg-neutral-950/40 p-4">
            <div class="text-xs font-semibold text-neutral-400">Quick</div>
            <div class="mt-3 flex flex-col gap-2">
              <a
                href={viewerUrl}
                class="inline-flex items-center justify-center rounded-full border border-neutral-700 bg-neutral-900 px-4 py-2 text-sm text-neutral-100 hover:bg-neutral-800"
              >
                全画面表示
              </a>
              <a
                href={modelUrl}
                class="inline-flex items-center justify-center rounded-full border border-neutral-800 bg-transparent px-4 py-2 text-sm text-neutral-300 hover:bg-neutral-900"
              >
                JSONコード
              </a>
            </div>

            <div class="mt-3 flex items-center justify-center gap-2">
              <button
                type="button"
                data-lib-action="share"
                class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-neutral-800 bg-neutral-950/30 text-neutral-200 hover:bg-neutral-900"
                title="このページを共有"
                aria-label="このページを共有"
              >
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M18 5a3 3 0 1 0-2.82-4H15a3 3 0 0 0 3 3Z"></path>
                  <path d="M6 14a3 3 0 1 0 2.82 4H9a3 3 0 0 0-3-3Z"></path>
                  <path d="M18 19a3 3 0 1 0-2.82 4H15a3 3 0 0 0 3-3Z"></path>
                  <path d="M8.7 15.7 15.3 19.3"></path>
                  <path d="M15.3 4.7 8.7 8.3"></path>
                </svg>
              </button>

              <button
                type="button"
                data-lib-action="copy"
                class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-neutral-800 bg-neutral-950/30 text-neutral-200 hover:bg-neutral-900"
                title="リンクをコピー"
                aria-label="リンクをコピー"
              >
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M8 8a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H10a2 2 0 0 1-2-2V8Z"></path>
                  <path d="M16 6V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h2"></path>
                </svg>
              </button>

              <button
                type="button"
                data-lib-action="qr"
                class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-neutral-800 bg-neutral-950/30 text-neutral-200 hover:bg-neutral-900"
                title="QRを表示"
                aria-label="QRを表示"
              >
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M6 3h4v4H6z"></path>
                  <path d="M14 3h4v4h-4z"></path>
                  <path d="M6 11h4v4H6z"></path>
                  <path d="M14 11h2"></path>
                  <path d="M14 14h4"></path>
                  <path d="M18 11v4"></path>
                  <path d="M21 14v7"></path>
                  <path d="M14 18h2"></path>
                  <path d="M14 21h7"></path>
                  <path d="M3 3h7"></path>
                  <path d="M3 11h7"></path>
                  <path d="M3 19h7"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <div
    id="lib-toast"
    class="pointer-events-none fixed inset-x-0 bottom-4 z-50 flex justify-center px-4"
    hidden
  >
    <div
      id="lib-toast-msg"
      class="pointer-events-auto rounded-full border border-neutral-800 bg-neutral-950/90 px-4 py-2 text-sm text-neutral-100 shadow"
    >
      コピーしました
    </div>
  </div>

  <div
    id="lib-qr-modal"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4"
    hidden
  >
    <div class="w-full max-w-sm rounded-2xl border border-neutral-800 bg-neutral-950 p-4 shadow">
      <div class="flex items-center justify-between">
        <div class="text-sm font-medium text-neutral-100">QR</div>
        <button
          type="button"
          id="lib-qr-close"
          class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-neutral-800 bg-neutral-950/30 text-neutral-200 hover:bg-neutral-900"
          aria-label="閉じる"
          title="閉じる"
        >
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M18 6 6 18"></path>
            <path d="M6 6 18 18"></path>
          </svg>
        </button>
      </div>

      <div class="mt-4 flex justify-center">
        <img
          id="lib-qr-img"
          alt="QR"
          class="h-[240px] w-[240px] rounded-xl border border-neutral-800 bg-neutral-900"
          loading="lazy"
        />
      </div>

      <div class="mt-3 break-all text-xs text-neutral-400" id="lib-qr-url"></div>

      <div class="mt-4 flex items-center justify-end gap-2">
        <button
          type="button"
          id="lib-qr-copy"
          class="inline-flex items-center justify-center rounded-full border border-neutral-700 bg-neutral-900 px-4 py-2 text-sm text-neutral-100 hover:bg-neutral-800"
        >
          リンクをコピー
        </button>
      </div>
    </div>
  </div>

  <script is:inline>
    (() => {
      const toastEl = document.getElementById("lib-toast");
      const toastMsgEl = document.getElementById("lib-toast-msg");

      const qrModalEl = document.getElementById("lib-qr-modal");
      const qrImgEl = document.getElementById("lib-qr-img");
      const qrUrlEl = document.getElementById("lib-qr-url");
      const qrCloseBtn = document.getElementById("lib-qr-close");
      const qrCopyBtn = document.getElementById("lib-qr-copy");

      const canonicalUrl = (() => {
        const u = new URL(window.location.href);
        u.hash = "";
        u.search = "";
        return u.toString();
      })();

      const qrPngUrl = (data) =>
        `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(data)}`;

      let toastTimer = null;
      const toast = (msg) => {
        if (!toastEl || !toastMsgEl) return;
        toastMsgEl.textContent = msg;
        toastEl.hidden = false;
        if (toastTimer) window.clearTimeout(toastTimer);
        toastTimer = window.setTimeout(() => {
          toastEl.hidden = true;
          toastTimer = null;
        }, 1400);
      };

      const copyToClipboard = async (text) => {
        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(text);
            return true;
          }
        } catch (e) {}
        // fallback
        try {
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.setAttribute("readonly", "");
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          return true;
        } catch (e) {}
        return false;
      };

      const openQr = () => {
        if (!qrModalEl || !qrImgEl || !qrUrlEl) return;
        qrImgEl.src = qrPngUrl(canonicalUrl);
        qrUrlEl.textContent = canonicalUrl;
        qrModalEl.hidden = false;
      };

      const closeQr = () => {
        if (!qrModalEl) return;
        qrModalEl.hidden = true;
      };

      document.querySelectorAll('[data-lib-action="share"]').forEach((btn) => {
        btn.addEventListener("click", async () => {
          try {
            if (navigator.share) {
              await navigator.share({ title: document.title, url: canonicalUrl });
              return;
            }
          } catch (e) {}
          const ok = await copyToClipboard(canonicalUrl);
          toast(ok ? "リンクをコピーしました" : "コピーに失敗しました");
        });
      });

      document.querySelectorAll('[data-lib-action="copy"]').forEach((btn) => {
        btn.addEventListener("click", async () => {
          const ok = await copyToClipboard(canonicalUrl);
          toast(ok ? "リンクをコピーしました" : "コピーに失敗しました");
        });
      });

      document.querySelectorAll('[data-lib-action="qr"]').forEach((btn) => {
        btn.addEventListener("click", () => openQr());
      });

      if (qrCopyBtn) {
        qrCopyBtn.addEventListener("click", async () => {
          const ok = await copyToClipboard(canonicalUrl);
          toast(ok ? "リンクをコピーしました" : "コピーに失敗しました");
        });
      }
      if (qrCloseBtn) qrCloseBtn.addEventListener("click", () => closeQr());
      if (qrModalEl) {
        qrModalEl.addEventListener("click", (e) => {
          if (e.target === qrModalEl) closeQr();
        });
      }
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeQr();
      });
    })();
  </script>

</Layout>
