---
import Layout from "../../layouts/Layout.astro";
import AdSlot from "../../components/AdSlot.astro";
import { ADSENSE_SLOTS } from "../../lib/adsense";
import { getLibraryItemBySlug, getLibraryItems } from "../../lib/libraryIndex";
import { getEntry, render } from "astro:content";
import fs from "node:fs";
import path from "node:path";

export function getStaticPaths() {
  const items = getLibraryItems();
  return items.map((it) => ({ params: { slug: it.slug } }));
}

const slug = String(Astro.params.slug ?? "");
const item = getLibraryItemBySlug(slug);
if (!item) {
  throw new Error(`[library/[slug]] item not found: ${slug}`);
}

const dataDir = item.data_dir ?? `/_data/library/${slug}`;
const modelUrl = item.model_url ?? `${dataDir}/model.3dss.json`;
const viewerUrl = item.viewer_url ?? `/viewer/index.html?model=${encodeURIComponent(modelUrl)}`;
const peekUrl = `/viewer/peek.html?model=${encodeURIComponent(modelUrl)}`;

function filePathFromPublic(urlPath) {
  const p = String(urlPath || "").replace(/^\/+/, "");
  return path.join(process.cwd(), "public", p);
}

const metaPath = filePathFromPublic(`${dataDir}/_meta.json`);
const meta = fs.existsSync(metaPath)
  ? JSON.parse(fs.readFileSync(metaPath, "utf8"))
  : null;

const seoTitle = meta?.seo?.title ?? item.meta_title ?? item.title;
const seoDescription = meta?.seo?.description ?? item.meta_description ?? item.summary ?? "";

// Per-item page config (optional)
const pageConf = meta?.page ?? {};
const adAllow = new Set(
  Array.isArray(pageConf?.ads)
    ? pageConf.ads
    : ["mobile_top", "desktop_rail"]
);
const showAdMobileTop = adAllow.has("mobile_top");
const showAdDesktopRail = adAllow.has("desktop_rail");
const showAdInline1 = adAllow.has("inline_1");

function listFilesPublicDir(urlDir) {
  const abs = filePathFromPublic(urlDir);
  if (!fs.existsSync(abs)) return [];
  let ents = [];
  try {
    ents = fs.readdirSync(abs, { withFileTypes: true });
  } catch {
    return [];
  }
  return ents
    .filter((d) => d.isFile())
    .map((d) => ({
      name: d.name,
      url: `${urlDir.replace(/\/+$/, "")}/${encodeURIComponent(d.name)}`,
    }))
    .sort((a, b) => a.name.localeCompare(b.name));
}

const attachments = listFilesPublicDir(`${dataDir}/attachments`);

// Markdown body (optional)
let RenderedContent = null;
try {
  const entry = await getEntry("library_items", slug);
  if (entry) {
    const rendered = await render(entry);
    RenderedContent = rendered.Content;
  }
} catch {
  RenderedContent = null;
}

const tags = Array.isArray(meta?.tags) ? meta.tags : (item.tags ?? []);
const descriptionLong = meta?.description ?? "";
const createdAt = item.created_at ?? meta?.created_at ?? "";
const updatedAt = item.updated_at ?? meta?.updated_at ?? "";

function hasNonEmptyString(x) {
  return typeof x === "string" && x.trim().length > 0;
}

const authors = Array.isArray(meta?.authors) ? meta.authors : [];
const references = Array.isArray(meta?.references) ? meta.references : [];
const rights = meta?.rights ?? null;

const referencesMeaningful = references.filter((r) =>
  hasNonEmptyString(r?.title) || hasNonEmptyString(r?.url) || hasNonEmptyString(r?.authors)
);

const thirdParty = Array.isArray(rights?.third_party)
  ? rights.third_party.filter((t) =>
      hasNonEmptyString(t?.name) || hasNonEmptyString(t?.url) || hasNonEmptyString(t?.license)
    )
  : [];
---

<Layout title={seoTitle} description={seoDescription}>
  <div class="mx-auto max-w-[1200px] px-4 py-6">
    <div class="text-xs text-neutral-500">
      <a href="/library" class="hover:underline">Library</a>
      <span class="mx-2">/</span>
      <span class="text-neutral-400">{item.title}</span>
    </div>

    <div class="mt-3">
      <h1 class="text-2xl font-semibold tracking-tight text-neutral-100">{item.title}</h1>
      {item.summary ? (
        <p class="mt-2 max-w-[75ch] text-sm leading-relaxed text-neutral-300">{item.summary}</p>
      ) : null}
    </div>

    {showAdMobileTop ? (
      <div class="mt-4 lg:hidden">
        <AdSlot slot={ADSENSE_SLOTS.slot_300x250} layout="in-article" className="w-full" />
      </div>
    ) : null}

    <div class="mt-6 grid grid-cols-1 gap-6 lg:grid-cols-[minmax(0,1fr)_300px]">
      <main class="min-w-0">
        <section class="rounded-2xl border border-neutral-800 bg-neutral-950/40 p-4">
          <div class="grid grid-cols-1 gap-4 lg:grid-cols-2">
	            <div class="min-w-0">
	              <div
	                class="relative w-full overflow-hidden rounded-xl border border-neutral-800 bg-black"
	                style="aspect-ratio: 16 / 9;"
	              >
	                <iframe
	                  class="absolute inset-0 h-full w-full border-0"
	                  src={peekUrl}
	                  title={`Preview: ${item.title}`}
	                  loading="lazy"
	                  allow="fullscreen"
	                />
	              </div>

              <div class="mt-3 flex flex-wrap gap-2">
                <a
                  href={viewerUrl}
                  class="inline-flex items-center gap-2 rounded-full border border-neutral-700 bg-neutral-900 px-4 py-2 text-sm text-neutral-100 hover:bg-neutral-800"
                >
                  Viewerで開く
                </a>
                <a
                  href={modelUrl}
                  class="inline-flex items-center gap-2 rounded-full border border-neutral-800 bg-transparent px-4 py-2 text-sm text-neutral-300 hover:bg-neutral-900"
                >
                  model.3dss.json
                </a>
              </div>
            </div>

            <div class="min-w-0">
              {hasNonEmptyString(descriptionLong) ? (
                <p class="text-sm leading-relaxed text-neutral-300">{descriptionLong}</p>
              ) : null}

              {Array.isArray(tags) && tags.length ? (
                <div class="mt-3 flex flex-wrap gap-2">
                  {tags.map((t) => (
                    <span class="rounded-full border border-neutral-800 bg-neutral-900 px-2 py-0.5 text-xs text-neutral-300">{t}</span>
                  ))}
                </div>
              ) : null}

              <div class="mt-4 grid grid-cols-1 gap-2 text-xs text-neutral-400">
                {hasNonEmptyString(createdAt) ? (
                  <div><span class="text-neutral-500">created:</span> {createdAt}</div>
                ) : null}
                {hasNonEmptyString(updatedAt) ? (
                  <div><span class="text-neutral-500">updated:</span> {updatedAt}</div>
                ) : null}
              </div>

              {Array.isArray(authors) && authors.length ? (
                <div class="mt-4">
                  <div class="text-xs font-semibold text-neutral-400">authors</div>
                  <ul class="mt-2 space-y-1 text-xs text-neutral-300">
                    {authors.map((a) => (
                      <li>
                        {a?.url ? (
                          <a class="hover:underline" href={a.url} target="_blank" rel="noreferrer">{a?.name ?? a.url}</a>
                        ) : (
                          <span>{a?.name ?? ""}</span>
                        )}
                        {a?.role ? <span class="ml-2 text-neutral-500">({a.role})</span> : null}
                      </li>
                    ))}
                  </ul>
                </div>
              ) : null}
            </div>
          </div>
        </section>

        {RenderedContent ? (
          <section class="mt-8 rounded-2xl border border-neutral-800 bg-neutral-950/40 p-5">
            <h2 class="text-base font-semibold text-neutral-100">本文</h2>
            <div class="prose prose-invert mt-4 max-w-none">
              <RenderedContent />
            </div>
          </section>
        ) : null}

        {showAdInline1 ? (
          <div class="mt-8">
            <AdSlot slot={ADSENSE_SLOTS.slot_300x250} layout="in-article" className="w-full" />
          </div>
        ) : null}

        {attachments.length ? (
          <section class="mt-8 rounded-2xl border border-neutral-800 bg-neutral-950/40 p-5">
            <h2 class="text-base font-semibold text-neutral-100">添付ファイル</h2>
            <ul class="mt-3 list-disc space-y-1 pl-5 text-sm text-neutral-300">
              {attachments.map((f) => (
                <li><a class="hover:underline" href={f.url} target="_blank" rel="noreferrer">{f.name}</a></li>
              ))}
            </ul>
          </section>
        ) : null}

        {referencesMeaningful.length ? (
          <section class="mt-8 rounded-2xl border border-neutral-800 bg-neutral-950/40 p-5">
            <h2 class="text-base font-semibold text-neutral-100">参考</h2>
            <div class="mt-3 space-y-3 text-sm text-neutral-300">
              {referencesMeaningful.map((r) => (
                <div class="rounded-xl border border-neutral-800 bg-neutral-950/40 p-3">
                  {hasNonEmptyString(r?.title) ? <div class="font-medium text-neutral-100">{r.title}</div> : null}
                  <div class="mt-1 text-xs text-neutral-400">
                    {hasNonEmptyString(r?.authors) ? <span>{r.authors}</span> : null}
                    {hasNonEmptyString(r?.year) ? <span class="ml-2">({r.year})</span> : null}
                    {hasNonEmptyString(r?.publisher_or_venue) ? <span class="ml-2">{r.publisher_or_venue}</span> : null}
                  </div>
                  {hasNonEmptyString(r?.url) ? (
                    <div class="mt-2">
                      <a class="text-xs text-neutral-300 hover:underline" href={r.url} target="_blank" rel="noreferrer">{r.url}</a>
                    </div>
                  ) : null}
                  {hasNonEmptyString(r?.scope_note) ? (
                    <div class="mt-2 text-xs text-neutral-400">{r.scope_note}</div>
                  ) : null}
                </div>
              ))}
            </div>
          </section>
        ) : null}

        {(hasNonEmptyString(rights?.license) || hasNonEmptyString(rights?.copyright) || thirdParty.length) ? (
          <section class="mt-8 rounded-2xl border border-neutral-800 bg-neutral-950/40 p-5">
            <h2 class="text-base font-semibold text-neutral-100">権利</h2>
            <div class="mt-3 space-y-2 text-sm text-neutral-300">
              {hasNonEmptyString(rights?.license) ? (
                <div><span class="text-neutral-500">license:</span> {rights.license}</div>
              ) : null}
              {hasNonEmptyString(rights?.copyright) ? (
                <div><span class="text-neutral-500">copyright:</span> {rights.copyright}</div>
              ) : null}
              {thirdParty.length ? (
                <div class="mt-4">
                  <div class="text-xs font-semibold text-neutral-400">third-party</div>
                  <ul class="mt-2 list-disc space-y-1 pl-5 text-xs text-neutral-300">
                    {thirdParty.map((t) => (
                      <li>
                        <span>{t.name}</span>
                        {hasNonEmptyString(t?.license) ? <span class="ml-2 text-neutral-400">{t.license}</span> : null}
                        {hasNonEmptyString(t?.url) ? (
                          <a class="ml-2 hover:underline" href={t.url} target="_blank" rel="noreferrer">source</a>
                        ) : null}
                      </li>
                    ))}
                  </ul>
                </div>
              ) : null}
            </div>
          </section>
        ) : null}
      </main>

      <aside class="hidden lg:block">
        <div class="sticky top-6 space-y-6">
          {showAdDesktopRail ? (
            <div class="rounded-2xl border border-neutral-800 bg-neutral-950/40 p-3">
              <AdSlot slot={ADSENSE_SLOTS.slot_300x600} className="w-full" />
            </div>
          ) : null}

          <div class="rounded-2xl border border-neutral-800 bg-neutral-950/40 p-4">
            <div class="text-xs font-semibold text-neutral-400">Quick</div>
            <div class="mt-3 flex flex-col gap-2">
              <a
                href={viewerUrl}
                class="inline-flex items-center justify-center rounded-full border border-neutral-700 bg-neutral-900 px-4 py-2 text-sm text-neutral-100 hover:bg-neutral-800"
              >
                Viewer
              </a>
              <a
                href={modelUrl}
                class="inline-flex items-center justify-center rounded-full border border-neutral-800 bg-transparent px-4 py-2 text-sm text-neutral-300 hover:bg-neutral-900"
              >
                model.3dss.json
              </a>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>
</Layout>
