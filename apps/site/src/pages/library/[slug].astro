---
import Layout from "../../layouts/Layout.astro";
import { getLibraryItems, getLibraryItemBySlug } from "../../lib/libraryIndex";

export function getStaticPaths() {
  const items = getLibraryItems();
  return items.map((it) => ({ params: { slug: it.slug } }));
}

const { slug } = Astro.params;
const item = getLibraryItemBySlug(slug);

if (!item) {
  throw new Error(`Library item not found for slug=${slug}`);
}
---

<Layout
  title={`${item.title} | 3DSL Library`}
  description={(item.summary ?? "3DSL Library のコンテンツ詳細ページ。概要と出典を確認し、Viewer で操作して探索できます。")}
>
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Home", "item": "/" },
      { "@type": "ListItem", "position": 2, "name": "Library", "item": "/library" },
      { "@type": "ListItem", "position": 3, "name": item.title, "item": `/library/${item.slug}` }
    ]
  })}></script>
  <nav class="text-sm text-neutral-400">
    <a href="/library" class="hover:underline">Library</a>
    <span class="mx-2">/</span>
    <span class="text-neutral-200">{item.title}</span>
  </nav>

  <h1 class="mt-4 text-2xl font-semibold">{item.title}</h1>
  {item.summary ? <p class="mt-2 text-neutral-200">{item.summary}</p> : null}

  {item.thumb ? (
    <img
      src={item.thumb}
      alt={item.title}
      class="mt-6 w-full rounded-2xl border border-white/10"
      loading="lazy"
    />
  ) : null}

  <div class="mt-6 flex flex-wrap gap-3">
    <a
      href={item.viewer_url}
      class="rounded-xl bg-neutral-100 px-4 py-2 text-sm font-semibold text-neutral-900"
    >
      Viewerで操作して探索する
    </a>
    <a
      href="/concept"
      class="rounded-xl border border-white/10 bg-white/5 px-4 py-2 text-sm text-neutral-100 hover:bg-white/10"
    >
      3DSLの考え方
    </a>
  </div>

  {item.entry_points?.length ? (
    <section class="mt-8">
      <h2 class="text-lg font-semibold">入口</h2>
      <div class="mt-3 flex flex-wrap gap-2">
        {item.entry_points.map((t) => (
          <span class="rounded-full border border-white/10 bg-white/5 px-3 py-1 text-sm text-neutral-200">
            {t}
          </span>
        ))}
      </div>
    </section>
  ) : null}

  {item.tags?.length ? (
    <section class="mt-8">
      <h2 class="text-lg font-semibold">タグ</h2>
      <div class="mt-3 flex flex-wrap gap-2">
        {item.tags.map((t) => (
          <a
            href={`/library?tag=${encodeURIComponent(t)}`}
            class="rounded-full border border-white/10 bg-white/5 px-3 py-1 text-sm text-neutral-200 hover:bg-white/10"
          >
            {t}
          </a>
        ))}
      </div>
    </section>
  ) : null}

  {item.pairs?.length ? (
    <section class="mt-8">
      <h2 class="text-lg font-semibold">対概念</h2>
      <ul class="mt-3 space-y-2 text-neutral-200">
        {item.pairs.map((p) => (
          <li>{p.a} ↔ {p.b}</li>
        ))}
      </ul>
    </section>
  ) : null}

  {item.rights ? (
    <section class="mt-10 rounded-2xl border border-white/10 bg-white/5 p-4">
      <h2 class="text-lg font-semibold">出典と権利表記</h2>
      {item.rights.notice_short ? (
        <p class="mt-2 text-sm text-neutral-300">{item.rights.notice_short}</p>
      ) : null}

      {item.rights.sources?.length ? (
        <ul class="mt-3 space-y-2 text-sm text-neutral-300">
          {item.rights.sources.map((s) => (
            <li>
              <span class="font-semibold text-neutral-200">{s.title ?? "出典"}</span>
              {s.creator ? <span> / {s.creator}</span> : null}
              {s.year ? <span> ({s.year})</span> : null}
              {s.locator ? <span> — {s.locator}</span> : null}
              {s.url ? (
                <span>
                  {" "}—{" "}
                  <a class="underline" href={s.url} rel="nofollow noopener" target="_blank">
                    リンク
                  </a>
                </span>
              ) : null}
            </li>
          ))}
        </ul>
      ) : null}

      <p class="mt-4 text-xs text-neutral-400">
        本ページは正当な引用の範囲で構造スナップショットを掲載しています。操作による探索は Viewer で行ってください。
      </p>
    </section>
  ) : null}

  {item.related?.length ? (
    <section class="mt-10">
      <h2 class="text-lg font-semibold">関連</h2>
      <ul class="mt-3 grid gap-3 sm:grid-cols-2">
        {item.related.map((s) => (
          <li class="rounded-2xl border border-white/10 bg-white/5 p-4 hover:bg-white/10">
            <a href={`/library/${s}`} class="font-semibold hover:underline">{s}</a>
          </li>
        ))}
      </ul>
    </section>
  ) : null}
</Layout>
