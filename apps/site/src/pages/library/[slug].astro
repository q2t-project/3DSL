---
import Layout from "../../layouts/Layout.astro";
import AdSlot from "../../components/AdSlot.astro";
import { ADSENSE_SLOTS } from "../../lib/adsense";
import { getLibraryItemBySlug, getLibraryItems } from "../../lib/libraryIndex";
import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

type AnyObj = Record<string, any>;
type Attachment = { name: string; url: string };

export function getStaticPaths() {
  const items = getLibraryItems();
  return items.map((it) => ({ params: { slug: it.slug } }));
}

const slug = String(Astro.params.slug ?? "");
const item = getLibraryItemBySlug(slug);
if (!item) {
  throw new Error(`[library/[slug]] item not found: ${slug}`);
}

// Canonical per-item meta page (used for share/copy/QR on this page)
const pagePath = `/library/${slug}/`;

// NOTE: do not rely on process.cwd(). Resolve from this file location.
const PUBLIC_DIR = fileURLToPath(new URL("../../../public/", import.meta.url));
function filePathFromPublic(rel: string) {
  const clean = String(rel).replace(/^\/+/, "");
  return path.join(PUBLIC_DIR, clean);
}

const dataDir = item.data_dir ?? `/_data/library/${slug}`;
const modelUrl = item.model_url ?? `${dataDir}/model.3dss.json`;

const metaPath = filePathFromPublic(`${dataDir}/_meta.json`);
const meta: AnyObj | null = fs.existsSync(metaPath)
  ? JSON.parse(fs.readFileSync(metaPath, "utf8"))
  : null;

const seoTitle = meta?.seo?.title ?? item.meta_title ?? item.title;
const seoDescription =
  meta?.seo?.description ?? item.meta_description ?? item.summary ?? "";

// Viewer routes
const appViewerUrl = `/app/viewer?${new URLSearchParams({
  model: modelUrl,
  from: "library",
  return: pagePath,
  title: seoTitle,
}).toString()}`;
const peekUrl = `/viewer/peek.html?model=${encodeURIComponent(modelUrl)}`;

// Per-item page config (optional)
const pageConf = meta?.page ?? {};
const adAllow = new Set<string>(
  Array.isArray(pageConf?.ads) ? pageConf.ads : ["mobile_top", "desktop_rail"]
);
const showAdMobileTop = adAllow.has("mobile_top");
const showAdDesktopRail = adAllow.has("desktop_rail");
const showAdInline1 = adAllow.has("inline_1");

function listFilesPublicDir(urlDir: string): Attachment[] {
  const abs = filePathFromPublic(urlDir);
  if (!fs.existsSync(abs)) return [];

  let ents: fs.Dirent[] = [];
  try {
    ents = fs.readdirSync(abs, { withFileTypes: true });
  } catch {
    return [];
  }

  return ents
    .filter((d) => d.isFile())
    .map((d) => ({
      name: d.name,
      url: `${urlDir.replace(/\/+$/, "")}/${encodeURIComponent(d.name)}`,
    }))
    .sort((a, b) => a.name.localeCompare(b.name));
}

const attachments = listFilesPublicDir(`${dataDir}/attachments`);

// Markdown body (optional): SSOT is public/_data/library/<id>/content.md
const contentPath = filePathFromPublic(`${dataDir}/content.md`);
let bodyHtml = "";
try {
  if (fs.existsSync(contentPath)) {
    const mdRaw = fs.readFileSync(contentPath, "utf8");

    // Normalize relative links: ./assets/* ./attachments/* -> /_data/library/<id>/...
    const md = String(mdRaw)
      .replaceAll("/_data/library/<ID>/", `/_data/library/${slug}/`)
      .replaceAll("/_data/library/{{ID}}/", `/_data/library/${slug}/`)
      .replaceAll("./assets/", `/_data/library/${slug}/assets/`)
      .replaceAll("./attachments/", `/_data/library/${slug}/attachments/`);

    function escapeHtml(x: string) {
      return x
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function escapeInline(t: string) {
      // links: [text](url)
      const parts: string[] = [];
      let rest = t;

      const pushText = (x: string) => parts.push(escapeHtml(x));

      while (rest.length) {
        const m = rest.match(/\[([^\]]+)\]\(([^)]+)\)/);
        if (!m || m.index == null) {
          pushText(rest);
          break;
        }
        const idx = m.index;
        if (idx > 0) pushText(rest.slice(0, idx));
        const label = escapeHtml(m[1]);
        const url = m[2].trim();
        const safeUrl = url.startsWith("javascript:") ? "#" : url;
        parts.push(`<a href="${escapeHtml(safeUrl)}" class="hover:underline">${label}</a>`);
        rest = rest.slice(idx + m[0].length);
      }

      return parts.join("");
    }

    function mdToHtml(src: string) {
      const lines = src.replaceAll("\r\n", "\n").split("\n");
      let out: string[] = [];
      let inCode = false;
      let codeBuf: string[] = [];
      let inList = false;

      const flushList = () => {
        if (inList) {
          out.push("</ul>");
          inList = false;
        }
      };

      const flushCode = () => {
        if (inCode) {
          out.push(`<pre><code>${escapeHtml(codeBuf.join("\n"))}</code></pre>`);
          inCode = false;
          codeBuf = [];
        }
      };

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i] ?? "";

        if (line.startsWith("```")) {
          if (inCode) {
            flushCode();
          } else {
            flushList();
            inCode = true;
            codeBuf = [];
          }
          continue;
        }

        if (inCode) {
          codeBuf.push(line);
          continue;
        }

        const h = line.match(/^(#{1,6})\s+(.*)$/);
        if (h) {
          flushList();
          const lvl = h[1].length;
          out.push(`<h${lvl}>${escapeHtml(h[2].trim())}</h${lvl}>`);
          continue;
        }

        const li = line.match(/^[-*]\s+(.*)$/);
        if (li) {
          if (!inList) {
            out.push("<ul>");
            inList = true;
          }
          out.push(`<li>${escapeInline(li[1].trim())}</li>`);
          continue;
        }

        if (!line.trim()) {
          flushList();
          continue;
        }

        flushList();
        out.push(`<p>${escapeInline(line.trim())}</p>`);
      }

      flushList();
      flushCode();
      return out.join("\n");
    }

    const html0 = mdToHtml(md);
    bodyHtml = html0.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (_all, alt, url) => {
      const u = String(url).trim();
      const safe = u.startsWith("javascript:") ? "" : u;
      return `<img src="${escapeHtml(safe)}" alt="${escapeHtml(String(alt ?? ""))}" loading="lazy" />`;
    });
  }
} catch {
  bodyHtml = "";
}

const tags = Array.isArray(meta?.tags) ? meta!.tags : item.tags ?? [];
const descriptionLong = meta?.description ?? "";
const createdAt = item.created_at ?? meta?.created_at ?? "";
const updatedAt = item.updated_at ?? meta?.updated_at ?? "";

function hasNonEmptyString(x: unknown): x is string {
  return typeof x === "string" && x.trim().length > 0;
}

const authors: AnyObj[] = Array.isArray(meta?.authors) ? meta!.authors : [];
const references: AnyObj[] = Array.isArray(meta?.references) ? meta!.references : [];
const rights: AnyObj | null = meta?.rights ?? null;

const referencesMeaningful = references.filter(
  (r) =>
    hasNonEmptyString(r?.title) ||
    hasNonEmptyString(r?.url) ||
    hasNonEmptyString(r?.authors)
);

const thirdParty = Array.isArray(rights?.third_party)
  ? rights.third_party.filter(
      (t: AnyObj) =>
        hasNonEmptyString(t?.name) ||
        hasNonEmptyString(t?.url) ||
        hasNonEmptyString(t?.license)
    )
  : [];
---

<Layout title={seoTitle} description={seoDescription}>
  <div class="mx-auto max-w-[1200px] px-4 py-6">
    <div class="text-sm text-neutral-500">
      <a href="/library" class="hover:underline">Library</a>
      <span class="mx-2">/</span>
      <span class="text-neutral-400">{item.title}</span>
    </div>

    <div class="mt-3">
      <h1 class="text-3xl font-semibold tracking-tight text-neutral-100">{item.title}</h1>
      {item.summary ? (
        <p class="mt-2 max-w-[75ch] text-base leading-relaxed text-neutral-300">{item.summary}</p>
      ) : null}
    </div>

    {showAdMobileTop ? (
      <div class="mt-4 lg:hidden">
        <AdSlot slot={ADSENSE_SLOTS.slot_300x250} class="w-full" />
      </div>
    ) : null}

    <div class="mt-6 grid grid-cols-1 gap-6 lg:grid-cols-[minmax(0,1fr)_300px]">
      <main class="min-w-0">
        <section class="rounded-2xl border border-neutral-800 bg-neutral-950/40 p-4">
          <div class="grid grid-cols-1 gap-5 lg:grid-cols-2">
            <div class="min-w-0">
              <div class="group relative w-full overflow-hidden rounded-xl border border-neutral-800 bg-black h-[min(46vw,220px)] sm:h-[min(56.25vw,280px)]">
                <iframe
                  class="absolute inset-0 block h-full w-full pointer-events-none"
                  src={peekUrl}
                  title={`Preview: ${item.title}`}
                  loading="lazy"
                  allow="fullscreen"
                />

                <!-- clickable preview: keep the mini viewer non-interactive but use it as a clear navigation affordance -->
                <a
                  href={appViewerUrl}
                  class="absolute inset-0 block"
                  aria-label="全画面"
                >
                </a>
              </div>

              <div class="mt-3 grid grid-cols-1 gap-2 sm:grid-cols-2">
                <a
                  href={appViewerUrl}
                  class="inline-flex items-center justify-center gap-2 rounded-xl bg-neutral-100/10 px-4 py-3 text-sm font-semibold text-neutral-50 ring-1 ring-inset ring-neutral-200/15 transition hover:bg-neutral-100/15 active:scale-[0.99]"
                >
                  <svg viewBox="0 0 24 24" width="16" height="16" class="h-4 w-4 shrink-0" aria-hidden="true"><path fill="currentColor" d="M7 3h4v2H7v4H5V5a2 2 0 0 1 2-2Zm12 0a2 2 0 0 1 2 2v4h-2V5h-4V3h4ZM5 15h2v4h4v2H7a2 2 0 0 1-2-2v-4Zm14 0h2v4a2 2 0 0 1-2 2h-4v-2h4v-4Z"/></svg>
                  全画面
                </a>

                <a
                  href={modelUrl}
                  class="inline-flex items-center justify-center gap-2 rounded-xl border border-neutral-800 bg-neutral-950/30 px-4 py-3 text-sm font-medium text-neutral-200 transition hover:bg-neutral-900/60 active:scale-[0.99]"
                  target="_blank"
                  rel="noreferrer"
                >
                  <svg viewBox="0 0 24 24" width="16" height="16" class="h-4 w-4 shrink-0" aria-hidden="true"><path fill="currentColor" d="M6 2h9l5 5v15a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm8 1.5V8h4.5L14 3.5ZM7 12h10v2H7v-2Zm0 4h10v2H7v-2Z"/></svg>
                  JSON
                </a>
              </div>

              <!-- share / copy / QR -->
              <div class="mt-3 flex flex-wrap items-start justify-between gap-3">
                <div class="flex flex-wrap gap-2">
                <button
                  id="lib-share"
                  type="button"
                  class="group inline-flex flex-col items-center justify-center gap-1 rounded-xl border border-neutral-800 bg-neutral-950/30 px-3 py-2 text-neutral-200 transition hover:bg-neutral-900/60"
                  aria-label="共有"
                >
                  <svg viewBox="0 0 24 24" width="20" height="20" class="h-5 w-5 shrink-0" aria-hidden="true"><path fill="currentColor" d="M18 16a3 3 0 0 0-2.62 1.55L8.91 13.7a3.2 3.2 0 0 0 0-3.4l6.47-3.85A3 3 0 1 0 15 5a3 3 0 0 0 .05.55L8.58 9.4a3 3 0 1 0 0 5.2l6.47 3.85A3 3 0 1 0 18 16z"/></svg>
                  <span class="text-[11px] text-neutral-300">共有</span>
                </button>

                <button
                  id="lib-copy"
                  type="button"
                  class="group inline-flex flex-col items-center justify-center gap-1 rounded-xl border border-neutral-800 bg-neutral-950/30 px-3 py-2 text-neutral-200 transition hover:bg-neutral-900/60"
                  aria-label="リンクをコピー"
                >
                  <svg viewBox="0 0 24 24" width="20" height="20" class="h-5 w-5 shrink-0" aria-hidden="true"><path fill="currentColor" d="M3.9 12a4.1 4.1 0 0 1 4.1-4.1h4v2H8A2.1 2.1 0 0 0 8 14.1h4v2H8A4.1 4.1 0 0 1 3.9 12zm6.1 1h4v-2h-4v2zm6-5.1h-4v-2h4a4.1 4.1 0 1 1 0 8.2h-4v-2h4a2.1 2.1 0 1 0 0-4.2z"/></svg>
                  <span class="text-[11px] text-neutral-300">コピー</span>
                </button>
                </div>

                <div class="shrink-0 rounded-xl border border-neutral-800 bg-neutral-950/30 p-2">
                  <img id="lib-qr-inline" class="h-[76px] w-[76px] rounded-lg border border-neutral-800 bg-neutral-950" alt="" loading="lazy" />
                </div>
              </div>
            </div>

            <div class="min-w-0">
              {hasNonEmptyString(descriptionLong) ? (
                <p class="text-sm leading-relaxed text-neutral-200">{descriptionLong}</p>
              ) : null}

              {Array.isArray(tags) && tags.length ? (
                <div class="mt-3 flex flex-wrap gap-2">
                  {tags.map((t) => (
                    <span class="rounded-full border border-neutral-800 bg-neutral-900 px-2 py-0.5 text-xs text-neutral-300">{t}</span>
                  ))}
                </div>
              ) : null}

              <div class="mt-5 grid grid-cols-1 gap-2 rounded-xl border border-neutral-800 bg-neutral-950/30 p-3 text-xs text-neutral-400">
                {hasNonEmptyString(createdAt) ? (
                  <div><span class="text-neutral-500">created:</span> {createdAt}</div>
                ) : null}
                {hasNonEmptyString(updatedAt) ? (
                  <div><span class="text-neutral-500">updated:</span> {updatedAt}</div>
                ) : null}
              </div>

              {Array.isArray(authors) && authors.length ? (
                <div class="mt-4">
                  <div class="text-xs font-semibold text-neutral-400">authors</div>
                  <ul class="mt-2 space-y-1 text-xs text-neutral-300">
                    {authors.map((a) => (
                      <li>
                        {a?.url ? (
                          <a class="hover:underline" href={a.url} target="_blank" rel="noreferrer">{a?.name ?? a.url}</a>
                        ) : (
                          <span>{a?.name ?? ""}</span>
                        )}
                        {a?.role ? <span class="ml-2 text-neutral-500">({a.role})</span> : null}
                      </li>
                    ))}
                  </ul>
                </div>
              ) : null}
            </div>
          </div>
        </section>

        {bodyHtml ? (
          <section class="mt-8 rounded-2xl border border-neutral-800 bg-neutral-950/40 p-5">
            <h2 class="text-base font-semibold text-neutral-100">テキスト</h2>
            <div class="prose prose-invert mt-4 max-w-none">
              <div set:html={bodyHtml} />
            </div>
          </section>
        ) : null}

        {showAdInline1 ? (
          <div class="mt-8">
            <AdSlot slot={ADSENSE_SLOTS.slot_300x250} class="w-full" />
          </div>
        ) : null}

        {attachments.length ? (
          <section class="mt-8 rounded-2xl border border-neutral-800 bg-neutral-950/40 p-5">
            <h2 class="text-base font-semibold text-neutral-100">添付ファイル</h2>
            <ul class="mt-3 list-disc space-y-1 pl-5 text-sm text-neutral-300">
              {attachments.map((f) => (
                <li><a class="hover:underline" href={f.url} target="_blank" rel="noreferrer">{f.name}</a></li>
              ))}
            </ul>
          </section>
        ) : null}

        {referencesMeaningful.length ? (
          <section class="mt-8 rounded-2xl border border-neutral-800 bg-neutral-950/40 p-5">
            <h2 class="text-base font-semibold text-neutral-100">参考</h2>
            <div class="mt-3 space-y-3 text-sm text-neutral-300">
              {referencesMeaningful.map((r) => (
                <div class="rounded-xl border border-neutral-800 bg-neutral-950/40 p-3">
                  {hasNonEmptyString(r?.title) ? <div class="font-medium text-neutral-100">{r.title}</div> : null}
                  <div class="mt-1 text-xs text-neutral-400">
                    {hasNonEmptyString(r?.authors) ? <span>{r.authors}</span> : null}
                    {hasNonEmptyString(r?.year) ? <span class="ml-2">({r.year})</span> : null}
                    {hasNonEmptyString(r?.publisher_or_venue) ? <span class="ml-2">{r.publisher_or_venue}</span> : null}
                  </div>
                  {hasNonEmptyString(r?.url) ? (
                    <div class="mt-2">
                      <a class="text-xs text-neutral-300 hover:underline" href={r.url} target="_blank" rel="noreferrer">{r.url}</a>
                    </div>
                  ) : null}
                  {hasNonEmptyString(r?.scope_note) ? (
                    <div class="mt-2 text-xs text-neutral-400">{r.scope_note}</div>
                  ) : null}
                </div>
              ))}
            </div>
          </section>
        ) : null}

        {(hasNonEmptyString(rights?.license) || hasNonEmptyString(rights?.copyright) || thirdParty.length) ? (
          <section class="mt-8 rounded-2xl border border-neutral-800 bg-neutral-950/40 p-5">
            <h2 class="text-base font-semibold text-neutral-100">権利</h2>
            <div class="mt-3 space-y-2 text-sm text-neutral-300">
              {hasNonEmptyString(rights?.license) ? (
                <div><span class="text-neutral-500">license:</span> {rights.license}</div>
              ) : null}
              {hasNonEmptyString(rights?.copyright) ? (
                <div><span class="text-neutral-500">copyright:</span> {rights.copyright}</div>
              ) : null}
              {thirdParty.length ? (
                <div class="mt-4">
                  <div class="text-xs font-semibold text-neutral-400">third-party</div>
                  <ul class="mt-2 list-disc space-y-1 pl-5 text-xs text-neutral-300">
                    {thirdParty.map((t: AnyObj) => (
                      <li>
                        <span>{t.name}</span>
                        {hasNonEmptyString(t?.license) ? <span class="ml-2 text-neutral-400">{t.license}</span> : null}
                        {hasNonEmptyString(t?.url) ? (
                          <a class="ml-2 hover:underline" href={t.url} target="_blank" rel="noreferrer">source</a>
                        ) : null}
                      </li>
                    ))}
                  </ul>
                </div>
              ) : null}
            </div>
          </section>
        ) : null}
      </main>

      <aside class="hidden lg:block">
        <div class="sticky top-6 space-y-6">
          {showAdDesktopRail ? (
            <div class="rounded-2xl border border-neutral-800 bg-neutral-950/40 p-3">
              <AdSlot slot={ADSENSE_SLOTS.slot_300x600} class="w-full" />
            </div>
          ) : null}
        </div>
      </aside>
    </div>
  </div>

  <!-- Toast (library share UI lives on this meta page) -->
  <div id="lib-toast" class="fixed left-1/2 top-4 z-[60] hidden -translate-x-1/2 rounded-xl border border-neutral-800 bg-neutral-950/90 px-4 py-2 text-sm text-neutral-100 shadow-lg"></div>
  <script is:inline define:vars={{ pagePath }}>
    (() => {
      const shareBtn = document.getElementById('lib-share');
      const copyBtn = document.getElementById('lib-copy');
      const toast = document.getElementById('lib-toast');
      const qrInline = document.getElementById('lib-qr-inline');

      function getShareUrl() {
        try {
          return new URL(pagePath, window.location.origin).toString();
        } catch {
          return window.location.href;
        }
      }

      function setInlineQr() {
        if (!qrInline) return;
        const url = getShareUrl();
        const src = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${encodeURIComponent(url)}`;
        qrInline.setAttribute('src', src);
      }

      let toastTimer = 0;
      function showToast(msg) {
        if (!toast) return;
        toast.textContent = msg;
        toast.classList.remove('hidden');
        clearTimeout(toastTimer);
        toastTimer = window.setTimeout(() => {
          toast.classList.add('hidden');
        }, 2400);
      }

      async function copyText(v) {
        try {
          await navigator.clipboard.writeText(v);
          return true;
        } catch {
          try {
            const ta = document.createElement('textarea');
            ta.value = v;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            ta.remove();
            return true;
          } catch {
            return false;
          }
        }
      }

      async function shareUrl() {
        const url = getShareUrl();
        if (navigator.share) {
          try {
            await navigator.share({ url });
            return;
          } catch {
            // fall back to copy
          }
        }
        const ok = await copyText(url);
        showToast(ok ? 'リンクをコピーした' : 'コピーできんかった');
      }

      async function copyUrl() {
        const ok = await copyText(getShareUrl());
        showToast(ok ? 'リンクをコピーした' : 'コピーできんかった');
      }

      setInlineQr();
      shareBtn?.addEventListener('click', () => { shareUrl(); });
      copyBtn?.addEventListener('click', () => { copyUrl(); });
    })();
  </script>

</Layout>
