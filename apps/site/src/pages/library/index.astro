---
import Layout from "../../layouts/Layout.astro";
import { getLibraryItems } from "../../lib/libraryIndex";

const ITEMS_PER_PAGE = 20;
const items = getLibraryItems();

function fmtDate(s) {
  if (!s) return null;
  const t = Date.parse(String(s));
  if (!Number.isFinite(t)) return null;
  const d = new Date(t);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${dd}`;
}

function pickPublished(item) {
  // 優先: republished_at -> published_at -> created_at
  return (
    fmtDate(item?.republished_at) ??
    fmtDate(item?.published_at) ??
    fmtDate(item?.created_at)
  );
}

function pickPublishedLabel(item) {
  // published系が無いなら created を代用してる、と分かる表示にする
  const hasPub = fmtDate(item?.republished_at) || fmtDate(item?.published_at);
  return hasPub ? "published" : "created";
}

---

<Layout title="Library | 3DSL" description="3DSL Library">
  <section class="library-page">
      <!-- controls -->
      <section class="controls">
        <input id="search" type="text" placeholder="Search title, summary, tags…" />
        <select id="sort">
          <option value="new">Newest</option>
          <option value="old">Oldest</option>
          <option value="title">Title (A–Z)</option>
        </select>
      </section>

      <!-- cards -->
      <section id="cards" class="card-grid"></section>

      <!-- pager -->
      <nav class="pager">
        <button id="prev">Prev</button>
        <span id="page-info"></span>
        <button id="next">Next</button>
      </nav>
  </section>
  <script is:inline>

    function fmtDate(s) {
      if (!s) return null;
      const t = Date.parse(String(s));
      if (!Number.isFinite(t)) return null;
      const d = new Date(t);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${dd}`;
    }

    function pickPublished(item) {
      return (
        fmtDate(item?.republished_at) ??
        fmtDate(item?.published_at) ??
        fmtDate(item?.created_at)
      );
    }

    function pickPublishedLabel(item) {
      const hasPub = fmtDate(item?.republished_at) || fmtDate(item?.published_at);
      return hasPub ? "published" : "created";
    }

    const ITEMS = /** @type {any[]} */ ({JSON.stringify(items)});
      const ITEMS_PER_PAGE = {ITEMS_PER_PAGE};

      let query = "";
      let sort = "new";
      let page = 1;

      const searchEl = document.getElementById("search");
      const sortEl = document.getElementById("sort");
      const cardsEl = document.getElementById("cards");
      const pageInfoEl = document.getElementById("page-info");

      const prevBtn = document.getElementById("prev");
      const nextBtn = document.getElementById("next");

      function dateKey(item) {
        // ソートは「生文字」やなくて、fmtDateで正規化したYYYY-MM-DDで比較
        return (
          fmtDate(item?.republished_at) ||
          fmtDate(item?.published_at) ||
          fmtDate(item?.created_at) ||
          ""
        );
      }

      function scrollToTop() {
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function apply() {
        let filtered = ITEMS.filter((it) => {
          const hay = (
            it.title +
            " " +
            (it.summary || "") +
            " " +
            (it.tags || []).join(" ")
          ).toLowerCase();
          return hay.includes(query);
        });

        filtered.sort((a, b) => {
          if (sort === "title") {
            return a.title.localeCompare(b.title, "ja");
          }
          const da = dateKey(a);
          const db = dateKey(b);
          return sort === "new"
            ? db.localeCompare(da)
            : da.localeCompare(db);
        });

        const total = filtered.length;
        const maxPage = Math.max(1, Math.ceil(total / ITEMS_PER_PAGE));
        page = Math.min(page, maxPage);

        const slice = filtered.slice(
          (page - 1) * ITEMS_PER_PAGE,
          page * ITEMS_PER_PAGE
        );

        render(slice, page, maxPage);
      }

      function render(list, page, maxPage) {
        cardsEl.innerHTML = "";

        for (const it of list) {
          const card = document.createElement("article");
          card.className = "card";

          const tagsAll = Array.isArray(it.tags) ? it.tags : [];
          const tags = tagsAll.slice(0, 2);
          const rest = Math.max(0, tagsAll.length - 2);

          const published = pickPublished(it);
          const publishedLabel = pickPublishedLabel(it);
          const created = fmtDate(it.created_at);

          const detailUrl = it.page || `/library/${it.slug || it.id}/`;

          // summaryは空でも崩れんように
          const summary = (it.summary || "").trim();

          card.innerHTML = `
            <a class="card-link" href="${it.viewer_url}">
              <div class="card-head">
                <h2 class="card-title">${escapeHtml(it.title || "")}</h2>
                <button class="card-info" type="button" aria-label="Detail">ⓘ</button>
              </div>

              <p class="card-summary">${escapeHtml(summary)}</p>

              <div class="card-tags">
                ${tags.map((t) => `<span>#${escapeHtml(t)}</span>`).join("")}
                ${rest > 0 ? `<span class="tag-more">+${rest}</span>` : ""}
              </div>

              <div class="card-dates">
                ${created ? `<span class="date-chip">created ${created}</span>` : ""}
                ${published ? `<span class="date-chip">${publishedLabel} ${published}</span>` : ""}
              </div>
            </a>
          `;

          // Detailボタンだけ別遷移（カードクリック=viewer）
          card.querySelector(".card-info")?.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            window.location.href = detailUrl;
          });

          cardsEl.appendChild(card);
        }

        pageInfoEl.textContent = `${page} / ${maxPage}`;
        prevBtn.disabled = page <= 1;
        nextBtn.disabled = page >= maxPage;
      }
      searchEl.oninput = (e) => {
        query = e.target.value.toLowerCase();
        page = 1;
        apply();
      };

      sortEl.onchange = (e) => {
        sort = e.target.value;
        page = 1;
        apply();
      };

      prevBtn.onclick = () => {
        page--;
        apply();
        scrollToTop();
      };

      nextBtn.onclick = () => {
        page++;
        apply();
        scrollToTop();
      };

      apply();

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

    </script>

    <style>
    .library-page {
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      max-width: 1080px;
      margin: 0 auto;
    }

    .controls {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      margin-bottom: 14px;

      position: sticky;
      top: 0;
      z-index: 10;
      padding: 10px 0;
      background: #0b0b0b;
      backdrop-filter: blur(6px);
    }

    .controls input,
    .controls select {
      height: 44px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.15);
      background: #0b0b0b;
      color: inherit;
      padding: 0 12px;
      font-size: 16px; /* iOSズーム抑止 */
    }

    @media (max-width: 640px) {
      .controls {
        grid-template-columns: 1fr;
      }
      .controls select {
        width: 100%;
      }
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 14px;
    }

    @media (max-width: 640px) {
      .card-grid {
        grid-template-columns: 1fr; /* スマホは1列固定 */
        gap: 12px;
      }
    }

    .card {
      padding: 14px;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 14px;
      background: #0b0b0b;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card-title {
      font-size: 1.05rem;
      font-weight: 650;
      line-height: 1.25;
    }

    .card-summary {
      font-size: 0.92rem;
      opacity: 0.85;
      line-height: 1.55;

      display: -webkit-box;
      -webkit-line-clamp: 3; /* 行数制限 */
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .card-tags span {
      font-size: 0.78rem;
      opacity: 0.75;
      border: 1px solid rgba(255,255,255,0.12);
      padding: 4px 8px;
      border-radius: 999px;
    }

    .card-dates{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:2px;
    }

    .card-link{
      display:flex;
      flex-direction:column;
      gap:8px;
      text-decoration:none;
      color:inherit;
      height:100%;
    }

    .card:hover{
      border-color: rgba(255,255,255,0.28);
    }

    .card-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    .card-info{
      flex:0 0 auto;
      opacity:0.7;
      border:1px solid rgba(255,255,255,0.18);
      border-radius:999px;
      padding:2px 8px;
      line-height:1.6;
      font-size:0.85rem;
    }

    .card-info{
      background: transparent;
      color: inherit;
      cursor: pointer;
    }

    .card-info:hover{ opacity:1; }

    .tag-more{
      font-size:0.78rem;
      opacity:0.65;
      border:1px dashed rgba(255,255,255,0.18);
      padding:4px 8px;
      border-radius:999px;
    }

    .date-chip{
    font-size:0.78rem;
    opacity:0.75;
    border:1px solid rgba(255,255,255,0.12);
    padding:3px 8px;
    border-radius:999px;
    line-height:1.2;
    }

    .pager {
      margin-top: 18px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
      display: flex;
      gap: 10px;
      justify-content: center;
      align-items: center;

      position: sticky;
      bottom: 0;
      background: #0b0b0b;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.12);
    }

    .pager button {
      height: 44px;
      min-width: 92px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.18);
      background: #0b0b0b;
      color: inherit;
    }

    .pager button:disabled {
      opacity: 0.4;
    }
    </style>
</Layout>
