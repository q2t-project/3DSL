---
import { getLibraryItems } from "../../lib/libraryIndex";
import Layout from "../../layouts/Layout.astro";

const items = getLibraryItems();
const ITEMS_PER_PAGE = 20;

function fmtDate(s) {
  if (!s) return null;
  const t = Date.parse(String(s));
  if (!Number.isFinite(t)) return null;
  const d = new Date(t);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${dd}`;
}

function pickPublished(item) {
  // 優先: republished_at -> published_at -> created_at
  return (
    fmtDate(item?.republished_at) ??
    fmtDate(item?.published_at) ??
    fmtDate(item?.created_at)
  );
}

function pickPublishedLabel(item) {
  // published系が無いなら created を代用してる、と分かる表示にする
  const hasPub = fmtDate(item?.republished_at) || fmtDate(item?.published_at);
  return hasPub ? "published" : "created";
}

---

  <Layout title="Library | 3DSL" description="3DSL Library">
    <section class="library-page">
      <!-- controls -->
      <section class="controls">
        <input id="search" type="text" placeholder="Search title, summary, tags…" />
        <select id="sort">
          <option value="new">Newest</option>
          <option value="old">Oldest</option>
          <option value="title">Title (A–Z)</option>
        </select>
      </section>

      <!-- cards -->
      <section id="cards" class="lib-grid"></section>

      <!-- pager -->
      <nav class="pager">
        <button id="prev">Prev</button>
        <span id="page-info"></span>
        <button id="next">Next</button>
      </nav>
    </section>

  <script is:inline define:vars={{ ITEMS: items, ITEMS_PER_PAGE }}>
    function fmtDate(s) {
      if (!s) return null;
      const t = Date.parse(String(s));
      if (!Number.isFinite(t)) return null;
      const d = new Date(t);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${dd}`;
    }

    function pickPublished(item) {
      return (
        fmtDate(item?.republished_at) ??
        fmtDate(item?.published_at) ??
        fmtDate(item?.created_at)
      );
    }

    function pickPublishedLabel(item) {
      const hasPub = fmtDate(item?.republished_at) || fmtDate(item?.published_at);
      return hasPub ? "published" : "created";
    }


      let query = "";
      let sort = "new";
      let page = 1;

      const searchEl = document.getElementById("search");
      const sortEl = document.getElementById("sort");
      const cardsEl = document.getElementById("cards");
      const pageInfoEl = document.getElementById("page-info");

      const prevBtn = document.getElementById("prev");
      const nextBtn = document.getElementById("next");

      function dateKey(item) {
        // ソートは「生文字」やなくて、fmtDateで正規化したYYYY-MM-DDで比較
        return (
          fmtDate(item?.republished_at) ||
          fmtDate(item?.published_at) ||
          fmtDate(item?.created_at) ||
          ""
        );
      }

      function scrollToTop() {
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function apply() {
        let filtered = ITEMS.filter((it) => {
          const hay = (
            it.title +
            " " +
            (it.summary || "") +
            " " +
            (it.tags || []).join(" ")
          ).toLowerCase();
          return hay.includes(query);
        });

        filtered.sort((a, b) => {
          if (sort === "title") {
            return a.title.localeCompare(b.title, "ja");
          }
          const da = dateKey(a);
          const db = dateKey(b);
          return sort === "new"
            ? db.localeCompare(da)
            : da.localeCompare(db);
        });

        const total = filtered.length;
        const maxPage = Math.max(1, Math.ceil(total / ITEMS_PER_PAGE));
        page = Math.min(page, maxPage);

        const slice = filtered.slice(
          (page - 1) * ITEMS_PER_PAGE,
          page * ITEMS_PER_PAGE
        );

        render(slice, page, maxPage);
      }

      function render(list, page, maxPage) {
        cardsEl.innerHTML = "";

        for (const it of list) {
          const tagsAll = Array.isArray(it.tags) ? it.tags : [];
          const tags = tagsAll.slice(0, 2);
          const rest = Math.max(0, tagsAll.length - 2);

          const published = pickPublished(it);
          const publishedLabel = pickPublishedLabel(it);
          const created = fmtDate(it.created_at);

          const detailUrl = it.page || `/library/${it.slug || it.id}/`;

          const summary = (it.summary || "").trim();
          const tickerParts = [];
          if (summary) tickerParts.push(summary);
          if (tagsAll.length) {
            const tagStr = tags
              .map((t) => `#${t}`)
              .concat(rest > 0 ? [`+${rest}`] : [])
              .join(" ");
            tickerParts.push(tagStr);
          }
          const tickerText = tickerParts.join("  ");

          const card = document.createElement("a");
          card.className = "lib-card";
          card.href = it.viewer_url;
          card.setAttribute("data-slug", String(it.slug || it.id || ""));

          const badgeText = String(it.id || it.slug || "");
          const createdText = created ? `c ${created}` : "";
          const updatedText = published ? `${publishedLabel} ${published}` : "";

          // NOTE: CSS側が .lib-ticker-track の 2x content を前提にしてる。
          card.innerHTML = `
            <div class="lib-top">
              <span class="lib-uuid-badge" role="button" tabindex="0" aria-label="Detail">${escapeHtml(badgeText)}</span>
              <span class="lib-created">${escapeHtml(createdText)}</span>
              <span class="lib-updated">${escapeHtml(updatedText)}</span>
              <div class="lib-ticker" data-scroll="false">
                <div class="lib-ticker-track">
                  <span>${escapeHtml(tickerText)}</span>
                  <span class="lib-ticker-gap"></span>
                  <span>${escapeHtml(tickerText)}</span>
                </div>
              </div>
            </div>
            <div class="lib-title">${escapeHtml(it.title || "")}</div>
          `;

          // uuid badge: detailへ
          const badge = card.querySelector(".lib-uuid-badge");
          const goDetail = (e) => {
            e.preventDefault();
            e.stopPropagation();
            window.location.href = detailUrl;
          };
          badge?.addEventListener("click", goDetail);
          badge?.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") goDetail(e);
          });

          cardsEl.appendChild(card);
        }

        // ticker auto-scroll: overflow したやつだけ走らせる
        for (const el of cardsEl.querySelectorAll(".lib-ticker")) {
          const track = el.querySelector(".lib-ticker-track");
          if (!track) continue;
          const w = el.clientWidth;
          const sw = track.scrollWidth / 2; // 2x content
          if (sw > w + 8) {
            const dist = Math.max(0, sw - w);
            el.style.setProperty("--lib-ticker-dist", `${dist}px`);
            // 速度: 40px/s くらい
            const dur = Math.max(6, Math.ceil(dist / 40));
            el.style.setProperty("--lib-ticker-dur", `${dur}s`);
            el.setAttribute("data-scroll", "true");
          } else {
            el.setAttribute("data-scroll", "false");
          }
        }

        pageInfoEl.textContent = `${page} / ${maxPage}`;
        prevBtn.disabled = page <= 1;
        nextBtn.disabled = page >= maxPage;
      }
      searchEl.oninput = (e) => {
        query = e.target.value.toLowerCase();
        page = 1;
        apply();
      };

      sortEl.onchange = (e) => {
        sort = e.target.value;
        page = 1;
        apply();
      };

      prevBtn.onclick = () => {
        page--;
        apply();
        scrollToTop();
      };

      nextBtn.onclick = () => {
        page++;
        apply();
        scrollToTop();
      };

      apply();

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }
  </script>
</Layout>
