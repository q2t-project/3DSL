---
import { getLibraryItems } from "../../lib/libraryIndex";
import Layout from "../../layouts/Layout.astro";

const items = getLibraryItems();
const ITEMS_PER_PAGE = 20;

function fmtDate(s) {
  if (!s) return null;
  const t = Date.parse(String(s));
  if (!Number.isFinite(t)) return null;
  const d = new Date(t);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${dd}`;
}

function pickPublished(item) {
  // 優先: republished_at -> published_at -> created_at
  return (
    fmtDate(item?.republished_at) ??
    fmtDate(item?.published_at) ??
    fmtDate(item?.created_at)
  );
}

function pickPublishedLabel(item) {
  // published系が無いなら created を代用してる、と分かる表示にする
  const hasPub = fmtDate(item?.republished_at) || fmtDate(item?.published_at);
  return hasPub ? "published" : "created";
}

---

  <Layout title="Library | 3DSL" description="3DSL Library">
    <section class="library-page">
      <!-- controls -->
      <section class="controls">
        <input id="search" type="text" placeholder="Search title, summary, tags…" />
        <select id="sort">
          <option value="new">Newest</option>
          <option value="old">Oldest</option>
          <option value="title">Title (A–Z)</option>
        </select>
      </section>

      <!-- cards -->
      <section id="cards" class="lib-grid"></section>

      <!-- pager -->
      <nav class="pager">
        <button id="prev">Prev</button>
        <span id="page-info"></span>
        <button id="next">Next</button>
      </nav>
    </section>

  <script is:inline define:vars={{ ITEMS: items, ITEMS_PER_PAGE }}>
    function fmtDate(s) {
      if (!s) return null;
      const t = Date.parse(String(s));
      if (!Number.isFinite(t)) return null;
      const d = new Date(t);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${dd}`;
    }

    function pickPublished(item) {
      return (
        fmtDate(item?.republished_at) ??
        fmtDate(item?.published_at) ??
        fmtDate(item?.created_at)
      );
    }

    function pickPublishedLabel(item) {
      const hasPub = fmtDate(item?.republished_at) || fmtDate(item?.published_at);
      return hasPub ? "published" : "created";
    }


      let query = "";
      let sort = "new";
      let page = 1;

      const searchEl = document.getElementById("search");
      const sortEl = document.getElementById("sort");
      const cardsEl = document.getElementById("cards");
      const pageInfoEl = document.getElementById("page-info");

      const prevBtn = document.getElementById("prev");
      const nextBtn = document.getElementById("next");

      function dateKey(item) {
        // ソートは「生文字」やなくて、fmtDateで正規化したYYYY-MM-DDで比較
        return (
          fmtDate(item?.republished_at) ||
          fmtDate(item?.published_at) ||
          fmtDate(item?.created_at) ||
          ""
        );
      }

      function scrollToTop() {
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function apply() {
        let filtered = ITEMS.filter((it) => {
          const hay = (
            it.title +
            " " +
            (it.summary || "") +
            " " +
            (it.tags || []).join(" ")
          ).toLowerCase();
          return hay.includes(query);
        });

        filtered.sort((a, b) => {
          if (sort === "title") {
            return a.title.localeCompare(b.title, "ja");
          }
          const da = dateKey(a);
          const db = dateKey(b);
          return sort === "new"
            ? db.localeCompare(da)
            : da.localeCompare(db);
        });

        const total = filtered.length;
        const maxPage = Math.max(1, Math.ceil(total / ITEMS_PER_PAGE));
        page = Math.min(page, maxPage);

        const slice = filtered.slice(
          (page - 1) * ITEMS_PER_PAGE,
          page * ITEMS_PER_PAGE
        );

        render(slice, page, maxPage);
      }

      function render(list, page, maxPage) {
        cardsEl.innerHTML = "";

        for (const it of list) {
          const card = document.createElement("article");
          card.className = "lib-card";

          const published = pickPublished(it);
          const publishedLabel = pickPublishedLabel(it);
          const created = fmtDate(it.created_at);

          const detailUrl = it.page || `/library/${it.slug || it.id}/`;

          const title = String(it.title || "");
          const summary = (it.summary || "").trim();
          const tagsAll = Array.isArray(it.tags) ? it.tags : [];
          const tickerText = [summary, ...tagsAll.map((t) => `#${t}`)].filter(Boolean).join(" · ");

          const viewerUrl = String(it.viewer_url || "");
          const openHtml = viewerUrl
            ? `
            <a class="lib-open" href="${escapeHtml(viewerUrl)}" title="Viewerで開く" aria-label="Viewerで開く">
              <span class="icon" aria-hidden="true">⛶</span>
            </a>`
            : "";

          // B案: クリックの主導線は「詳細（メタ情報）ページ」
          // Viewer への直行は右上の別リンクに分離（a の入れ子を避ける）
          card.innerHTML = `
            <a class="lib-main" href="${detailUrl}" aria-label="Open details: ${escapeHtml(title)}">
              <div class="lib-meta">
                <span class="lib-uuid-badge">${escapeHtml(String(it.id || it.slug || ""))}</span>
                ${published
                  ? `<span class="lib-date">${escapeHtml(publishedLabel)} ${escapeHtml(published)}</span>`
                  : created
                    ? `<span class="lib-date">created ${escapeHtml(created)}</span>`
                    : ``}
              </div>

              <div class="lib-ticker" data-scroll="false" aria-label="Summary and tags">
                <span class="lib-ticker-track">
                  <span class="lib-ticker-seg lib-ticker-a">${escapeHtml(tickerText)}</span>
                  <span class="lib-ticker-gap"></span>
                  <span class="lib-ticker-seg lib-ticker-b">${escapeHtml(tickerText)}</span>
                </span>
              </div>

              <div class="lib-title">${escapeHtml(title)}</div>
            </a>

            ${openHtml}
          `;

          cardsEl.appendChild(card);
        }

        pageInfoEl.textContent = `${page} / ${maxPage}`;
        prevBtn.disabled = page <= 1;
        nextBtn.disabled = page >= maxPage;
        scheduleTickerUpdate();
      }
      searchEl.oninput = (e) => {
        query = e.target.value.toLowerCase();
        page = 1;
        apply();
      };

      sortEl.onchange = (e) => {
        sort = e.target.value;
        page = 1;
        apply();
      };

      prevBtn.onclick = () => {
        page--;
        apply();
        scrollToTop();
      };

      nextBtn.onclick = () => {
        page++;
        apply();
        scrollToTop();
      };



let _tickerRAF = 0;

function scheduleTickerUpdate() {
  if (_tickerRAF) return;
  _tickerRAF = requestAnimationFrame(() => {
    _tickerRAF = 0;
    updateTickers();
  });
}

function updateTickers() {
  const tickers = cardsEl.querySelectorAll(".lib-ticker");
  for (const el of tickers) {
    const track = el.querySelector(".lib-ticker-track");
    if (!track) continue;

    const boxW = el.clientWidth || el.getBoundingClientRect().width;
    const trackW = track.scrollWidth;

    if (trackW <= boxW + 2) {
      el.dataset.scroll = "false";
      el.style.removeProperty("--lib-ticker-dist");
      el.style.removeProperty("--lib-ticker-dur");
      continue;
    }

    const dist = trackW - boxW;
    const dur = Math.max(10, Math.round(dist / 40));

    el.dataset.scroll = "true";
    el.style.setProperty("--lib-ticker-dist", `${dist}px`);
    el.style.setProperty("--lib-ticker-dur", `${dur}s`);
  }
}

window.addEventListener("resize", scheduleTickerUpdate, { passive: true });
("resize", scheduleTickerUpdate, { passive: true });
      apply();

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }
  </script>
</Layout>
