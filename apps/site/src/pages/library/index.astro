---
import Layout from "../../layouts/Layout.astro";
import { getLibraryItems } from "../../lib/libraryIndex";

const items = getLibraryItems();

const title = "Library | 3DSL";
const description =
  "3DSL Library：カードを眺めて入口を選び、詳細や Viewer で深掘りするための一覧です。";

const allTags = Array.from(new Set(items.flatMap((it) => it.tags ?? []))).sort((a, b) =>
  a.localeCompare(b, "ja")
);

const dateFormatter = new Intl.DateTimeFormat("ja-JP", { dateStyle: "medium" });

function joinText(it: any) {
  return [
    it.title ?? "",
    it.summary ?? "",
    ...(it.tags ?? []),
    ...(it.entry_points ?? []),
    ...((it.pairs ?? []).flatMap((p: any) => [p.a, p.b])),
  ]
    .join(" ")
    .toLowerCase();
}
function formatUpdatedAt(raw?: string | null) {
  if (!raw) return null;
  const t = Date.parse(raw);
  if (!Number.isFinite(t)) return null;
  return dateFormatter.format(new Date(t));
}
function toAppViewerUrl(viewerUrl: string) {
  if (!viewerUrl) return viewerUrl;
  if (viewerUrl.startsWith("/app/viewer")) return viewerUrl;
  try {
    const u = new URL(viewerUrl, "http://x");
    // contract: prefer `model`, accept legacy `open`
    let model = u.searchParams.get("model") || u.searchParams.get("open") || "";
    if (!model) {
      const p = u.pathname || "";
      if (/\.(json|3dss\.json)$/i.test(p)) model = p;
    }
    if (!model) return viewerUrl;

    const q = new URLSearchParams();
    q.set("model", model);
    const mode = u.searchParams.get("mode");
    if (mode) q.set("mode", mode);
    const src = u.searchParams.get("src");
    if (src) q.set("src", src);

    return `/app/viewer?${q.toString()}`;
  } catch {
    return viewerUrl;
  }
}

---

<Layout title={title} description={description}>
  <section class="ui-surface p-8">
    <div class="flex flex-wrap items-end justify-between gap-4">
      <div>
        <h1 class="text-2xl font-medium tracking-tight">Library</h1>
        <p class="mt-2 text-sm text-neutral-300">
          一覧をスワイプして、面白そうなカードを開いてください。目的がある場合は、共有リンク（/library/[slug]）から直接入れます。
        </p>
      </div>

    <div class="text-xs text-neutral-400">
        <span id="count">表示 {items.length} / {items.length}</span>
      </div>
    </div>

    {/* controls: tags row + optional search */}
    <div class="mt-5 flex flex-col gap-3">
      {allTags.length > 0 && (
        <div class="flex items-center gap-2">
          <div
            class="flex flex-1 gap-2 overflow-x-auto pb-1 [-ms-overflow-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden"
            aria-label="タグ"
          >
            {allTags.map((t) => (
              <button
                class="tag ui-chip shrink-0"
                data-tag={t}
                type="button"
              >
                {t}
              </button>
            ))}
          </div>

          <details class="relative">
            <summary
              class="list-none ui-chip px-4 py-1 cursor-pointer"
              aria-label="検索を開く"
            >
              検索
            </summary>

            <div class="absolute right-0 mt-2 w-[min(24rem,90vw)] ui-surface p-4 bg-neutral-950/95 shadow-lg">
              <div class="flex items-center gap-2">
                <input
                  id="q"
                  class="w-full rounded-xl border border-white/10 bg-white/[0.04] px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 focus:outline-none focus:ring-2 focus:ring-cyan-300/30"
                  placeholder="タイトル/説明/入口/タグ"
                />
                <button
                  id="clear"
                  class="ui-btn shrink-0"
                  type="button"
                >
                  クリア
                </button>
              </div>
              <p class="mt-2 text-xs text-neutral-400">
                基本はカード一覧の流し見でOKです。検索は「特定の言葉が含まれるものだけ見たい」場合に使えます。
              </p>
            </div>
          </details>
        </div>
      )}
    </div>
  </section>

  <section id="grid" class="mt-6 flex flex-col gap-3">
    {items.map((it) => {
      const updated = formatUpdatedAt(it.updated_at);
      const viewerBase = toAppViewerUrl(it.viewer_url);
      return (
        <article
          class="card ui-card p-5 hover:bg-white/5 focus-within:ring-2 focus-within:ring-cyan-300/30"
          data-tags={(it.tags ?? []).join(",")}
          data-text={joinText(it)}
          data-viewer-url={viewerBase}
          tabindex="0"
          role="link"
          aria-label={`${it.title} を Viewer で開く`}
        >
          <div class="flex flex-col gap-3">
            <div class="flex flex-wrap items-center justify-between gap-2">
              <div class="text-lg font-semibold leading-snug">{it.title}</div>

              <div class="flex items-center gap-3">
                {updated && (
                  <span class="text-xs text-neutral-400">更新 {updated}</span>
                )}

                <a
                  class="text-xs text-neutral-300 underline decoration-white/20 hover:decoration-white/60"
                  href={`/library/${it.slug}`}
                  data-role="detail-link"
                >
                  詳細
                </a>
              </div>
            </div>

            {it.summary && (
              <p class="library-summary text-sm text-neutral-300 leading-relaxed">{it.summary}</p>
            )}

            {(it.tags?.length ?? 0) > 0 && (
              <div class="flex flex-wrap gap-2">
                {it.tags.map((t: string) => (
                  <span class="ui-chip px-2 py-1 text-xs text-neutral-400">{t}</span>
                ))}
              </div>
            )}
          </div>
        </article>
      );
    })}
  </section>

  {items.length === 0 && (
    <p class="mt-6 text-sm text-neutral-400">
      まだ公開コンテンツがありません。（public/library/library_index.json を用意してください）
    </p>
  )}

  <section class="mt-10 ui-surface p-5 text-xs text-neutral-300 leading-relaxed">
    <strong class="text-neutral-100">著作権について：</strong>
    Library のスナップショットは、構造理解を目的とした引用（またはライセンス許諾/オリジナル）に基づいて提示します。権利者表示や出典は各カードの詳細ページに記載します。操作による探索はリンク先 Viewer で行ってください。
  </section>

  <script is:inline>
    const sp = new URLSearchParams(window.location.search);
    const scrollRaw = sp.get("scroll");
    if (scrollRaw) {
      const n = Number(scrollRaw);
      const scroll = Number.isFinite(n) ? Math.max(0, Math.floor(n)) : null;
      if (scroll !== null) {
        requestAnimationFrame(() => window.scrollTo(0, scroll));
      }
      sp.delete("scroll");
      if (sp.get("from") === "library") sp.delete("from");
      const next = sp.toString();
      history.replaceState(null, "", `${window.location.pathname}${next ? `?${next}` : ""}`);
    }

    const q = document.getElementById("q");
    const clear = document.getElementById("clear");
    const count = document.getElementById("count");
    const cards = Array.from(document.querySelectorAll(".card"));
    const tagBtns = Array.from(document.querySelectorAll("button.tag"));

    // Philosophy: cards-first. Tag filter is a lightweight narrowing.
    const state = { tag: null, query: "" };

    function apply() {
      const terms = (state.query || "")
        .toLowerCase()
        .split(/\s+/)
        .filter(Boolean);

      let shown = 0;
      for (const c of cards) {
        const text = c.getAttribute("data-text") || "";
        const tags = (c.getAttribute("data-tags") || "").split(",").filter(Boolean);

        const okTag = !state.tag || tags.includes(state.tag);
        const okQuery = terms.every((t) => text.includes(t));
        const ok = okTag && okQuery;

        c.style.display = ok ? "" : "none";
        if (ok) shown++;
      }
      if (count) count.textContent = `表示 ${shown} / ${cards.length}`;
    }

    function setActiveTag(next) {
      state.tag = next;
      tagBtns.forEach((btn) => {
        const isActive = btn.dataset.tag === next;
        btn.classList.toggle("ui-chip--active", isActive);
      });
      apply();
    }

    tagBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        const t = btn.dataset.tag;
        if (!t) return;
        setActiveTag(state.tag === t ? null : t);
      });
    });

  function buildViewerUrl(base) {
    if (!base) return base;
    try {
      const u = new URL(base, window.location.origin);
      const scroll = Math.max(0, Math.round(window.scrollY || 0));
      u.searchParams.set("from", "library");
      u.searchParams.set("return", "/library");
      u.searchParams.set("scroll", String(scroll));
      // legacy compat (optional)
      u.searchParams.set("back", "/library");
      return `${u.pathname}?${u.searchParams.toString()}${u.hash}`;
    } catch {
      return base;
    }
  }

  cards.forEach((card) => {
    const base = card.dataset.viewerUrl;
    if (!base) return;

    // 詳細リンクは親のクリックを止める
    const detail = card.querySelector('[data-role="detail-link"]');
    detail?.addEventListener("click", (ev) => {
      ev.stopPropagation();
    });

  // カードクリックでViewerへ
  card.addEventListener("click", (ev) => {
    if (ev.defaultPrevented) return;
    if (ev.button !== 0) return;
    if (ev.metaKey || ev.ctrlKey || ev.shiftKey || ev.altKey) return;

    const next = buildViewerUrl(base);
    if (!next) return;

    ev.preventDefault();
    window.location.assign(next);
  });

  // Enter/Spaceでも開ける（アクセシビリティ）
  card.addEventListener("keydown", (ev) => {
    if (ev.key !== "Enter" && ev.key !== " ") return;
    const next = buildViewerUrl(base);
    if (!next) return;
    ev.preventDefault();
    window.location.assign(next);
  });
});


    q?.addEventListener("input", () => {
      state.query = q.value || "";
      apply();
    });

    clear?.addEventListener("click", () => {
      state.query = "";
      if (q) q.value = "";
      setActiveTag(null);
      apply();
    });

    apply();
  </script>
</Layout>

<style>
  .library-summary {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>