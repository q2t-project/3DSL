---
import { ADSENSE_PUBLISHER_ID, isNoAdsRequest } from '../lib/adsense';

type Props = {
  /** Ad unit slot id from AdSense */
  slot: string;
  /** Wrapper classes (Tailwind) */
  class?: string;
  /**
   * AdSense format. For most responsive display units: 'auto'
   * (AdSense uses this together with data-full-width-responsive).
   */
  format?: string;
  /** Reserve space to reduce layout shift */
  minHeight?: number;

  /** Fixed-size display ad (optional). If both are set, a fixed unit is rendered. */
  width?: number;
  height?: number;

  /** For responsive units. Defaults to true unless fixed size is used. */
  fullWidthResponsive?: boolean;
};

const {
  slot,
  class: className = '',
  format = 'auto',
  minHeight = 0,
  width = 0,
  height = 0,
  fullWidthResponsive,
} = Astro.props;

const noAds = isNoAdsRequest(Astro.url);

const isDev = import.meta.env.DEV;
const hasSlot = typeof slot === 'string' && slot.trim().length > 0;
const isFixed = Number(width) > 0 && Number(height) > 0;
const styleMinHeight = minHeight > 0 ? `min-height:${minHeight}px;` : '';
const wrapperStyle = styleMinHeight;

// For fixed-size units: set explicit ins size.
const insStyle = isFixed
  ? `display:inline-block;width:${Number(width)}px;height:${Number(height)}px;`
  : 'display:block';

const useFullWidthResponsive =
  typeof fullWidthResponsive === 'boolean' ? fullWidthResponsive : !isFixed;
---

{!noAds && (hasSlot || isDev) && (
  <div class={`ad-slot ${className}`} style={wrapperStyle} data-ad-slot={slot || 'UNSET'}>
    {hasSlot ? (
      <>
        <ins
          class="adsbygoogle"
          style={insStyle}
          data-ad-client={ADSENSE_PUBLISHER_ID}
          data-ad-slot={slot}
          {...(!isFixed ? { 'data-ad-format': format } : {})}
          {...(useFullWidthResponsive ? { 'data-full-width-responsive': 'true' } : {})}
        />
        <script is:inline>
          window.adsbygoogle = window.adsbygoogle || [];
          window.adsbygoogle.push({});
        </script>
      </>
    ) : (
      <div class="ad-slot__placeholder">AdSlot (slot unset)</div>
    )}
  </div>
)}

<style>
  .ad-slot {
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .ad-slot__placeholder {
    width: 100%;
    border: 1px dashed rgba(255, 255, 255, 0.18);
    border-radius: 12px;
    padding: 10px 12px;
    font-size: 12px;
    color: rgba(255, 255, 255, 0.6);
    text-align: center;
    user-select: none;
  }
</style>
