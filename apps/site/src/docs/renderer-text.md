```md
---
title: 3D文字レンダリング（Renderer Text）
description: 3D空間に文字を描く代表的手法（Sprite/ビルボード、SDF、ジオメトリ、HUD）と、品質・性能・可読性のトレードオフを整理する
status: draft
order: 40
tags: [renderer, text, sdf, performance, threejs]
---

# 3D文字レンダリング（Renderer Text）

## このページの目的

3DSL Viewer は 3D 空間を操作しながら「読める」ことを重視します。  
しかし、文字は図形と比べてレンダリング要件が繊細で、次の要素が同時に絡みます。

- 可読性（小さくても潰れない、ジャギーが目立たない）
- 安定性（ズームや回転で見え方が破綻しない）
- 性能（大量ラベルでフレーム落ちしない）
- 表現（縦書き、字形置換、アウトライン、背景など）

このページでは、3D 文字描画の代表的手法と、3DSL Viewer としての採用方針（または選択肢）を整理します。

---

## 1. 3D文字の難しさ（図形と違う点）

文字は「線画」ではなく「タイポグラフィ」であり、表示品質の要求が高い一方、画面上の占有面積は小さくなりがちです。  
そのため、次の現象が起こりやすくなります。

- 低解像度で潰れる（細部が欠ける）
- 角でジャギーが目立つ
- 拡大縮小で太さが揺れる（ヒンティングやフィルタの影響）
- 透明背景との合成でエッジが汚く見える
- 深度テストやブレンドでチラつく

3D 文字レンダリングは「見た目の一発」ではなく、**解像度と距離の変動に耐える方式**を選ぶ必要があります。

---

## 2. 代表的な手法（4系統）

### 2.1 テクスチャ（Canvas/Text → Sprite/Plane）
文字列を Canvas などで描画し、生成したテクスチャを Sprite や Plane に貼る方式。

- 長所
  - 実装が比較的簡単
  - 任意フォント、装飾（影、縁取り）を扱いやすい
  - 文字列の更新が容易
- 短所
  - 拡大するとボケる（解像度に依存）
  - 高解像度テクスチャはメモリ・転送コストが増える
  - 大量ラベルで更新コストが重い（Canvas更新・texture.needsUpdate）

用途：少数のラベル、更新頻度が低い注釈、UI寄りの表示。

### 2.2 SDF / MSDF（距離場テクスチャ）
フォントの輪郭を距離場（Signed Distance Field）としてテクスチャ化し、シェーダで滑らかに再構成する方式。

- 長所
  - 拡大縮小に強い（輪郭が滑らか）
  - 同じテクスチャで幅広いサイズに対応しやすい
  - アウトラインや影などをシェーダで付けやすい
- 短所
  - 生成パイプラインが必要（フォント→距離場）
  - 小サイズでの品質や極端な拡大で破綻する場合がある
  - 多言語・縦書き・字形置換などは別途レイアウト処理が必要

用途：大量ラベル、ズーム変動が大きい環境、安定した可読性が必要な表示。

※MSDF は角の再現性が高い一方、実装がやや複雑になります。

### 2.3 ベクタ（アウトライン）→ ジオメトリ
フォントのアウトライン（Bezier）を三角形に分割し、ジオメトリとして描く方式（TextGeometry 等）。

- 長所
  - “本物の3Dオブジェクト”として扱える（ライティング、影、奥行き）
  - 解像度依存が小さい（ただし三角形密度に依存）
- 短所
  - ジオメトリ生成が重い
  - 文字数が増えるとポリゴン数が爆発しやすい
  - 大量ラベルには不向き
  - レイアウト・縦書きの扱いが難しい

用途：タイトルなど少数・大きめの文字、彫刻的表現。

### 2.4 HUD（DOM/CSS または 2D レイヤ）
3D とは別レイヤで画面上に文字を描く（DOM overlay、2D Canvas、WebGPU/2D等）。

- 長所
  - 最も可読性が高い（Webの文字組版を利用できる）
  - 縦書きや字形置換など、成熟したエンジンを活用できる
- 短所
  - 3D 空間との一体感（遮蔽、奥行き）が弱い
  - 3D位置への追従が必要（投影座標→DOM座標変換）
  - クリック/ヒットテストなどイベント系が複雑化しやすい

用途：UI、説明パネル、注釈、デバッグ表示。

---

## 3. 3DSL Viewer の要件から見た優先順位

3DSL Viewer の文字は、主に「ラベル」として使われる想定です。  
ラベルでは次が重要になります。

- **ズーム変動に強いこと**（マルチスケール操作）
- **多数のラベルを扱えること**（points/lines の数が増える）
- **更新頻度がある程度あること**（選択状態、強調、フィルタ等）
- **描画の一貫性**（環境差で滲みやサイズが変わりにくい）

この観点では、一般に次の傾向になります。

- 大量・安定可読性：SDF / MSDF が有利
- 少数・簡便性：Canvas→Sprite が有利
- 少数・立体表現：ジオメトリが有利
- UI・縦書き含む複雑組版：HUD（DOM/CSS）が有利

3DSL では「どれか一つに固定」ではなく、用途別に棲み分けできる構造が望ましいです。

---

## 4. 品質の論点（見え方を支配するもの）

### 4.1 解像度とフィルタリング
- テクスチャ方式では、生成解像度が低いと拡大時にボケます
- 逆に解像度を上げると、メモリと転送コストが増えます
- ミップマップや異方性フィルタの設定で遠景のチラつきが変わります

### 4.2 アルファ境界（縁の汚れ）
- 透過テクスチャの縁が暗く見える（プリマルチプライド問題など）
- 背景色によって縁が目立つ（黒背景で顕著）
- SDF でも閾値やガンマで見え方が揺れます

### 4.3 深度テスト（遮蔽）と重なり
- 深度テストを有効にすると、自然な遮蔽になるが読めないことがある
- 無効にすると常に読めるが、空間整合が崩れる
- 「文字だけ前面」などのポリシーは UX と図の意味の両方に影響します

---

## 5. 性能の論点（大量ラベルで何が重いか）

ラベルが増えると、ボトルネックは概ね次のどれかになります。

- **ドローコール**：ラベルが個別オブジェクトだと増える
- **テクスチャ更新**：Canvas 生成・更新が頻繁だと重い
- **レイアウト計算**：幅計測や改行処理が毎フレームだと重い
- **GC（ガベージ）**：文字列更新で短命オブジェクトが多いと詰まる

対策の方向性は次です。

- まとめて描く（バッチング、インスタンシング、テクスチャアトラス）
- 更新頻度を下げる（dirtyフラグ、イベント駆動）
- 表示を間引く（距離、重要度、画面密度）
- 生成物をキャッシュする（同一テキストの再利用）

---

## 6. 文字レンダリングと「向き」「配置」の関係

レンダリング方式は「向き」「配置」と独立ではありません。

- Sprite/ビルボードは “カメラ追従” に自然に寄る
- Plane は “ワールド固定の面” に自然に寄る
- HUD は “スクリーン座標” に自然に寄る

そのため 3DSL の仕様設計では、次を混ぜないことが重要です。

- **どこに置くか（placement）**
- **どちらを向くか（facing）**
- **どう描くか（renderer strategy）**

これらは別の意思決定であり、データや実装の層を分離しておくと将来の差し替えが容易になります。

---

## 7. 3DSL としての推奨設計（層分離）

3DSL Viewer の実装では、次の層分離が有効です。

- **データ層（スキーマ）**  
  - ラベルの意味（target, anchor, offset, facing, scale policy 等）
- **配置層（レイアウト/ポジショニング）**  
  - 3D位置、スクリーン位置、距離スケール、整列
- **描画層（レンダラ）**  
  - Canvas/SDF/Geometry/HUD などの描画方式の選択と実装
- **運用層（最適化）**  
  - キャッシュ、間引き、バッチング、品質設定

この構造にしておくと、たとえば「SDF に差し替え」や「HUD を併用」などの変更が、配置契約を壊さずに行えます。

---

## 8. 方式選定の指針（実務用チェック）

次の問いで大枠を決められます。

- ラベルは何個程度出るか（10 / 100 / 1000）
- ズーム変動は大きいか（地図的操作か）
- 文字列は頻繁に変わるか（選択、検索、フィルタ）
- 縦書きや特殊字形が必要か
- 遮蔽（奥行き）を意味として扱いたいか、可読性優先か

目安：

- **多い + ズーム大 + 安定可読性** → SDF/MSDF を優先検討
- **少ない + 実装簡便** → Canvas→Sprite/Plane
- **UI/縦書き重視** → HUD（DOM/CSS）
- **立体表現** → ジオメトリ（少数限定）

---

## 9. 今後の検討事項

- 多言語（日本語/英語混在）でのフォント選定とフォールバック
- 縦書き対応のレイアウトエンジン（字形置換・禁則）
- 品質設定（低負荷モード／高品質モード）
- ラベル衝突回避（配置層との連携）
- クリック可能ラベル（ヒットテストの統一）

---
```
