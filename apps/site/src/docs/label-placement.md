````md
---
title: ラベル配置（Label Placement）
description: 3D空間におけるラベルの配置ルール（座標・アンカー・オフセット・面/追従・スケール）を分解し、3DSLでの契約として固定する
status: draft
order: 30
tags: [label, text, placement, rendering, ui]
---

# ラベル配置（Label Placement）

## このページの目的

3DSL Viewer における「ラベル」は、点・線・面などの要素に付随する文字情報として、読み取りを助けるために使われます。  
しかし、3D 空間ではラベルの配置が少し曖昧になるだけで、次のような問題が起こります。

- 要素からズレて見える（参照先が分からない）
- 近づくと巨大化／離れると極小化して読めない
- カメラ操作で反転・回転し、可読性が崩れる
- オクルージョン（遮蔽）で消えたり、前に出過ぎたりする
- 実装や環境差で「同じデータなのに配置が変わる」

このページでは、ラベル配置を **複数の独立した論点** に分解し、3DSL として固定すべき契約（何をデータで指定するか、何を既定にするか）を整理します。

---

## 1. ラベル配置を分解する

ラベルの「置き方」は、主に次の要素の組み合わせです。

1) **参照（target）**：何に対するラベルか（点/線/面/グループなど）  
2) **アンカー（anchor）**：対象のどこを基準点にするか  
3) **オフセット（offset）**：基準点からどれだけずらすか（どの座標系で）  
4) **面・追従（plane/facing）**：ワールド固定か、カメラ追従か  
5) **スケール（scale policy）**：距離に応じて拡大縮小するか（単位は何か）  
6) **整列（align/baseline）**：テキスト矩形のどこをアンカー点に合わせるか  
7) **可視性（visibility）**：遮蔽・背面・距離しきい値など

これらを一つの「位置」や「orientation」に混ぜると、後から仕様の固定ができなくなります。  
3DSL では、**意味が異なるものを分解し、必要最小限をデータで指定し、残りは既定値で安定化**させます。

---

## 2. 参照（target）：何に紐づくラベルか

ラベルは基本的に「対象」が必要です。対象の種類により、アンカーの候補が変わります。

- **点（point）**：点そのものが基準（位置は一意）
- **線（line）**：始点/終点/中点/最近点 など複数候補がある
- **面（plane/polygon）**：重心・代表点・角 など候補がある
- **グループ/ノード**：子要素の代表点（重心）や任意指定点 など

ラベル配置仕様の最初の固定点は「対象に対してどの基準点を取るか」です。

---

## 3. アンカー（anchor）：対象のどこに置くか

対象別の典型アンカーを先に定義しておくと運用が安定します。

### 3.1 点（point）
- `anchor = point`（唯一）

### 3.2 線（line）
- `start`（始点）
- `end`（終点）
- `mid`（中点）
- `t`（0..1 のパラメータ位置）
- `closestToCamera`（ビュー依存：可視性重視だが契約が難しい）

線ラベルは「中点」か「t 指定」を基本にしておくと、データが簡単で破綻しにくいです。

### 3.3 面/領域
- `centroid`（重心）
- `referencePoint`（任意指定点）
- `corner[n]`（頂点参照）

---

## 4. オフセット（offset）：どの座標系で、どうずらすか

オフセットは座標系を明示しないと確実に破綻します。  
主な候補は次の 3 種類です。

### 4.1 ワールド座標オフセット（world offset）
- 3D 空間の距離としてずらす
- 長所：図のスケールに一致し、ズームしても配置が一貫
- 短所：遠景で読みにくい（画面上の距離が縮む）

### 4.2 スクリーン座標オフセット（screen/pixel offset）
- 画面上のピクセルとしてずらす
- 長所：常に見やすい（UI に近い）
- 短所：ズームすると対象から離れて見える（空間的整合が崩れる）

### 4.3 ローカル（面）座標オフセット（plane/local offset）
- テキストが載る面（XY/YZ/ZX など）の 2D 軸でずらす
- 長所：面に貼る表現と相性が良い
- 短所：面の定義が必要（plane/facing とセット）

3DSL としては、**offset の座標系（world / screen / plane）を必ず区別**し、同名の数値で混ぜないことが重要です。

---

## 5. 面・追従（plane/facing）：ワールド固定か、カメラ追従か

ラベルの表現は大きく二つに分かれます。

### 5.1 ワールド固定（world）
- ラベルは空間内のオブジェクトとして存在
- 角度によって読めないことがある
- 裏に回ると鏡文字／背面になる問題が出る

### 5.2 カメラ追従（camera / billboard）
- 常に読める
- ただし上下反転や回転の拘束が必要になることがある
- 「図に貼られた文字」というより UI 的になる

この違いは「描画の好み」ではなく、**情報としての意味（図に固定か、常に読ませる UI か）**の違いです。  
したがって 3DSL では、ラベル配置の契約として明確に区別する必要があります。

---

## 6. スケール（scale policy）：距離に応じてどう変えるか

ラベルは「読めるサイズ」である必要がありますが、3D ではサイズの単位が揺れます。  
スケール方針は次のように分けられます。

- **world-size**：3D 空間の大きさを一定にする  
  - 空間的整合は高いが、遠景で読みにくい
- **screen-size**：画面上の大きさ（ピクセル）を一定に近づける  
  - 常に読めるが、空間的整合は下がる
- **hybrid**：近距離は world、遠距離は screen のように補間する  
  - 実装は複雑だが体験が良い

3DSL Viewer での既定は、運用を簡単にするために「screen-size（またはそれに近い挙動）」を採りやすい一方、  
図としての意味を重視する場合は world-size が必要になることもあります。

重要なのは、**どの方針が採用されているかを、データか仕様文書で固定する**ことです。

---

## 7. 整列（align/baseline）：テキスト矩形のどこをアンカーに合わせるか

アンカー点が決まっても、テキストは矩形（バウンディングボックス）を持つため、  
「どこを基準点に合わせるか」が決まっていないと見た目が揺れます。

典型は次です。

- 水平：`left` / `center` / `right`
- 垂直：`top` / `middle` / `bottom`（または baseline 系）

図の注釈としては「左上基準」「中央基準」など運用ルールがあると整います。  
3DSL では **align/baseline を配置契約として扱い、既定値を明示**しておくのが安全です。

---

## 8. 可視性（visibility）：遮蔽・背面・距離

3D でラベルが「消える」理由は複数あります。

- 深度テストで遮蔽される（対象の裏に回る等）
- 背面（backface）扱いで非表示になる
- 距離が遠すぎて縮小され読めない
- 他ラベルと重なって混雑し、間引きが必要になる

最低限、次は仕様として整理しておくべきです。

- **遮蔽に従うか**（隠れるのが自然か、常に前面表示か）
- **背面の扱い**（裏からは読ませない／鏡文字でもよい／両面可読にする）
- **距離しきい値**（表示/非表示の閾値があるか）

---

## 9. 3DSL の設計方針：配置を「契約」にする

3DSL は、ラベル配置を「実装依存の見た目」ではなく、次のような契約として固定します。

- 参照（target）とアンカー（anchor）は明確に分ける
- オフセットは座標系（world/screen/plane）を必ず区別する
- 面/追従（world/camera）を明示し、UI 的ラベルと図的ラベルを混在させない
- スケール方針（world/screen/hybrid）を仕様として固定する
- align/baseline の既定値を明示し、見た目の揺れを防ぐ
- 遮蔽・背面・距離の扱いを「読める」という要件から逆算して決める

---

## 10. 概念例（フィールド名は調整前提）

以下は「分解の形」の例です。実スキーマは 3DSL 側の命名規則に合わせます。

```jsonc
{
  "label": {
    "target": { "type": "point", "id": "P123" },

    "anchor": "point",          // line: "mid" | "t" | "start" | ...
    "offset": {
      "space": "screen",        // "world" | "screen" | "plane"
      "x": 12,
      "y": -8,
      "z": 0                    // space により意味が変わるなら省略/禁止も検討
    },

    "facing": "camera",         // "world" | "camera" | ...
    "scale": { "mode": "screen" }, // "world" | "screen" | "hybrid"

    "align": "center",
    "baseline": "middle",

    "visibility": {
      "occlusion": "ignore",    // "respect" | "ignore"
      "backface": "hidden",     // "hidden" | "mirror_ok" | "readable"
      "minDistance": 0,
      "maxDistance": 200
    }
  }
}
````

ポイントは、数値を増やすことではなく、**意味の異なる決定を混ぜない**ことです。

---

## 11. 典型パターン（運用棚）

運用上は、次の「棚」を用意しておくと迷いが減ります。

* **注釈（UI寄り）**：camera facing + screen offset + screen scale（常に読める）
* **図の一部（空間寄り）**：world facing + world offset + world scale（空間整合が高い）
* **線ラベル**：line anchor = mid / t + camera facing（視認性と意味の両立）
* **密集回避**：screen offset を使いつつ、間引き/優先度を導入（将来）

---

## 12. 今後の検討事項

* ラベル衝突回避（自動レイアウト、優先度、間引き）
* 複数行・囲み・背景プレートの扱い（視認性 vs 図の純度）
* 線の方向に追従するラベル（回転拘束の契約化）
* 3DSD-modeler での編集 UI（anchor/offset をどう入力させるか）

---

```
::contentReference[oaicite:0]{index=0}
```
