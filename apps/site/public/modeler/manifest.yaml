manifest_schema_version: "1.0"

app:
  name: "modeler"
  ssot_root: "/modeler/manifest.yaml"
  ssot_policy: "/modeler/SSOT_POLICY.md"

# 方針A：この manifest は「境界と統治（ports/layers/checks）」の SSOT。
# 詳細な仕様本文（長文）は docs.human_specs 側に置き、manifest から参照する。

paths:
  generated_root: "/modeler/_generated"

layers:
  - name: host
    description: "App shell (DOM skeleton / menu / file dialogs)"
  - name: entry
    description: "bootstrap / composition root"
  - name: hub
    description: "orchestrator (transaction order)"
  - name: core
    description: "canonical state + edit rules (single-writer) + IR/sidecar"
  - name: renderer
    description: "three/webgl execution (no DOM)"
  - name: ui
    description: "interaction + DOM panels (no state writes; via hub only)"

dependency_rules:
  allowed:
    - "host -> entry"
    - "host -> ui"
    - "ui -> entry"
    - "ui -> hub"
    - "entry -> hub"
    - "entry -> core"
    - "entry -> renderer"
    - "hub -> core"
    - "hub -> renderer"
  forbidden:
    - "host -> hub"         # host は hub を直接操作しない（ui 経由）
    - "host -> core"
    - "host -> renderer"
    - "core -> hub"
    - "core -> renderer"
    - "renderer -> core"
    - "renderer -> hub"
    - "hub -> ui"
    - "ui -> core"          # via hub only
    - "ui -> renderer"      # via hub only
    - "entry -> ui"         # UI is host responsibility

# Port = レイヤ境界を跨いで呼んでよい公開口（越境口）
# Modeler では ports を次の 4 系統に限定する：
#   1) host -> entry
#   2) ui -> hub
#   3) hub -> core
#   4) hub -> renderer
ports:
  # -----------------------------
  # 1) host -> entry
  # -----------------------------
  - id: "entry.bootstrapModeler"
    caller: "host"
    callee: "entry"
    surface: "bootstrapModeler(rootElOrId, options?) -> hub"
    stability: "stable"

  # -----------------------------
  # 2) ui -> hub (public runtime API)
  # -----------------------------
  - id: "hub.start"
    caller: "ui"
    callee: "hub"
    surface: "hub.start() -> void"
    stability: "stable"

  - id: "hub.stop"
    caller: "ui"
    callee: "hub"
    surface: "hub.stop() -> void"
    stability: "stable"

  - id: "hub.dispose"
    caller: "ui"
    callee: "hub"
    surface: "hub.dispose() -> void"
    stability: "stable"

  - id: "hub.resize"
    caller: "ui"
    callee: "hub"
    surface: "hub.resize(width, height, dpr?) -> void"
    stability: "stable"

  - id: "hub.pickObjectAt"
    caller: "ui"
    callee: "hub"
    surface: "hub.pickObjectAt(ndcX, ndcY) -> hit | null (hit={uuid, kind, distance, point:[x,y,z]})"
    stability: "stable"

  - id: "hub.core.facade"
    caller: "ui"
    callee: "hub"
    surface: "hub.core.* (facade: document/io/quickcheck/selection/lock/frames/transform/commands + focusByIssue)"
    stability: "stable"

  # -----------------------------
  # 3) hub -> core (DI boundary)
  # -----------------------------
  - id: "hub.core.controllers"
    caller: "hub"
    callee: "core"
    surface: "core controllers (document/io/validator/quickcheck/selection/lock/frames/transform/commandManager/sidecar)"
    stability: "stable"

  # -----------------------------
  # 4) hub -> renderer (DI boundary)
  # -----------------------------
  - id: "hub.renderer.render"
    caller: "hub"
    callee: "renderer"
    surface: "renderer.render(frameContext) -> void"
    stability: "stable"

  - id: "hub.renderer.pick"
    caller: "hub"
    callee: "renderer"
    surface: "renderer.pickObjectAt(ndcX, ndcY) -> hit | null (hit={uuid, kind, distance, point:[x,y,z]})"
    stability: "stable"

# 互換ラッパ（compat）は ports に含めない。deprecated として隔離する。
deprecated:
  compat: []

checks:
  # 4本は "落ちる"（enforced: true）前提。
  - id: "forbidden-imports"
    purpose: "dependency_rules.forbidden の静的強制 + core/renderer の window/document 直参照禁止（env隔離）"
    command: "node scripts/check-forbidden-imports.mjs"
    enforced: true
  - id: "single-writer"
    purpose: "UI から canonical state 直書きを禁止（編集は CommandManager 経由）"
    command: "node scripts/check-single-writer.mjs"
    enforced: true
  - id: "ports-conformance"
    purpose: "越境呼び出しが ports 以外で起きないこと"
    command: "node scripts/check-ports-conformance.mjs"
    enforced: true
  - id: "generated-clean"
    purpose: "_generated が最新（差分なし）"
    command: "node scripts/check-generated-clean.mjs"
    enforced: true

docs:
  human_specs:
    - id: "ssot-policy"
      path: "/modeler/SSOT_POLICY.md"
      role: "meta governance rules (human)"
      status: "authoritative"
    - id: "3dsd-modeler"
      path: "/modeler/3DSD-modeler.md"
      role: "concept + behavior spec (human)"
      status: "authoritative"
    - id: "3dsd-common"
      path: "/specs/3DSD-common.md"
      role: "common spec shared with viewer (human)"
      status: "supporting"
    - id: "3dss-schema"
      path: "/schemas/3DSS.schema.json"
      role: "contract SSOT (schema)"
      status: "authoritative"

  generated:
    - id: "ports"
      path: "/modeler/_generated/PORTS.md"
      generator: "node scripts/gen-ports.mjs"
      editable: false
