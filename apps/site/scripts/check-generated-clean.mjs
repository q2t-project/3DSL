// scripts/check-generated-clean.mjs
// Ensure generated artifacts under apps/site/public are not accidentally committed.
//
// Contract:
// - apps/site/public/* are generated by sync-* scripts
// - Only optional .gitkeep placeholders may be tracked

import path from "node:path";
import { fileURLToPath } from "node:url";
import { spawnSync } from "node:child_process";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const repoRoot = path.resolve(__dirname, "../../..");

const GENERATED_DIRS = [
  "apps/site/public/viewer",
  "apps/site/public/vendor",
  "apps/site/public/3dss/3dss/release",
];

// Allow tracked placeholders (optional)
const ALLOWLIST = new Set([
  "apps/site/public/viewer/.gitkeep",
  "apps/site/public/vendor/.gitkeep",
  "apps/site/public/3dss/3dss/release/.gitkeep",
]);

function runGit(args) {
  const r = spawnSync("git", args, { cwd: repoRoot, encoding: "utf8" });
  if (r.error) throw r.error;
  if (r.status !== 0) {
    const msg = (r.stderr || r.stdout || "").trim();
    throw new Error(`git failed: ${args.join(" ")} ${msg}`);
  }
  return (r.stdout || "").trim();
}

function listTrackedUnder(relPath) {
  // git ls-files on a directory returns tracked files under it.
  const out = runGit(["ls-files", "--", relPath]);
  if (!out) return [];
  return out
    .split("\n")
    .map((s) => s.trim())
    .filter(Boolean);
}

let bad = [];
for (const dir of GENERATED_DIRS) {
  const tracked = listTrackedUnder(dir);
  for (const f of tracked) {
    if (!ALLOWLIST.has(f)) bad.push(f);
  }
}

if (bad.length > 0) {
  console.error("[generated-clean] NG: tracked files found under generated directories:");
  for (const f of bad) console.error("  - " + f);
  console.error("\nFix: remove from git index (keep working tree if needed):");
  console.error("  git rm -r --cached apps/site/public/viewer apps/site/public/vendor apps/site/public/3dss/3dss/release");
  console.error("  (optionally add .gitkeep only, if you want placeholders)\n");
  process.exit(1);
}

console.log("[generated-clean] OK");
