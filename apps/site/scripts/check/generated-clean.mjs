// scripts/check-generated-clean.mjs
// Ensure generated artifacts are not accidentally committed.
//
// Contract:
// - apps/site/public/* are generated by sync-* scripts
// - apps/site/src/content/{docs,faq,policy} are generated by sync:docs (SSOT: packages/docs/**)
// - Only optional .gitkeep placeholders may be tracked

import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";
import { spawnSync } from "node:child_process";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const siteRoot = path.resolve(__dirname, "..", "..");
const repoRoot = path.resolve(siteRoot, "..", "..");
const GENERATED_DIRS = [
  // Generated by sync-* scripts
  "apps/site/public/viewer",
  "apps/site/public/vendor",
  "apps/site/public/schemas",

  // Generated by sync:docs (SSOT: packages/docs/**)
  "apps/site/src/content/docs",
  "apps/site/src/content/faq",
  "apps/site/src/content/policy",
];

// Allow tracked placeholders (optional)
const ALLOWLIST = new Set([
  "apps/site/public/viewer/.gitkeep",
  "apps/site/public/vendor/.gitkeep",
  "apps/site/public/schemas/.gitkeep",

  "apps/site/src/content/docs/.gitkeep",
  "apps/site/src/content/faq/.gitkeep",
  "apps/site/src/content/policy/.gitkeep",
]);
const NO_MJS_DIRS = [
  "apps/site/public/viewer",
  "apps/site/dist/viewer",
];
const NO_SCRIPT_DIRS = [
  "apps/site/public/viewer/scripts",
  "apps/site/dist/viewer/scripts",
];


function runGit(args) {
  const r = spawnSync("git", args, { cwd: repoRoot, encoding: "utf8" });
  if (r.error) throw r.error;
  if (r.status !== 0) {
    const msg = (r.stderr || r.stdout || "").trim();
    throw new Error(`git failed: ${args.join(" ")} ${msg}`);
  }
  return (r.stdout || "").trim();
}

function listTrackedUnder(relPath) {
  // git ls-files on a directory returns tracked files under it.
  const out = runGit(["ls-files", "--", relPath]);
  if (!out) return [];
  return out
    .split("\n")
    .map((s) => s.trim())
    .filter(Boolean);
}

function listMjsFiles(rootDir) {
  if (!fs.existsSync(rootDir)) return [];
  const entries = fs.readdirSync(rootDir, { withFileTypes: true });
  const files = [];
  for (const entry of entries) {
    const fullPath = path.join(rootDir, entry.name);
    if (entry.isDirectory()) {
      files.push(...listMjsFiles(fullPath));
    } else if (entry.isFile() && path.extname(entry.name) === ".mjs") {
      files.push(fullPath);
    }
  }
  return files;
}

let bad = [];
for (const dir of GENERATED_DIRS) {
  const tracked = listTrackedUnder(dir);
  for (const f of tracked) {
    if (!ALLOWLIST.has(f)) bad.push(f);
  }
}

if (bad.length > 0) {
  console.error("[generated-clean] NG: tracked files found under generated directories:");
  for (const f of bad) console.error("  - " + f);
  console.error("\nFix: remove from git index (keep working tree if needed):");
  console.error("  git rm -r --cached apps/site/public/viewer apps/site/public/vendor apps/site/public/schemas");
  console.error("  (optionally add .gitkeep only, if you want placeholders)\n");
  process.exit(1);
}


const scriptDirBad = [];
for (const dir of NO_SCRIPT_DIRS) {
  const abs = path.resolve(repoRoot, dir);
  if (fs.existsSync(abs) && fs.statSync(abs).isDirectory()) {
    scriptDirBad.push(path.relative(repoRoot, abs));
  }
}
if (scriptDirBad.length > 0) {
  console.error("[generated-clean] NG: viewer output must not contain /scripts/ directory:");
  for (const d of scriptDirBad) console.error("  - " + d);
  console.error("\nFix: ensure sync-viewer skips copying SSOT scripts (viewer checks should run from SSOT), then re-run sync and clean outputs.\n");
  process.exit(1);
}

const mjsBad = [];
for (const dir of NO_MJS_DIRS) {
  const files = listMjsFiles(path.resolve(repoRoot, dir));
  for (const file of files) {
    mjsBad.push(path.relative(repoRoot, file));
  }
}

if (mjsBad.length > 0) {
  console.error("[generated-clean] NG: .mjs files found under viewer output directories:");
  for (const f of mjsBad) console.error("  - " + f);
  console.error("\nFix: remove *.mjs files from apps/site/public/viewer and apps/site/dist/viewer.\n");
  process.exit(1);
}

console.log("[generated-clean] OK");
