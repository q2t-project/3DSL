manifest_schema_version: "1.0"

# NOTE
# - /modeler/ は Astro サイト側で利用中のため、modeler 本体の静的バンドルは当面 /modeler_app/ に配置する。
# - いずれ Astro 側のルート整理後に /modeler/ へ寄せる。

app:
  name: "modeler"
  ssot_root: "/modeler_app/manifest.yaml"
  ssot_policy: "/modeler_app/SSOT_POLICY.md"

# 方針A：この manifest は「境界と統治（ports/layers/checks）」の SSOT。
# 詳細な仕様本文（長文）は docs.human_specs 側に置き、manifest から参照する。

paths:
  generated_root: "/modeler_app/_generated"

layers:
  - name: host
    description: "App shell (DOM skeleton / menu / file dialogs / multi-window glue)"
  - name: entry
    description: "bootstrap / composition root (bootstrapModeler + previewOutBoot)"
  - name: hub
    description: "orchestrator (transaction order)"
  - name: core
    description: "canonical state + edit rules (single-writer) (future: IR/sidecar import tolerance)"
  - name: renderer
    description: "three/webgl execution (no DOM)"
  - name: ui
    description: "interaction + DOM panels (no state writes; via hub only)"

dependency_rules:
  allowed:
    - "host -> entry"
    - "host -> ui"
    - "ui -> entry"
    - "ui -> hub"
    - "entry -> hub"
    - "entry -> core"
    - "entry -> renderer"
    - "hub -> core"
    - "hub -> renderer"
  forbidden:
    - "host -> hub"         # host は hub を直接操作しない（ui 経由）
    - "host -> core"
    - "host -> renderer"
    - "core -> hub"
    - "core -> renderer"
    - "renderer -> core"
    - "renderer -> hub"
    - "hub -> ui"
    - "ui -> core"          # via hub only
    - "ui -> renderer"      # via hub only
    - "entry -> ui"         # UI is host responsibility

# Port = レイヤ境界を跨いで呼んでよい公開口（越境口）
# Modeler では ports を次の 4 系統に限定する：
#   1) host -> entry
#   2) ui -> hub
#   3) hub -> core
#   4) hub -> renderer
ports:
  # -----------------------------
  # 1) host -> entry
  # -----------------------------
  - id: "entry.bootstrapModeler"
    caller: "host"
    callee: "entry"
    surface: "bootstrapModeler(rootElOrId, options?) -> hub"
    stability: "stable"

  - id: "entry.bootstrapModelerFromUrl"
    caller: "host"
    callee: "entry"
    surface: "bootstrapModelerFromUrl(rootElOrId, url, options?) -> Promise<hub>"
    stability: "stable"

  # -----------------------------
  # 2) ui -> hub (public runtime API)
  # -----------------------------
  - id: "hub.start"
    caller: "ui"
    callee: "hub"
    surface: "hub.start() -> void"
    stability: "stable"

  - id: "hub.stop"
    caller: "ui"
    callee: "hub"
    surface: "hub.stop() -> void"
    stability: "stable"

  - id: "hub.dispose"
    caller: "ui"
    callee: "hub"
    surface: "hub.dispose() -> void"
    stability: "stable"

  - id: "hub.resize"
    caller: "ui"
    callee: "hub"
    surface: "hub.resize(width, height, dpr?) -> void"
    stability: "stable"

  - id: "hub.pickObjectAt"
    caller: "ui"
    callee: "hub"
    surface: "hub.pickObjectAt(ndcX, ndcY) -> hit | null (hit={uuid, kind, distance, point:[x,y,z]})"
    stability: "stable"

  - id: "hub.applyPickAt"
    caller: "ui"
    callee: "hub"
    surface: "hub.applyPickAt({ndcX, ndcY}?) -> issueLike | null (issueLike={uuid, kind, path})"
    stability: "stable"


  - id: "hub.worldPointOnPlaneZ"
    caller: "ui"
    callee: "hub"
    surface: "hub.worldPointOnPlaneZ(ndcX, ndcY, planeZ) -> [x,y,z] | null (3DSS coords)"
    stability: "stable"

  - id: "hub.previewSetPosition"
    caller: "ui"
    callee: "hub"
    surface: "hub.previewSetPosition(uuid, pos:[x,y,z]) -> void (preview only)"
    stability: "stable"

  - id: "hub.previewSetLineEnds"
    caller: "ui"
    callee: "hub"
    surface: "hub.previewSetLineEnds(uuid, endA, endB) -> void (preview only; endA/endB are endpoint objects: {ref:string}|{coord:[x,y,z]}|null)"
    stability: "stable"

  - id: "hub.previewSetCaptionText"
    caller: "ui"
    callee: "hub"
    surface: "hub.previewSetCaptionText(uuid, captionText, fallbackText) -> void (preview only; captionText={content, size?, align?, pose?} | null)"
    stability: "stable"


  - id: "hub.previewSetOverride"
    caller: "ui"
    callee: "hub"
    surface: "hub.previewSetOverride(uuid, override:{position?,endA?,endB?,captionText?}|null) -> void (preview only; null clears override for uuid)"
    stability: "beta"

  - id: "hub.core.controllers"
    caller: "ui"
    callee: "hub"
    surface: "hub.core.* (controllers: document/file/dirty/uiState/selection/lock/edit/import/validator/quickcheck + focusByIssue)"
    stability: "stable"

  - id: "hub.on"
    caller: "ui"
    callee: "hub"
    surface: "hub.on(type, fn) -> off()"
    stability: "stable"

  # -----------------------------
  # 3) hub -> core (DI boundary)
  # -----------------------------
  - id: "hub.core.createControllers"
    caller: "hub"
    callee: "core"
    surface: "createCoreControllers(emitter) -> core controllers (document/file/dirty/uiState/selection/lock/edit/validator/quickcheck + focusByIssue)"
    stability: "stable"

  # -----------------------------
  # 4) hub -> renderer (DI boundary)
  # -----------------------------
  - id: "hub.renderer.createRenderer"
    caller: "hub"
    callee: "renderer"
    surface: "createRenderer(canvas) -> renderer (start/stop/resize/dispose/setDocument/applyVisibility/setSelection/pickObjectAt/focusOnUuid/worldPointOnPlaneZ/previewSetPosition/previewSetLineEnds/previewSetCaptionText/previewSetOverride)"
    stability: "stable"

# 互換ラッパ（compat）は ports に含めない。deprecated として隔離する。
deprecated:
  compat: []

checks:
  # 4本は "落ちる"（enforced: true）前提。
  - id: "forbidden-imports"
    purpose: "dependency_rules.forbidden の静的強制 + core/renderer の window/document 直参照禁止（env隔離）"
    command: "node scripts/check-forbidden-imports.mjs"
    enforced: true
  - id: "single-writer"
    purpose: "UI から canonical state 直書きを禁止（編集は CommandManager 経由）"
    command: "node scripts/check-single-writer.mjs"
    enforced: true
  - id: "ports-conformance"
    purpose: "越境呼び出しが ports 以外で起きないこと"
    command: "node scripts/check-ports-conformance.mjs"
    enforced: true
  - id: "generated-clean"
    purpose: "_generated が最新（差分なし）"
    command: "node scripts/check-generated-clean.mjs"
    enforced: true

docs:
  human_specs:
    - id: "ssot-policy"
      path: "/modeler_app/SSOT_POLICY.md"
      role: "meta governance rules (human)"
      status: "authoritative"
    - id: "3dsd-modeler"
      path: "/modeler_app/3DSD-modeler.md"
      role: "concept + behavior spec (human)"
      status: "authoritative"
    - id: "3dsd-common"
      path: "/specs/3DSD-common.md"
      role: "common spec shared with viewer (human)"
      status: "supporting"
    - id: "3dss-schema"
      path: "/schemas/3DSS.schema.json"
      role: "contract SSOT (schema)"
      status: "authoritative"

    # Living report (implementation status vs spec/manifest)
    - id: "modeler-docs-index"
      path: "/docs/modeler/README.md"
      role: "docs entry for modeler"
      status: "supporting"
    - id: "implementation-report"
      path: "/docs/modeler/IMPLEMENTATION_REPORT.md"
      role: "living report: implementation status vs spec/manifest (human)"
      status: "supporting"

  generated:
    - id: "ports"
      path: "/modeler_app/_generated/PORTS.md"
      generator: "node scripts/gen-ports.mjs"
      editable: false
