<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>3DSL Viewer â€“ Dev Harness</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }

      body {
        background: #000;
        color: #ddd;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        overflow: hidden; /* ãƒšãƒ¼ã‚¸å…¨ä½“ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å°ã˜ã‚‹ */
      }

      /* å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼š
         å·¦ = 3D ãƒ“ãƒ¥ãƒ¼
         ä¸­ = 300Ã—600 åºƒå‘Šã‚¹ãƒˆãƒªãƒƒãƒ—
         å³ = ãƒ¡ã‚¿æƒ…å ±ã‚¨ãƒªã‚¢ï¼ˆã‚„ã‚„ç´°ã‚ï¼‰ */

      /* å·¦å´ï¼š3D ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆï¼‹HUDï¼‹ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ï¼‹ã‚®ã‚ºãƒ¢ï¼‹300Ã—250 AD */
      #viewer-main {
        position: relative;
        background: #111;
        overflow: hidden;
        touch-action: none; /* ã‚¿ãƒƒãƒï¼ãƒˆãƒ©ãƒƒã‚¯ãƒ‘ãƒƒãƒ‰ã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æŠ‘æ­¢ */
      }

      #viewer-canvas {
        width: 100%;
        height: 100%;
        display: block;
        background: #111;
        touch-action: none;
      }

      /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆå³ä¸Šã® 300Ã—250 ADï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼‰ */
      #ad-slot-300x250 {
        position: absolute;
        right: 12px;
        top: 40px;
        width: 300px;
        height: 250px;
        border-radius: 4px;
        border: 1px dashed rgba(255, 255, 255, 0.4);
        background: rgba(0, 0, 0, 0.5);
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: rgba(255, 255, 255, 0.7);
        pointer-events: auto; /* å°†æ¥ã®åºƒå‘Šã‚¯ãƒªãƒƒã‚¯ç”¨ */
      }

      /* ä¸­å¤®ã‚¹ãƒˆãƒªãƒƒãƒ—ï¼š300Ã—600 AD ç”¨ã‚«ãƒ©ãƒ  */
      #viewer-ad-strip {
        background: #050505;
        border-left: 1px solid rgba(255, 255, 255, 0.12);
        border-right: 1px solid rgba(255, 255, 255, 0.12);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #ad-slot-300x600 {
        width: 300px;
        height: 600px;
        border-radius: 4px;
        border: 1px dashed rgba(255, 255, 255, 0.4);
        background: rgba(0, 0, 0, 0.5);
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: rgba(255, 255, 255, 0.7);
      }

      /* å³å´ï¼šãƒ¡ã‚¿æƒ…å ±ã‚¨ãƒªã‚¢ï¼ˆç´°ã‚ï¼‰ */
      #viewer-meta {
        background: #050505;
        border-left: 1px solid rgba(255, 255, 255, 0.12);
        display: flex;
        flex-direction: column;
        font-size: 11px;
        min-width: 220px;
        max-width: 260px;
      }

      /* å³ãƒ‘ãƒãƒ«æœ€ä¸Šéƒ¨ï¼šãƒ­ã‚´ãƒ˜ãƒƒãƒ€ */
      #meta-header {
        flex: 0 0 auto;
        padding: 1px 10px 2px; /* ãƒ­ã‚´ç›´ä¸‹ã¾ã§è©°ã‚ã‚‹ */
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      #meta-logo-link {
        display: inline-block;
      }

      #meta-logo {
        display: block;
        height: 112px;
        width: auto;
        filter: invert(1); /* é»’ãƒ­ã‚´ã‚’ç™½åŸºèª¿ã«åè»¢ */
      }

      /* ãƒ¡ã‚¿æƒ…å ±ã‚¨ãƒªã‚¢ï¼ˆä¸Šä¸‹åˆ†å‰²ï¼‰ */
      #meta-file,
      #meta-model {
        padding: 4px 2px 8px;
        overflow-y: auto;
      }

      /* ä¸Šï¼šãƒ•ã‚¡ã‚¤ãƒ«ãƒ¡ã‚¿ï¼ˆå›ºå®šé«˜ã• 40%ï¼‰ */
      #meta-file {
        flex: 0 0 40%;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* ä¸‹ï¼šãƒ¢ãƒ‡ãƒ«ãƒ¡ã‚¿ï¼‹ãƒ­ã‚°ï¼ˆæ®‹ã‚Šå…¨éƒ¨ï¼‰ */
      #meta-model {
        flex: 1 1 auto;
      }

      #viewer-meta h3 {
        margin: 0 0 4px 0;
        font-size: 11px;
        font-weight: 600;
        letter-spacing: 0.03em;
        text-transform: uppercase;
        opacity: 0.9;
      }

      #viewer-meta pre {
        margin: 4px 0 0 0;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 10px;
      }

      /* ä¸Šéƒ¨ HUDï¼ˆãƒˆãƒ¼ã‚¹ãƒˆç”¨ï¼‰ */
      #viewer-hud {
        position: absolute;
        top: 16px;
        left: 50%;
        transform: translateX(-50%) translateY(-8px);
        max-width: 60%;
        padding: 8px 14px;
        background: rgba(0, 0, 0, 0.85);
        color: #eee;
        font-size: 12px;
        line-height: 1.4;
        border-radius: 999px;
        pointer-events: none;
        opacity: 0;
        transform-origin: top center;
        transition:
          opacity 0.25s ease-out,
          transform 0.25s ease-out;
      }

      #viewer-hud.hud-visible {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      #viewer-hud.hud-hidden {
        opacity: 0;
        transform: translateX(-50%) translateY(-8px);
      }

      /* ãƒ¬ãƒ™ãƒ«åˆ¥è‰² */
      #viewer-hud.hud-info {
        background: rgba(0, 0, 0, 0.85);
      }

      #viewer-hud.hud-warn {
        background: rgba(190, 140, 32, 0.9);
      }

      #viewer-hud.hud-error {
        background: rgba(180, 32, 32, 0.9);
      }

      /* ä¸‹éƒ¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆframe / å†ç”Ÿ / filterï¼‰ */
      #viewer-toolbar {
        position: absolute;
        left: 12px;
        bottom: 12px;
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.7);
        color: #eee;
        font-size: 11px;
        border-radius: 4px;
        pointer-events: auto;
        display: inline-flex;
        align-items: flex-start;
        gap: 12px;
      }

      .toolbar-main {
        display: flex;
        align-items: flex-start;
        gap: 12px;
      }

      .frame-block {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      /* ã‚¹ãƒ©ã‚¤ãƒ€ã¯ã‚„ã‚„çŸ­ã‚ */
      #frame-slider {
        width: 8vw;
        min-width: 160px;
        max-width: 260px;
      }

      #viewer-toolbar button {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 3px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(255, 255, 255, 0.04);
        color: #eee;
        cursor: pointer;
      }

      #viewer-toolbar button:hover {
        background: rgba(255, 255, 255, 0.12);
      }

      /* frame controlsï¼ˆé€£ç¶š / ãƒ‘ãƒ©ãƒ‘ãƒ© 2 æ®µï¼‰ */
      #frame-controls {
        display: flex;
        flex-direction: column;
        gap: 2px;
        margin-top: 4px;
      }

      #frame-controls .row {
        display: flex;
        gap: 4px;
      }

      #frame-controls .row-continuous,
      #frame-controls .row-flip {
        opacity: 0.4;
        transition: opacity 0.15s ease-out;
      }

      #frame-controls.mode-continuous .row-continuous,
      #frame-controls.mode-flip .row-flip {
        opacity: 1;
      }

      /* filterï¼šframe ã®å³ã«ç¸¦ä¸¦ã³ã§ 3 ã¤ */
      .filter-column {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-top: 18px;
      }

      .filter-toggle {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 2px 6px;
        border-radius: 3px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.02);
      }

      .filter-toggle .icon {
        font-size: 13px;
      }

      .filter-toggle.filter-off {
        opacity: 0.3;
      }

      /* ã‚­ãƒ¼æ“ä½œç³»ã®çµ±ä¸€ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆkeycap é¢¨ï¼‰ */
      .keycap {
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(0, 0, 0, 0.8);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }

      .keycap:hover {
        background: rgba(255, 255, 255, 0.18);
      }

      /* ã‚«ãƒ¡ãƒ©ãƒ‘ãƒãƒ«ï¼ˆmode ã‚¹ã‚¿ãƒƒã‚¯ï¼‹ã‚®ã‚ºãƒ¢ï¼‹çŸ¢å°ãƒŠãƒ“ï¼‰ */
      #camera-panel {
        position: absolute;
        right: 12px;
        bottom: 12px; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®æœ€ä¸‹éƒ¨ã¾ã§ä¸‹ã’ã‚‹ */
        display: flex;
        align-items: flex-end;
        gap: 12px;
        pointer-events: none; /* å­è¦ç´ å´ã§å¿…è¦ãªã¨ã“ã‚ã ã‘ auto ã«ã™ã‚‹ */
      }

      #mode-stack {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 11px;
        pointer-events: auto;
      }

      .mode-pill {
        min-width: 72px;
        padding: 3px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(0, 0, 0, 0.7);
        text-align: center;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        opacity: 0.5;
        filter: blur(1px); /* éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã¯è»½ãã¼ã‹ã™ */
        transition: all 0.15s ease-out;
      }

      .mode-pill-active {
        background: #ffffff;
        color: #000000;
        opacity: 1;
        filter: none; /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã¯ãã£ãã‚Š */
      }

      .mode-micro-block {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .mode-focus-label {
        font-size: 11px;
        max-width: 140px;
        padding-left: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        opacity: 0.85;
      }

      .mode-focus-toggle {
        align-self: flex-start;
        margin-top: 2px;
        padding: 1px 8px;
        font-size: 10px;
        color: #eee;
        cursor: pointer;
      }

      /* ã‚®ã‚ºãƒ¢ï¼‹çŸ¢å°ãƒŠãƒ“ */
      #gizmo-wrapper {
        position: relative;
        width: 120px;
        height: 120px;
        pointer-events: auto;
      }

      #gizmo-slot {
        width: 100%;
        height: 100%;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(0, 0, 0, 0.5);
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.6);
      }

      #gizmo-slot::before {
        content: "GIZMO";
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        font-size: 10px;
        opacity: 0.6;
      }

      .gizmo-arrow {
        position: absolute;
        width: 22px;
        height: 22px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .gizmo-arrow-up {
        top: -14px;
        left: 50%;
        transform: translateX(-50%);
      }
      .gizmo-arrow-down {
        bottom: -14px;
        left: 50%;
        transform: translateX(-50%);
      }
      .gizmo-arrow-left {
        left: -14px;
        top: 50%;
        transform: translateY(-50%);
      }
      .gizmo-arrow-right {
        right: -14px;
        top: 50%;
        transform: translateY(-50%);
      }
    </style>
  </head>

  <body>
    <div id="viewer-layout">
      <!-- å·¦ï¼š3D ãƒ“ãƒ¥ãƒ¼ï¼‹HUDï¼‹ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ï¼‹ã‚®ã‚ºãƒ¢ï¼‹300Ã—250 AD -->
      <div id="viewer-main">
        <canvas id="viewer-canvas"></canvas>

        <!-- HUD: ä¸€æ™‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ãƒˆãƒ¼ã‚¹ãƒˆ -->
        <div id="viewer-hud" class="hud-hidden"></div>

        <!-- ä¸‹éƒ¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
        <div id="viewer-toolbar">
          <div class="toolbar-main">
            <!-- frame / å†ç”Ÿ -->
            <div class="frame-block">
              <div style="opacity: 0.8">
                Frame: <span id="frame-slider-label">0</span>
              </div>
              <input
                id="frame-slider"
                type="range"
                min="0"
                max="0"
                value="0"
                step="1"
              />

              <!-- 2 æ®µæ§‹æˆï¼šä¸Šæ®µï¼é€£ç¶šå†ç”Ÿãƒ¢ãƒ¼ãƒ‰ / ä¸‹æ®µï¼ãƒ‘ãƒ©ãƒ‘ãƒ©ã‚ãã‚Š -->
              <div id="frame-controls" class="mode-flip">
                <!-- 1 è¡Œç›®ï¼šé€£ç¶šå†ç”Ÿãƒ¢ãƒ¼ãƒ‰ -->
                <div class="row row-continuous">
                  <button id="btn-rew" title="é€†é€ã‚Šï¼ˆæœ€å°ã¾ã§ã‚¸ãƒ£ãƒ³ãƒ—ï¼‰">
                    â®
                  </button>
                  <button id="btn-play" title="å†ç”Ÿ / ä¸€æ™‚åœæ­¢ (Space)">
                    Play
                  </button>
                  <button id="btn-ff" title="å…ˆé€ã‚Šï¼ˆæœ€å¤§ã¾ã§ã‚¸ãƒ£ãƒ³ãƒ—ï¼‰">
                    â­
                  </button>
                </div>
                <!-- 2 è¡Œç›®ï¼šãƒ‘ãƒ©ãƒ‘ãƒ©ã‚ãã‚Šãƒ¢ãƒ¼ãƒ‰ -->
                <div class="row row-flip">
                  <button id="btn-step-back" title="1 ãƒ•ãƒ¬ãƒ¼ãƒ æˆ»ã‚‹ (PgDn)">
                    â—€
                  </button>
                  <button id="btn-home" title="ãƒ›ãƒ¼ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ  (0)">â—</button>
                  <button
                    id="btn-step-forward"
                    title="1 ãƒ•ãƒ¬ãƒ¼ãƒ é€²ã‚€ (PgUp)"
                  >
                    â–¶
                  </button>
                </div>
              </div>
            </div>

            <!-- filter -->
            <div class="filter-column">
              <button
                id="filter-lines"
                class="filter-toggle filter-on"
                type="button"
                title="toggle lines"
              >
                <span class="icon">ğŸ‘</span><span class="label">lines</span>
              </button>
              <button
                id="filter-points"
                class="filter-toggle filter-on"
                type="button"
                title="toggle points"
              >
                <span class="icon">ğŸ‘</span><span class="label">points</span>
              </button>
              <button
                id="filter-aux"
                class="filter-toggle filter-on"
                type="button"
                title="toggle aux"
              >
                <span class="icon">ğŸ‘</span><span class="label">aux</span>
              </button>
            </div>
          </div>
        </div>

        <!-- ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºï¼‹ã‚®ã‚ºãƒ¢ -->
        <div id="camera-panel">
          <div id="viewer-gizmo-root" class="viewer-gizmo"></div>
          <div id="mode-stack">
            <div id="mode-label-macro" class="mode-pill mode-pill-active">
              MACRO
            </div>

            <!-- MESO ãƒ¢ãƒ¼ãƒ‰ pill -->
            <div id="mode-label-meso" class="mode-pill">
              MESO
            </div>

            <div class="mode-micro-block">
              <div id="mode-label-micro" class="mode-pill">micro</div>
              <button
                id="mode-focus-toggle"
                class="mode-focus-toggle keycap"
                type="button"
                title="Toggle micro focus (Q)"
              >
                FOCUS&nbsp;[Q]
              </button>
              <div id="mode-focus-label" class="mode-focus-label">-</div>
            </div>
          </div>

          <div id="gizmo-wrapper">
            <!-- çŸ¢å°ã‚­ãƒ¼ ãƒŠãƒ“ï¼‹ãƒœã‚¿ãƒ³ -->
            <button
              class="gizmo-arrow gizmo-arrow-up keycap"
              type="button"
              data-key="ArrowUp"
              title="Camera up (â†‘)"
            >
              â†‘
            </button>
            <button
              class="gizmo-arrow gizmo-arrow-right keycap"
              type="button"
              data-key="ArrowRight"
              title="Camera right (â†’)"
            >
              â†’
            </button>
            <button
              class="gizmo-arrow gizmo-arrow-down keycap"
              type="button"
              data-key="ArrowDown"
              title="Camera down (â†“)"
            >
              â†“
            </button>
            <button
              class="gizmo-arrow gizmo-arrow-left keycap"
              type="button"
              data-key="ArrowLeft"
              title="Camera left (â†)"
            >
              â†
            </button>

            <div id="gizmo-slot"></div>
          </div>
        </div>
      </div>

      <!-- å³ï¼šãƒ¡ã‚¿æƒ…å ±ã‚¨ãƒªã‚¢ -->
      <aside id="viewer-meta">
        <div id="meta-header">
          <a id="meta-logo-link" href="/viewer/">
            <img
              id="meta-logo"
              src="../assets/logo/3DSD-viewer.svg"
              alt="3DSD-viewer"
            />
          </a>
        </div>

        <div id="meta-file">
          <h3>File</h3>
          <div>(no file yet)</div>
        </div>
        <div id="meta-model">
          <h3>Model</h3>
          <div>(logs will appear here)</div>
        </div>
      </aside>
    </div>

    <script type="module">
      import { bootstrapViewerFromUrl } from "./runtime/bootstrapViewer.js";

      let viewerHub = null;
      let playTimer = null;

      const elMetaFile = document.getElementById("meta-file");
      const elMetaModel = document.getElementById("meta-model");
      const elHud = document.getElementById("viewer-hud");

      function clearMetaPanels() {
        if (elMetaFile) {
          elMetaFile.innerHTML = "<h3>File</h3><div>(loading...)</div>";
        }
        if (elMetaModel) {
          elMetaModel.innerHTML =
            "<h3>Model</h3><div>(logs will appear here)</div>";
        }
      }

      function appendModelLog(line) {
        if (!elMetaModel) return;
        if (!elMetaModel.dataset.initialized) {
          elMetaModel.innerHTML =
            "<h3>Model</h3><div class='meta-log'></div>";
          elMetaModel.dataset.initialized = "1";
        }
        const logArea =
          elMetaModel.querySelector(".meta-log") || elMetaModel;
        const div = document.createElement("div");
        div.textContent = line;
        logArea.appendChild(div);
        elMetaModel.scrollTop = elMetaModel.scrollHeight;
      }

      window.viewerLog = appendModelLog;

      function showHudMessage(text, { duration = 1600, level = "info" } = {}) {
        if (!elHud) return;

        if (showHudMessage._timer) {
          clearTimeout(showHudMessage._timer);
          showHudMessage._timer = null;
        }

        elHud.textContent = text;

        elHud.classList.remove(
          "hud-hidden",
          "hud-visible",
          "hud-info",
          "hud-warn",
          "hud-error"
        );
        elHud.classList.add("hud-visible", `hud-${level}`);

        showHudMessage._timer = setTimeout(() => {
          elHud.classList.remove("hud-visible", `hud-${level}`);
          elHud.classList.add("hud-hidden");
        }, duration);
      }

      window.viewerToast = showHudMessage;

      function initFilterControls() {
        if (!viewerHub || !viewerHub.core || !viewerHub.core.filters) return;

        const filtersAPI = viewerHub.core.filters;

        const btnLines = document.getElementById("filter-lines");
        const btnPoints = document.getElementById("filter-points");
        const btnAux = document.getElementById("filter-aux");

        function setFilterButtonState(btn, enabled) {
          if (!btn) return;
          const icon = btn.querySelector(".icon");
          if (enabled) {
            btn.classList.remove("filter-off");
            btn.classList.add("filter-on");
            if (icon) icon.textContent = "ğŸ‘";
          } else {
            btn.classList.remove("filter-on");
            btn.classList.add("filter-off");
            if (icon) icon.textContent = "ğŸ™ˆ";
          }
        }

        function syncFilterUI() {
          const f = filtersAPI.get();
          setFilterButtonState(btnLines, !!f.lines);
          setFilterButtonState(btnPoints, !!f.points);
          setFilterButtonState(btnAux, !!f.aux);
        }

        if (btnLines) {
          btnLines.addEventListener("click", () => {
            const next = btnLines.classList.contains("filter-off");
            filtersAPI.setTypeEnabled("lines", next);
            syncFilterUI();
          });
        }

        if (btnPoints) {
          btnPoints.addEventListener("click", () => {
            const next = btnPoints.classList.contains("filter-off");
            filtersAPI.setTypeEnabled("points", next);
            syncFilterUI();
          });
        }

        if (btnAux) {
          btnAux.addEventListener("click", () => {
            const next = btnAux.classList.contains("filter-off");
            filtersAPI.setTypeEnabled("aux", next);
            syncFilterUI();
          });
        }

        syncFilterUI();
      }

      function initFrameControls() {
        if (!viewerHub || !viewerHub.core || !viewerHub.core.frame) return;

        const frameAPI = viewerHub.core.frame;

        const slider = document.getElementById("frame-slider");
        const label = document.getElementById("frame-slider-label");

        const btnRew = document.getElementById("btn-rew");
        const btnPlay = document.getElementById("btn-play");
        const btnFF = document.getElementById("btn-ff");
        const btnStepBack = document.getElementById("btn-step-back");
        const btnHome = document.getElementById("btn-home");
        const btnStepForward =
          document.getElementById("btn-step-forward");

        const range = frameAPI.range();
        const current = frameAPI.get();

        function updateLabelFromState() {
          const f = frameAPI.get();
          if (slider) slider.value = f;
          if (label) label.textContent = String(f);
        }

        if (slider) {
          slider.min = range.min;
          slider.max = range.max;
          slider.step = 1;
          slider.value = current;
        }
        if (label) {
          label.textContent = String(current);
        }

        if (slider) {
          slider.addEventListener("input", (ev) => {
            const v = Number(ev.target.value);
            if (!Number.isFinite(v)) return;
            frameAPI.set(v);
            updateLabelFromState();
          });
        }

        if (btnStepBack) {
          btnStepBack.addEventListener("click", () => {
            frameAPI.step(-1);
            updateLabelFromState();
          });
        }

        if (btnStepForward) {
          btnStepForward.addEventListener("click", () => {
            frameAPI.step(1);
            updateLabelFromState();
          });
        }

        if (btnHome) {
          btnHome.addEventListener("click", () => {
            frameAPI.set(range.min);
            updateLabelFromState();
          });
        }

        if (btnRew) {
          btnRew.addEventListener("click", () => {
            frameAPI.set(range.min);
            updateLabelFromState();
          });
        }

        if (btnFF) {
          btnFF.addEventListener("click", () => {
            frameAPI.set(range.max);
            updateLabelFromState();
          });
        }

        if (btnPlay) {
          btnPlay.addEventListener("click", () => {
            if (playTimer) {
              clearInterval(playTimer);
              playTimer = null;
              btnPlay.textContent = "Play";
              return;
            }
            btnPlay.textContent = "Stop";

            playTimer = setInterval(() => {
              const r = frameAPI.range();
              const cur = frameAPI.get();
              if (cur >= r.max) {
                frameAPI.set(r.min);
              } else {
                frameAPI.step(1);
              }
              updateLabelFromState();
            }, 600);
          });
        }

        // ä»–çµŒè·¯ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ç­‰ï¼‰ã‹ã‚‰ã®å¤‰æ›´ã‚’æ‹¾ã£ã¦ UI ã‚’åŒæœŸ
        let lastFrame = frameAPI.get();
        function frameUiLoop() {
          const f = frameAPI.get();
          if (f !== lastFrame) {
            lastFrame = f;
            if (slider) slider.value = f;
            if (label) label.textContent = String(f);
          }
          requestAnimationFrame(frameUiLoop);
        }
        requestAnimationFrame(frameUiLoop);
      }

      function initModeHudLoop() {
        if (!viewerHub || !viewerHub.core) return;

        const elModeMacro = document.getElementById("mode-label-macro");
        const elModeMeso = document.getElementById("mode-label-meso");
        const elModeMicro = document.getElementById("mode-label-micro");
        const elFocusLabel = document.getElementById("mode-focus-label");
        const btnFocusToggle = document.getElementById("mode-focus-toggle");

        if (btnFocusToggle) {
          btnFocusToggle.addEventListener("click", () => {
            const sel = viewerHub.core.selection.get();
            if (!sel || !sel.uuid) return;
            viewerHub.core.mode.set("micro", sel.uuid);
          });
        }

        if (elModeMeso) {
          elModeMeso.style.cursor = "pointer";
          elModeMeso.addEventListener("click", () => {
            const sel = viewerHub.core.selection.get();
            if (!sel || !sel.uuid) return;
            viewerHub.core.mode.set("meso", sel.uuid);
          });
        }

        let lastMode = null;

        function loop() {
          if (!viewerHub || !viewerHub.core) {
            requestAnimationFrame(loop);
            return;
          }

          const modeAPI = viewerHub.core.mode;
          const uiState = viewerHub.core.uiState;

          const mode = modeAPI.get();
          if (mode !== lastMode) {
            lastMode = mode;
            let msg = "";
            if (mode === "macro") msg = "MACRO MODE";
            else if (mode === "meso") msg = "MESO MODE";
            else if (mode === "micro") msg = "MICRO MODE";
            if (msg) showHudMessage(msg, { duration: 800, level: "info" });
          }

          if (elModeMacro) {
            elModeMacro.classList.toggle(
              "mode-pill-active",
              mode === "macro"
            );
          }
          if (elModeMeso) {
            elModeMeso.classList.toggle(
              "mode-pill-active",
              mode === "meso"
            );
          }
          if (elModeMicro) {
            elModeMicro.classList.toggle(
              "mode-pill-active",
              mode === "micro"
            );
          }

          if (elFocusLabel && uiState) {
            const sel = uiState.selection || null;
            const txt = sel && sel.uuid ? sel.uuid : "-";
            elFocusLabel.textContent = txt;
          }

          requestAnimationFrame(loop);
        }

        requestAnimationFrame(loop);
      }

      function initGizmoButtons() {
        const gizmoArrows =
          document.querySelectorAll(".gizmo-arrow");
        gizmoArrows.forEach((btn) => {
          btn.addEventListener("click", () => {
            const key = btn.dataset.key;
            if (!key) return;
            const ev = new KeyboardEvent("keydown", {
              key,
              code: key,
              bubbles: true,
            });
            window.dispatchEvent(ev);
          });
        });
      }

      function initKeyboardShortcuts() {
        window.addEventListener("keydown", (ev) => {
          if (!viewerHub || !viewerHub.core) return;
          const tag = (ev.target && ev.target.tagName) || "";
          if (tag === "INPUT" || tag === "TEXTAREA") return;

          const frame = viewerHub.core.frame;
          const mode = viewerHub.core.mode;

          // Space: å†ç”Ÿ / åœæ­¢
          if (ev.code === "Space") {
            ev.preventDefault();
            const btnPlay = document.getElementById("btn-play");
            if (btnPlay) btnPlay.click();
            return;
          }

          // PgUp / PgDn / Home
          if (ev.code === "PageUp") {
            ev.preventDefault();
            frame.step(1);
            return;
          }
          if (ev.code === "PageDown") {
            ev.preventDefault();
            frame.step(-1);
            return;
          }
          if (ev.code === "Home") {
            ev.preventDefault();
            const range = frame.range();
            frame.set(range.min);
            return;
          }

          // Q: micro
          if (ev.key === "q" || ev.key === "Q") {
            ev.preventDefault();
            const sel = viewerHub.core.selection.get();
            if (sel && sel.uuid) mode.set("micro", sel.uuid);
            return;
          }

          // W: meso
          if (ev.key === "w" || ev.key === "W") {
            ev.preventDefault();
            const sel = viewerHub.core.selection.get();
            if (sel && sel.uuid) mode.set("meso", sel.uuid);
            return;
          }

          // Esc: macro
          if (ev.key === "Escape") {
            ev.preventDefault();
            mode.set("macro");
            return;
          }
        });
      }

      async function boot() {
        console.log("[viewer-dev] boot start");

        clearMetaPanels();

        const canvasId = "viewer-canvas";
        // â˜…ã“ã“ã¯è‡ªåˆ†ã® 3DSS ã‚µãƒ³ãƒ—ãƒ«ã®ãƒ‘ã‚¹ã«åˆã‚ã›ã¦å¤‰ãˆã‚‹
//        const jsonUrl = "../3dss/sample/frame_test.3dss.json";
//        const jsonUrl = "../3dss/sample/frame_filter_test.3dss.json";
//        const jsonUrl = "../3dss/sample/microfx_cluster_medium.3dss.json";
//        const jsonUrl = "../3dss/sample/microfx_depth_layers.3dss.json";
//        const jsonUrl = "../3dss/sample/microfx_label.3dss.json";
//        const jsonUrl = "../3dss/sample/microfx_long_span.3dss.json";
//        const jsonUrl = "../3dss/sample/microfx_min.3dss.json";
//        const jsonUrl = "../3dss/sample/microfx_mixed.3dss.json";
//        const jsonUrl = "../3dss/sample/xyz_basis.3dss.json";
        const jsonUrl = "../3dss/sample/sample_arrows.3dss.json";

        try {
          viewerHub = await bootstrapViewerFromUrl(canvasId, jsonUrl);
          window.hub = viewerHub; // ãƒ‡ãƒãƒƒã‚°ç”¨

          appendModelLog("Viewer boot OK.");

          if (elMetaFile && viewerHub.core && viewerHub.core.frame) {
            const range = viewerHub.core.frame.range();
            const current = viewerHub.core.frame.get();
            elMetaFile.innerHTML =
              "<h3>File</h3>" +
              `<div>Source: ${jsonUrl}</div>` +
              `<div>Frame range: [${range.min}, ${range.max}]</div>` +
              `<div>Current frame: ${current}</div>`;
          }

          showHudMessage("Viewer loaded", {
            duration: 1200,
            level: "info",
          });
        } catch (err) {
          console.error("[viewer-dev] boot failed:", err);

          if (elMetaFile) {
            elMetaFile.innerHTML =
              "<h3>File</h3>" + `<div>Source: ${jsonUrl}</div>`;
          }
          if (elMetaModel) {
            elMetaModel.innerHTML =
              "<h3>Model</h3>" +
              "<div style='color:#ff8888;'>Load error.</div>" +
              `<pre style="white-space:pre-wrap;font-size:10px;">${String(
                err
              )}</pre>`;
          }

          showHudMessage("Viewer load error", {
            duration: 3000,
            level: "error",
          });

          return;
        }

        initFrameControls();
        initFilterControls();
        initModeHudLoop();
        initGizmoButtons();
        initKeyboardShortcuts();
      }

      window.addEventListener("load", boot);
    </script>
  </body>
</html>
