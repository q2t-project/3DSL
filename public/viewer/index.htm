<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>3DSL Viewer</title>

    <style>
      body {
        margin: 0;
        background: #000;
        color: #ddd;
        font-family: system-ui;
      }

      #viewport {
        width: 100vw;
        height: 100vh;
        background: #111;
      }
    </style>
  </head>

  <body>
    <canvas id="viewer-canvas"></canvas>

    <div
      id="frame-slider-wrap"
      style="
        position: absolute;
        left: 16px;
        bottom: 16px;
        right: 16px;
        pointer-events: auto;
      "
    >
      <label
        for="frame-slider"
        style="font-size: 12px; color: #ccc; display: block; margin-bottom: 4px"
      >
        Frame: <span id="frame-slider-label">0</span>
      </label>
      <input
        id="frame-slider"
        type="range"
        min="0"
        max="0"
        value="0"
        step="1"
        style="width: 100%"
      />
    </div>

    <div
      id="viewer-hud"
      style="
        position: absolute;
        top: 12px;
        left: 12px;
        padding: 6px 10px;
        background: rgba(0, 0, 0, 0.6);
        color: #eee;
        font-size: 11px;
        line-height: 1.4;
        border-radius: 4px;
        pointer-events: none;
      "
    >
      <div>Mode: <span id="hud-mode">macro</span></div>
      <div>Frame: <span id="hud-frame">0</span></div>
      <div>Selection: <span id="hud-selection">-</span></div>
    </div>

    <script type="module">
      import { bootstrapViewerFromUrl } from "./runtime/bootstrapViewer.js";

      let core; // 外に出して共有

      async function boot() {
        console.log("[boot] start");

        const canvasId = "viewer-canvas";
        const jsonUrl = "../3dss/sample/demo.3dss.json";

        try {
          core = await bootstrapViewerFromUrl(canvasId, jsonUrl);
          console.log("[boot] done", core);
        } catch (err) {
          console.error("[boot] failed:", err);
          return;
        }

        // ▼ フレームスライダーと連動 ▼
        const slider = document.getElementById("frame-slider");
        const label = document.getElementById("frame-slider-label");

        if (slider && core.frame) {
          const range = core.frame.getRange(); // { min, max }
          const active = core.frame.getActive();

          slider.min = range.min;
          slider.max = range.max;
          slider.step = 1;
          slider.value = active;

          if (label) {
            label.textContent = String(active);
          }

          slider.addEventListener("input", (ev) => {
            const v = Number(ev.target.value);
            if (!Number.isFinite(v)) return;

            core.frame.setActive(v);

            if (label) {
              label.textContent = String(core.frame.getActive());
            }
          });
        }
        // ▲ フレームスライダーと連動 ▲

        // ▼ HUD 更新ループ ▼
        const elMode = document.getElementById("hud-mode");
        const elFrame = document.getElementById("hud-frame");
        const elSel = document.getElementById("hud-selection");

        function updateHUD() {
          if (!core || !core.ui_state) return;
          const ui = core.ui_state;

          if (elMode) {
            elMode.textContent = ui.mode;
          }
          if (elFrame) {
            elFrame.textContent = String(ui.activeFrame);
          }
          if (elSel) {
            elSel.textContent = ui.selection?.uuid ?? "-";
          }
        }

        function hudLoop() {
          updateHUD();
          requestAnimationFrame(hudLoop);
        }
        hudLoop();
        // ▲ HUD 更新ループ ▲
      }

      window.addEventListener("load", boot);
    </script>
  </body>
</html>
