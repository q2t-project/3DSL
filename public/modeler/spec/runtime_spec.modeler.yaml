runtime_spec:

  version: "2.2-draft"

  description: "3DSL Modeler Runtime Manifest â€Eholy API spec for 3DSL Viewer"

  # =========================================================
  # 0. ãƒ¬ã‚¤ãƒ¤å®šç¾© EEä¾å­˜ãƒ«ãƒ¼ãƒ«
  # =========================================================

  layers:
    - name: entry
      description: "HostEEstro/HTMLE‰ã‹ã‚‰å©ã‹ã‚Œã‚‹ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆå±¤"
    - name: hub
      description: "UI ã¨ core / renderer ã®é›E·šå±¤Eˆãƒ­ã‚¸ãƒE‚¯ç¦æ­¢EE
    - name: core
      description: "çŠ¶æ…‹ã¨ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒE‚¯ã®ä¸­æ¢ã€EDSS ã¯ read-only"
    - name: renderer
      description: "three.js ã«ã‚ˆã‚‹æç”»å°‚ç”¨ã€‚çŠ¶æ…‹ãEæç”»ã‚­ãƒ£ãƒE‚·ãƒ¥ã«é™å®šï¼Eanonical state ã¯ coreEE
    - name: ui
      description: "UI ã‚¤ãƒ™ãƒ³ãƒEâ†Ehub.core.* ã¸ã®æ©‹æ¸¡ã—å±¤EEev harness / æœ¬ç•ª host å´EE

  dependency_rules:
    # æ­£æ–¹åE
    - "ui        â†Eentry"
    - "entry     â†Ehub"
    - "entry     â†Ecore"
    - "entry     â†Erenderer"
    - "ui        â†Ehub"
    - "hub       â†Ecore"
    - "hub       â†Erenderer"

    # ç¦æ­¢æ–¹å‘ï¼ˆçµ¶å¯¾EE
    - "core      â†Ehub:       FORBIDDEN"
    - "core      â†Erenderer:  FORBIDDEN"
    - "renderer  â†Ecore:      FORBIDDEN"
    - "renderer  â†Ehub:       FORBIDDEN"
    - "hub       â†Eui:        FORBIDDEN"
    - "ui        â†Erenderer:  FORBIDDENEEick ã‚Ehub çµŒç”±EE
    - "entry     â†Eui:        FORBIDDENEEI ã¯ Host å´è²¬å‹™ï¼E

  # =========================================================
  # 0.2 DIEˆä¾å­˜æ³¨å…¥E‰æ–¹é‡ã¨ calls è¡¨è¨˜ãƒ«ãƒ¼ãƒ«
  # =========================================================

  di_policy:
    principle:
      - "core å†EEç›¸äº’å‚ç…§ã¯ import ã§çµãEãªãE€‚bootstrapViewer ã‚Ecomposition root ã¨ã—ã¦ DI ã§æ¸¡ã™ã€E
      - "hub ã¯ { core, renderer } ã‚EDI ã§å—ã‘å–ã‚Šã€core/* ã‚Erenderer/* ã‚Eimport ã—ãªãE€E
      - "core ã®åEƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ 'factory + injected deps' ã§å®Œçµã•ã›ã‚‹ã€‚createXxx ã¯å¿E¦ä¾å­˜ï¼ˆé–¢æ•°/å‚çE/å€¤E‰ã‚’ **ã™ã¹ã¦å¼•æ•°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§å—ã‘å–ã‚‹**ã€E
      - "calls è¨˜æ³•ãEä»•æ§˜ãEè¦ç¯E§ã‚ã‚Šã€å®Ÿè£EEã“ã‚Œã«å¾“ã†Eˆæ›–æ˜§ã•ã‚’æ®‹ã•ãªãE¼‰ã€E
      - "ç¦æ­¢: core/* ãŒä»–ãE core/* ã‚Eimport ã—ã¦å‘¼ã¶ã€‚ä¾‹å¤–ã¨ã—ã¦ JSDoc ã®å‹å‚ç…§ **ã®ã¿** ã¯è¨±å®¹ã™ã‚‹Eˆä¾E /** @typedef {import('./x.js').Foo} Foo */E‰ã€‚â€» ESM ã®å®Ÿè¡Œæ™‚ importEEmport {Foo} from ...E‰ãEä¾‹å¤–ã«å«ã‚ãªãE€E
      - "helperEEocal helperE‰ãE **åŒä¸€ãƒ•ã‚¡ã‚¤ãƒ«å†E«é–‰ã˜ã‚‹ç´”é–¢æ•°** ã¨ã—ã€ä»–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰ import ã—ã¦ã¯ãªã‚‰ãªãE€E
    contract_gates:
      - "scripts/check-invariants.mjs: ä¾å­˜æ–¹å‘ï¼Eorbidden importsE‰ã‚’å¼·åˆ¶"
      - "scripts/check-phase2-contract.mjs: bootstrapViewer å…¬é–‹é¢ã®æ•´åE
      - "scripts/check-phase2-core-contract.mjs: core å…¬é–‹é¢EEontrollerç¾¤/recomputeVisibleSetE‰ãEæ•´åE
      - "grep-based single-writer checkEˆæ¨å¥¨EE uiState.visibleSet / uiState.runtime.isFramePlaying ã®æ›¸ãè¾¼ã¿ç®E‰€ã‚’å›ºå®E
    calls_notation:
      - "calls: 'IMPORT:' ã¯å½“è©²ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãEimport ã—ã¦ç›´æ¥å‘¼ã¶ã“ã¨ã‚’æ„å‘³ã™ã‚‹EEntry ãªã©E‰ã€E
      - "calls: 'DI:' ã¯æ³¨å…¥ã•ã‚ŒãŸä¾å­˜ï¼ˆé–¢æ•°/å‚çE/å€¤E‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ„å‘³ã™ã‚‹Eˆå‘¼ã³å‡ºãEå‚çEã®ä¸¡æ–¹E‰ã€‚import ã‚’æ„å‘³ã—ãªãE€E
      - "calls: 'CALL:' ã¯å½“è©²ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†E§è¡Œã† **å‘¼ã³å‡ºã—å¼E* ã‚’æ„å‘³ã™ã‚‹EEmport æ¸ˆã¿é–¢æ•°ã®å‘¼ã³å‡ºã—ï¼ãƒ­ãƒ¼ã‚«ãƒ«é–¢æ•°Eã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒEƒ‰ã‚’å«ã‚€E‰ã€EI çµŒç”±ã®å‘¼ã³å‡ºã—ã‚‚ CALL ã§å¼ã‚’æ˜è¨˜ã—ã¦ã‚ˆã„ãŒã€ãã®å ´åˆãEå¯¾å¿œã™ã‚EDI è¡Œã‚’å¿Ešä½µè¨˜ã™ã‚‹ï¼EALL ã ã‘ãEç¦æ­¢E‰ã€E
      - "core å†E§ä»Ecore ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ©ŸèEã‚’ä½¿ãE ´åˆãEå¿Eš 'DI:' ã§è¡¨è¨˜ã™ã‚‹ã€E
    injection_trace:
      - "åEcore ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ di_injected ã«æ³¨å…¥å…E¼EourceE‰ã‚’æ˜è¨˜ã™ã‚‹ï¼ˆå®Ÿè£EEå¼•æ•° DI ã‚’æ¨å¥¨E‰ã€E

      
  # =========================================================
  # 0.3 ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«EEtart/stop/disposeE‰è¦ç´E
  # =========================================================

  lifecycle_policy:
    - "hub.start()/hub.stop()/hub.dispose() ã¯ **idempotent**Eˆè¤E•°å›å‘¼ã‚“ã§ã‚‚å®‰åEE‰ã¨ã™ã‚‹ã€E
    - "hub.stop(): RAF åœæ­¢ã®ã¿EEebGL è³EºãEä¿æŒE‰ã€E
    - "hub.dispose(): stop + renderer.disposeEˆè³Eºè§£æ”¾E‰ã€‚hub ã¯å‹æ‰‹ã«è³¼èª­ã‚’ä½œã‚‰ãªãEŸã‚ã€onXChanged ã®è§£é™¤ã¯å‘¼ã³å‡ºã—åEãEunsubscribe ã‚’ä¿æŒã—ã¦è¡Œã†EˆåEåˆ©ç”¨ä¸å¯E‰ã€E
    - "rendererContext.dispose(): three.js è³Eºã‚’å¯èƒ½ãªç¯E›²ã§è§£æ”¾ã—ã€Eå›ç›®ä»¥é™ãE no-opEEdempotentE‰ã¨ã™ã‚‹ã€E
    - "onXChanged ç³»ã® listener ç™»éŒ²ã¯ unsubscribe ã‚’è¿”ã™EEev harness ã§ç©ã¿ä¸Šã’ãªãE¼‰ã€E
    - "dispose å¾ŒãE start/stop/resize ã¯ no-opã€‚pickObjectAt ã¯å¸¸ã« null ã‚’è¿”ã™Eˆä¾‹å¤–ã«ã—ãªãE¼‰ã€E
    - "dispose å¾ŒãE isRunning() ã¯å¸¸ã« false ã‚’è¿”ã™ã€E

  # =========================================================
  # 1. state æ‰€æœ‰æ¨©
  # =========================================================

  ownership:
    uiState:        "core"
    visibleSet:     "core (single-writer: core/recomputeVisibleSet only)"
    isFramePlaying: "core (single-writer: core/frameController only)"
    microState:     "core"
    cameraState:    "core"
    document_3dss:  "core (immutable)"
    three_objects:  "renderer"
    viewerSettings:
      canonical: "core (uiState.viewerSettings.render / uiState.viewerSettings.fx)"

  # =========================================================
  # 2. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸€è¦§
  # =========================================================

  modules:

    # =========================
    # 2.1 entry
    # =========================
    - name: runtime/bootstrapViewer.js
      layer: entry
      responsibility:
        - "canvas ã¨ 3DSS ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å—ã‘å–ã‚Šã€AJV validate3DSS ã‚E**å¸¸ã«** å®Ÿè¡Œã—ã¦ runtime ä¸€å¼ã‚’åˆæœŸåŒ–ã™ã‚‹ï¼EGãªã‚EthrowEE
        - "validateRefIntegrity ã¯ options.strictValidate=true ã¾ãŸãE options.validateRefIntegrity=true ã®ã¨ããEã¿å®Ÿè¡Œã™ã‚E
        - "core / renderer / viewerHub ã‚’ç”Ÿæˆã—ã¦è¿”ã™"
        - "rendererContext.syncDocument(document, indices) ã‚E1 å›å‘¼ã³ã€æç”»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ã™ã‚E
        - "rendererContext.getSceneMetrics() ã‚E1 å›å‘¼ã³ã€cameraEngine ã®åˆæœŸ cameraState ã‚’ç¢ºå®šã™ã‚‹ï¼Earget/position/up/distance/fov/near/far ç­‰ï¼E
        - "metrics ãEnull ã®å ´åˆãEãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¦ç¯E‚’é©ç”¨ã—ã€åEæœEcameraState ã‚’ç¢ºå®šã•ã›ã‚‹Eˆä¾E center=[0,0,0], radius=1 ã‚’åŸºæº–ã«è·é›¢ç­‰ã‚’æ±ºã‚ã‚‹EE
        - "createRecomputeVisibleSet(...).recomputeVisibleSetEˆé–¢æ•°E‰ã‚’ core.recomputeVisibleSet ã¨ã—ã¦ä¿æŒã—ã€frameController/filters/hub ã‹ã‚‰å‘¼ã¹ã‚‹ã‚ˆãE«é…ç·šã™ã‚E
        - "æç”»ãƒ«ãƒ¼ãƒ—é–‹å§‹ãEè¡Œã‚ãšã€è¿”å´ã—ãŸ hub.start() ã«å§”è­²ã™ã‚‹"
        - "å…¥åŠ›ç³»EEointerInput / KeyboardInput / gizmo ç­‰ï¼‰ãEæ§‹ç¯‰ã›ãšã€Host / dev harness å´ã®è²¬å‹™ã¨ã™ã‚‹"
        - "EEev ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆï¼‰èµ·å‹•è¨ºæ–­ãƒ­ã‚°EEOOT/MODEL/CAMERA/LAYERS/FRAMEE‰ã‚’ç™ºè¡Œã™ã‚E
        - "core å†EEç›¸äº’å‘¼ã³å‡ºã—ãE import ã§ã¯ãªãEbootstrap ã§ä¾å­˜æ³¨å…¥EEIE‰ã§æ¸¡ã™ï¼Eomposition rootEE
        - "validate å¾Œã« deepFreeze(document) ã‚’è¡Œã„ã€ä»¥å¾Edocument ã¯ immutable æ‰±ãE¨ã™ã‚‹EEromUrl çµŒç”±ã§ã‚‚æœ€çµ‚çš„ã« bootstrapViewer ãŒå®Ÿæ–½EE
        - "EEootstrapViewerFromUrl ã®ã¿E‰URL ã‹ã‚‰ JSON ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€document ã‚EbootstrapViewer ã«æ¸¡ãE
        - "bootstrapViewerFromUrl ã¯ options.strictValidate ã® default ã‚Etrue ã¨ã™ã‚‹EˆæœªæŒE®šæ™‚ã¯ validateRefIntegrity ã¾ã§å®Ÿè¡Œï¼E
        - "bootstrapViewerFromUrl ã¯ res.ok===false ã®å ´åˆãE throwEETTP status ã‚’å«ã‚ã‚‹ã®ã‚’æ¨å¥¨EE
        - "validate + deepFreeze ã¯ bootstrapViewer ãE**å¸¸ã«** è¡Œã†EEromUrl å´ã§ã¯è¡Œã‚ãªãE¼E

        - "create*Controller ã¯å¿E¦ä¾å­˜ã‚’å¼•æ•°ã§å—ã‘å–ã‚Œã‚‹å½¢EEIE‰ã§æ§‹ç¯‰ã™ã‚E
        - "åˆæœŸåŒ–å¾Œã« recomputeVisibleSet() ã‚Eå›å‘¼ã¶"
        - "core.structIndexEEuntime/core/structIndex.js ã® buildUUIDIndex çµæœE‰ã‚’æ§‹ç¯‰ã—ã¦ hub ã¸æ¸¡ãE
        - "core.cameraControllerEE cameraControllerã€‚uuid è§£æ±ºãªã©ã®é«˜ãƒ¬ãƒ™ãƒ« camera APIE‰ã‚’æ§‹ç¯‰ã—ã¦ hub ã¸æ¸¡ãE
        - "createViewerHub ã«æ¸¡ãEcore ã¯æ¬¡ã‚’å«ã‚€: { uiState, frameController, selectionController, modeController, microController, visibilityController, cameraEngine, cameraController, viewerSettingsController, structIndex, recomputeVisibleSet }"
      exports:
        - name: bootstrapViewer
          signature: "(canvasOrId, threeDSS, options?) â†Ehub"
        - name: bootstrapViewerFromUrl
          signature: "(canvasOrId, url, options?) â†EPromise<hub>"
        - name: ViewerBootstrapOptions
          fields:
            - name: devBootLog
              signature: "(boolean)?"
              description: "true ã®ã¨ãèµ·å‹•è¨ºæ–­ãƒ­ã‚°EEOOT/MODEL/CAMERA/LAYERS/FRAMEE‰ã‚’å‡ºãE
            - name: logger
              signature: "((line:string)=>void)?"
              description: "èµ·å‹•è¨ºæ–­ãƒ­ã‚°ã‚Edev ãƒ­ã‚°ã®å‡ºåŠ›åEã€‚æœªæŒE®šãªã‚Econsole.log ç›¸å½“ã§ã‚ˆã„"
            - name: strictValidate
              signature: "(boolean)?"
              description: "true ã®ã¨ãEvalidate3DSS + validateRefIntegrity ã‚’å¿Ešå®Ÿè¡Œï¼EGãªã‚EthrowEE
            - name: validateRefIntegrity
              signature: "(boolean)?"
              description: "true ã®ã¨ãå‚ç…§æ•´åˆæ€§ãƒã‚§ãƒE‚¯ã‚’å®Ÿè¡Œï¼EGãªã‚EthrowE‰ã€‚strictValidate=true ã®å ´åˆãEæš—é»™ã« true ã¨åŒç­‰ã€E
      calls:
        # --- bootstrapViewerEEalidateâ†’freezeâ†’indicesâ†’controllersâ†’rendererâ†’hubEE--
        - "IMPORT: runtime/core/validator.initValidator"
        - "CALL: validator = initValidator()"
        - "CALL: options = normalizeBootstrapOptions(options)  # local helper (default {})"
        - "CALL: canvas = resolveCanvas(canvasOrId)  # HTMLElement or idâ†’canvas"
        - "CALL: if (!canvas) throw new Error('canvas not found')"
        - "CALL: document = threeDSS"
        - "CALL: validator.validate3DSS(document)"
        - "CALL: if (options.strictValidate || options.validateRefIntegrity) validator.validateRefIntegrity(document)"

        - "CALL: # normalizeBootstrapOptions ã®æ—¢å®E { strictValidate:false, validateRefIntegrity:false, devBootLog:false }"

        - "IMPORT: runtime/core/deepFreeze.deepFreeze"
        - "CALL: deepFreeze(document)  # validate å¾Œã«å¿Eš"

        - "IMPORT: runtime/core/uiState.createUiState"
        - "CALL: uiState = createUiState()"

        - "IMPORT: runtime/core/structIndex.buildUUIDIndex"
        - "CALL: indices = buildUUIDIndex(document)"

        - "IMPORT: runtime/core/structIndex.detectFrameRange"
        - "CALL: frameRange = detectFrameRange(document)"

        - "IMPORT: runtime/core/structIndex.buildUUIDIndex"
        - "IMPORT: runtime/core/structIndex.detectFrameRange"
        - "CALL: structIndex = createStructIndexFacade({ indices, document })"

        - "IMPORT: runtime/core/selectionController.createSelectionController"
        - "CALL: selectionController = createSelectionController({ uiState, indices })"

        - "IMPORT: runtime/core/microController.createMicroController"
        - "CALL: microController = createMicroController({ uiState, indices })"

        - "IMPORT: runtime/core/visibilityController.createVisibilityController"
        - "CALL: visibilityController = createVisibilityController({ uiState, document, indices })"

        - "IMPORT: runtime/core/modeController.createModeController"
        - "CALL: modeController = createModeController({ uiState, selectionController, microController, visibilityController })"

        - "IMPORT: runtime/core/viewerSettingsController.createViewerSettingsController"
        - "CALL: viewerSettingsController = createViewerSettingsController({ uiState })"

        - "IMPORT: runtime/core/cameraEngine.createCameraEngine"
        - "CALL: cameraEngine = createCameraEngine({ uiState, modeController })"

        - "IMPORT: runtime/core/cameraController.createCameraController"
        - "CALL: cameraController = createCameraController({ uiState, cameraEngine, structIndex })"

        - "IMPORT: runtime/core/recomputeVisibleSet.createRecomputeVisibleSet"
        - "CALL: { recomputeVisibleSet } = createRecomputeVisibleSet({ uiState, visibilityController, selectionController, microController, modeController })"
        - "CALL: coreRecomputeVisibleSet = recomputeVisibleSet"

        - "IMPORT: runtime/core/frameController.createFrameController"
        - "CALL: frameController = createFrameController({ uiState, frameRange, recomputeVisibleSet: coreRecomputeVisibleSet, modeController })"

        - "IMPORT: runtime/renderer/context.createRendererContext"
        - "CALL: rendererContext = createRendererContext({ canvas })"
        - "CALL: rendererContext.syncDocument(document, indices)"
        - "CALL: metrics = rendererContext.getSceneMetrics()"
        - "CALL: initialState = computeInitialCameraState(metrics)  # local helper (metrics null å¯¾å¿œå«ã‚€)"
        - "CALL: cameraEngine.setState(initialState)"

        - "CALL: core = { uiState, frameController, selectionController, modeController, microController, visibilityController, cameraEngine, cameraController, viewerSettingsController, structIndex, recomputeVisibleSet: coreRecomputeVisibleSet }"
        - "CALL: core.recomputeVisibleSet = coreRecomputeVisibleSet"
        - "CALL: coreRecomputeVisibleSet()"

        - "IMPORT: runtime/viewerHub.createViewerHub"
        - "CALL: hub = createViewerHub({ core, renderer: rendererContext })"

        # --- bootstrapViewerFromUrlEEetchâ†’jsonâ†’bootstrapViewerEE--
        - "CALL: res = await fetch(url)"
        - "CALL: if (!res.ok) throw new Error(...)"
        - "CALL: document = await res.json()"
        - "CALL: options2 = normalizeBootstrapOptionsForFromUrl(options)  # local helper (strictValidate default=true)"

        - "CALL: # normalizeBootstrapOptionsForFromUrl ã®æ—¢å®E { strictValidate:true, validateRefIntegrity:false, devBootLog:false }"

        - "CALL: hub = bootstrapViewer(canvasOrId, document, options2)"

      called_by:
        - "HostEEstro / HTML å´ã®èµ·å‹•ã‚³ãƒ¼ãƒE/ viewerDevHarnessEE
      constraints:
        - "æç”»ãƒ«ãƒ¼ãƒ—ï¼EequestAnimationFrameE‰ãEæŒãŸãªãE€‚hub.start ã«ä»»ã›ã‚‹"
        - "ui/* ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚Eimport ã—ã¦ã¯ãªã‚‰ãªãE
        - "3DSS ãEAJV ã§ NG ã®å ´åˆãE hub ã‚’ç”Ÿæˆã›ãEError ã‚’æŠ•ã’ã‚‹"
        - "3DSS document ã¯ deepFreeze æ¸ˆã¿ immutable ã¨ã¿ãªãE
        - "æ¨å¥¨: Host ã¯ strict validation æ¸ˆã¿ doc ã‚’æ¸¡ã™ã€E
        - "bootstrapViewer ã¯ validate3DSS ã‚E**å¸¸ã«** å®Ÿè¡Œã™ã‚‹ï¼EGãªã‚EthrowE‰ã€E
        - "validateRefIntegrity ã¯ options.strictValidate=true ã¾ãŸãE options.validateRefIntegrity=true ã®ã¨ããEã¿å®Ÿè¡Œã™ã‚‹ã€E
        - "PointerInput / KeyboardInput ã¯æ§‹ç¯‰ã—ãªãE¼ˆåEåŠ›ç³»ã¯ Host / dev harness ãEnew ã™ã‚‹EE
        - "ä»•æ§˜ãƒ†ã‚­ã‚¹ãƒˆã«å¤–éƒ¨ãƒEEãƒ«/URLEˆä¾E chatgpt/codex ç­‰ï¼‰ã‚’æ··å…¥ã•ã›ãªãE¼ˆè¦ç¯Eƒ…å ±ã®ã¿E‰ã€E
        - "getSceneMetrics() ãEnull ã‚’è¿”ã—ã¦ã‚‚èµ·å‹•ä¸èEã«ã—ãªãE¼ˆè¦å®šãE fallback ã§åˆæœŸ cameraState ã‚’ç¢ºå®šã™ã‚‹ï¼E
        - "canvasOrId ãŒä¸æ­£Eˆè¦‹ã¤ã‹ã‚‰ãªãE/ canvas ã§ãªãE¼‰ãªã‚Ethrow"
        - "options æœªæŒE®šãE {} æ‰±ãE¼Eormalize ã§è£œã†EE

    # =========================
    # 2.2 hub
    # =========================
    - name: runtime/viewerHub.js
      layer: hub
      responsibility:
        - "core ã¨ renderer ã‚’æŸã­ã¦ã€UI ã«å¯¾ã—ã¦ hub.core.* API ã‚’æä¾›ã™ã‚E
        - "render loopEEub.start / hub.stopE‰ã‚’ 1 ç®E‰€ã§ç®¡çE™ã‚E
        - "UI ã‹ã‚‰ã®å‘¼ã³å‡ºã—ãEã™ã¹ã¦ hub.core.* / hub.pickObjectAt / hub.viewerSettings.* ã«çµ±ä¸€ã™ã‚‹"
        - "viewport/canvas ã‚µã‚¤ã‚ºå¤‰æ›´ã‚Ehub.resize(width,height) ã§å—ã‘ã€renderer.resize ã«å§”è­²ã™ã‚‹"
      exports:
        - name: createViewerHub
          signature: "({ core, renderer }) â†Ehub"
        - name: ViewerHub
          fields:
            - name: start
              signature: "() â†Evoid"
              description: "render loop ã‚’é–‹å§‹ã€‚äºŒé‡ start ã¯ no-opEˆä¾‹å¤–ã«ã—ãªãE¼‰ã€E
            - name: stop
              signature: "() â†Evoid"
              description: "render loop ã‚’åœæ­¢EEAF åœæ­¢ã®ã¿E‰ã€‚WebGL è³EºãEä¿æŒã€‚äºŒé‡ stop ã¯ no-opã€E
            - name: isRunning
              signature: "() â†Eboolean"
              description: "render loop ãŒç¨¼åƒä¸­ã‹ã‚’è¿”ã™ã€E
            - name: dispose
              signature: "() â†Evoid"
              description: |
                stop + renderer.disposeEˆè³Eºè§£æ”¾E‰ã€E
                â€» onXChanged ã® unsubscribe ã¯å‘¼ã³å‡ºã—åEEEI/HostE‰ãŒä¿æŒã—ã¦è§£é™¤ã™ã‚‹ã€‚hub ã¯å‹æ‰‹ã«è³¼èª­ã‚’ä½œã‚‰ãªãE€E
                dispose å¾ŒãE hub ã¯å†åˆ©ç”¨ä¸å¯ã€E
            - name: resize
              signature: "(width:number, height:number) â†Evoid"
              description: |
                Host ãEcanvas ã®è¡¨ç¤ºã‚µã‚¤ã‚ºEESS pxE‰ã‚’è¨ˆç®—ã—ã¦æ¸¡ã™ã€E
                hub ã¯ renderer.resize(width,height) ã«å§”è­²ã™ã‚‹ã€E
                ããEç›´å¾Œã€æœª dispose ã®å ´åˆãE renderer.updateCamera(hub.core.camera.getState()) ã‚E**å¿Eš** å‘¼ã¶ã€E
                dispose å¾ŒãE no-opã€E
            - name: pickObjectAt
              signature: "(ndcX:number, ndcY:number) â†E{uuid:string, kind:'points'|'lines'|'aux', distance:number, point:[number,number,number]} | null"
              description: |
                pick ã¯ renderer ã®ãƒ¬ã‚¤ã‚­ãƒ£ã‚¹ãƒˆçµæœã‚’å—ã‘å–ã‚‹ãŒã€E
                visibilityController.isVisible(uuid) ãEfalse ã®å ´åˆãEå¿Eš null ã¨ã—ã¦è¿”ã™ã€E
                Eˆä¸å¯è¦–è¦ç´ ã¯ UI ã‹ã‚‰é¸æŠã§ããªãE“ã¨ã‚’ä»•æ§˜ã§ä¿è¨¼ã™ã‚‹EE
                dispose å¾ŒãEå¸¸ã« nullEEenderer ã«è§¦ã‚‰ãªãE¼‰ã€E
            - name: viewerSettings
              signature: "ViewerSettingsAPI"
            - name: core
              signature: "ViewerCoreAPI"
      hub_shape:
        core:
          props:
            - name: uiState
              description: "uiState ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãã®ã‚‚ãEEˆæ‰€æœ‰æ¨©ã¯ coreE‰ã€E
            - name: frame
              description: "frameController ã¸ã®å…¬é–‹ãƒ©ãƒEƒ‘EEetActive/getActive/step/next/prev/getRange/startPlayback/stopPlaybackE‰ã€E
            - name: camera
              description: "cameraEngine + cameraController ã¸ã®å…¬é–‹ãƒ©ãƒEƒ‘EEotate/pan/zoom/reset/snapToAxis/focusOn/â€¦E‰ã€E
            - name: mode
              description: "modeController ã¸ã®å…¬é–‹ãƒ©ãƒEƒ‘EEet/get/canEnter/exit/focusE‰ã€E
            - name: micro
              description: "micro mode ã® enter/exit/isActive ã ã‘ã‚’ã¾ã¨ã‚ãŸè–E„ãƒ©ãƒEƒ‘ã€E
            - name: selection
              description: "selectionController ã¸ã®å…¬é–‹ãƒ©ãƒEƒ‘EEelect/clear/getE‰ã€E
            - name: filters
              description: "visibilityController ã® filters ãƒ©ãƒEƒ‘EEetTypeEnabled/getE‰ã€E
            - name: runtime
              description: "uiState.runtime.isFramePlaying / isCameraAuto ã®èª­ã¿å‡ºã—å°‚ç”¨ãƒ©ãƒEƒ‘ã€E
            - name: recomputeVisibleSet
              description: "visibleSet + selection/micro ã®å¾ŒåEçE‚’å†è¨ˆç®—ã™ã‚‹æ­£è¦é–¢æ•°EEore.recomputeVisibleSetE‰ã€‚frameController ã‚Efilters ã‹ã‚‰ã‚‚åŒã˜é–¢æ•°ãŒå‘¼ã°ã‚Œã‚‹ã€E
            - name: structIndex
              description: "read-only æ¤œç´¢APIEEuildUUIDIndex ã®çµæœMapE‰ã€‚uuidâ†Ekind,item) ã‚’å¼•ã‘ã‚‹ã€E
        viewerSettings_api:
          methods:
            - name: setWorldAxesVisible
              signature: "(visible:boolean) â†Evoid"
              calls:
                - "DI: core.viewerSettingsController.setWorldAxesVisible"
                - "CALL: core.viewerSettingsController.setWorldAxesVisible(visible)"
            - name: toggleWorldAxes
              signature: "() â†Evoid"
              calls:
               - "DI: core.viewerSettingsController.toggleWorldAxes"
               - "CALL: core.viewerSettingsController.toggleWorldAxes()"
            - name: getWorldAxesVisible
              signature: "() â†Eboolean"
              calls:
                - "DI: core.viewerSettingsController.getWorldAxesVisible"
                - "CALL: core.viewerSettingsController.getWorldAxesVisible()"
            - name: onWorldAxesChanged
              signature: "(listener:(visible:boolean) => void) â†E() => void"
              calls:
                - "DI: core.viewerSettingsController.onWorldAxesChanged"
                - "CALL: core.viewerSettingsController.onWorldAxesChanged(listener)"
            - name: setLineWidthMode
              signature: "(mode:'auto'|'fixed'|'adaptive') â†Evoid"
              calls:
                - "DI: core.viewerSettingsController.setLineWidthMode"
                - "CALL: core.viewerSettingsController.setLineWidthMode(mode)"
            - name: getLineWidthMode
              signature: "() â†E'auto'|'fixed'|'adaptive'"
              calls:
                - "DI: core.viewerSettingsController.getLineWidthMode"
                - "CALL: core.viewerSettingsController.getLineWidthMode()"
            - name: onLineWidthModeChanged
              signature: "(listener:(mode:'auto'|'fixed'|'adaptive') => void) â†E() => void"
              calls:
                - "DI: core.viewerSettingsController.onLineWidthModeChanged"
                - "CALL: core.viewerSettingsController.onLineWidthModeChanged(listener)"
            - name: setMicroFXProfile
              signature: "(profile:'weak'|'normal'|'strong') â†Evoid"
              calls:
                - "DI: core.viewerSettingsController.setMicroFXProfile"
                - "CALL: core.viewerSettingsController.setMicroFXProfile(profile)"
            - name: getMicroFXProfile
              signature: "() â†E'weak'|'normal'|'strong'"
              calls:
                - "DI: core.viewerSettingsController.getMicroFXProfile"
                - "CALL: core.viewerSettingsController.getMicroFXProfile()"
            - name: onMicroFXProfileChanged
              signature: "(listener:(profile:'weak'|'normal'|'strong') => void) â†E() => void"
              calls:
                - "DI: core.viewerSettingsController.onMicroFXProfileChanged"
                - "CALL: core.viewerSettingsController.onMicroFXProfileChanged(listener)"
          notes:
            - "viewerSettings ã® canonical state ã¯ core(uiState.viewerSettings)ã€‚hub ã¯ core.viewerSettingsController ã¸å§”è­²ã™ã‚‹ã ã‘ã€E
            - "åæ˜ ã¯ render loop å†E§ renderer.applyViewerSettings(uiState.viewerSettings) ãŒè¡Œã†EEIâ†’renderer ç›´çµãEç¦æ­¢ã‚’ç¶­æŒE¼‰ã€E
            - "viewerSettings.worldAxesVisible ã¯ viewer ã®ãƒ¯ãƒ¼ãƒ«ãƒ‰è»¸EEUD/ã‚ªãƒ¼ãƒãEãƒ¬ã‚¤E‰ãEè¡¨ç¤ºã€‚filters.setAuxModuleEnabled('axis',...) ã¯ 3DSS å´ aux ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å¯è¦–ã§åˆ¥ç‰©ã€E
      calls:
        - "DI: core.uiState  # read-only"
        - "DI: core.cameraEngine.update"

        - "DI: core.frameController.updatePlayback"

        - "DI: core.microController.refresh"
        - "DI: core.cameraEngine.getState  # render loop / resize ã§å‚çE"
        - "DI: core.visibilityController.isVisible  # pick ã®å¢E•Œå¼·åˆ¶"
        - "DI: renderer.applyFrame"
        - "DI: renderer.applyViewerSettings"
        - "DI: renderer.applyMicroFX"
        - "DI: renderer.updateCamera"
        - "DI: renderer.applySelection"
        - "DI: renderer.pickObjectAt"
        - "DI: renderer.render"
        - "DI: renderer.resize"
        - "DI: renderer.dispose"
      called_by:
        - "ui/pointerInput.js"
        - "ui/keyboardInput.js"
        - "ui/gizmo.js"
        - "ui/picker.js"
        - "ui/timeline.jsEˆå°E¥ã®ç‹¬ç«‹ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ UI ã‚’æƒ³å®šï¼E
        - "viewerDevHarness.jsEEev viewer å°‚ç”¨ UIEE
      constraints:
        - "frame/mode/micro/selection ã®åˆ¤å®šãƒ­ã‚¸ãƒE‚¯ã‚Ehub ã«æ›¸ãE¦ã¯ãªã‚‰ãªãE€‚å¿Eš core.* ã«å§”è­²ã™ã‚‹"
        - "hub ã¯å¼•æ•°ã®æ­£è¦åŒ–Eˆä¾E uuid vs vec ã®è§£æ±ºE‰ã™ã‚‰åŸå‰Ecore å´ã¸å¯E›ã‚‹ï¼EameraController ç­‰ï¼E
        - "ä¾‹å¤E UI å®‰åEæ€§ã®ä¸å¤‰æ¡ä»¶Eˆä¸å¯è¦–ãE pick ã§ããªãE­‰ï¼‰ãEå¢E•Œå¼·åˆ¶ã¯ hub å´ã§è¡Œã£ã¦ã‚ˆã„"
        - "three.js ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚„ material ã‚’ç›´æ¥è§¦ã£ã¦ã¯ãªã‚‰ãªãE
        - "core/* ã‚Erenderer/* ã‚Eimport ã—ã¦ã¯ãªã‚‰ãªãE¼E core, renderer } ã‚EDI ã§å—ã‘å–ã£ã¦å‘¼ã¶EE
        - "3DSS document ã‚’ç›´æ¥å¤‰æ›´ã—ã¦ã¯ãªã‚‰ãªãE
        - "hub.core.uiState ã¯å‚çEå°‚ç”¨ã¨ã—ã¦å…¬é–‹ã™ã‚‹ã€‚UI/Host ã¯ uiState ã‚’ç›´æ¥ mutate ã—ã¦ã¯ãªã‚‰ãªãE¼ˆæ›´æ–°ã¯å¿Eš hub.core.* API çµŒç”±E‰ã€E
        - "viewerSettings ã¯ core(uiState.viewerSettings) ãEcanonicalã€‚hub/viewerSettings API ã¯ core.viewerSettingsController ã«å§”è­²ã—ã€renderer ã¸ç›´æ¥è§¦ã‚Œã¦ã¯ãªã‚‰ãªãE¼ˆåæ˜ ã¯ render loop ã® renderer.applyViewerSettings ã«ä¸€æœ¬åŒ–ï¼‰ã€E
        - "hub ã¯ uiState.visibleSet / uiState.runtime.isFramePlaying ã‚’ç›´æ¥æ›¸ãæ›ãˆãªãE¼Eingle-writer éµå®ˆï¼E
        - "frame/selection/filter/mode ã®çµæœç¢ºå®šãE core.* ã‚’å‘¼ã¶ã“ã¨ã§é”æEã™ã‚‹"

      core_api:
        structIndex:
          - name: getCenter
            signature: "(uuid:string) â†E[number,number,number] | null"
            calls:
              - "DI: core.structIndex.getCenter"
              - "CALL: core.structIndex.uuidToItem.get(uuid)"
          - name: getKind
            signature: "(uuid:string) â†E'points'|'lines'|'aux'|null"
            calls:
              - "DI: core.structIndex.getKind"
              - "CALL: core.structIndex.getKind(uuid)"
          - name: getItem
            signature: "(uuid:string) â†Eobject|null"
            calls:
              - "DI: core.structIndex.getItem"
              - "CALL: core.structIndex.getItem(uuid)"
        frame:
          - name: setActive
            signature: "(frame:number|null) â†Evoid"
            calls:
              - "DI: core.frameController.setActive"
              - "CALL: core.frameController.setActive(frame)"
          - name: getActive
            signature: "() â†Enumber|null"
            calls:
              - "DI: core.frameController.getActive"
              - "CALL: core.frameController.getActive()"
          - name: step
            signature: "(delta:number) â†Evoid"
            calls:
              - "DI: core.frameController.step"
              - "CALL: core.frameController.step(delta)"
          - name: next
            impl_note: "step(+1) ã®è–E„ãƒ©ãƒEƒ‘"
            calls:
              - "CALL: step(+1)"
          - name: prev
            impl_note: "step(-1) ã®è–E„ãƒ©ãƒEƒ‘"
            calls:
              - "CALL: step(-1)"
          - name: getRange
            signature: "() â†E{min:number,max:number} | null"
            calls:
              - "DI: core.frameController.getRange"
              - "CALL: core.frameController.getRange()"
          - name: startPlayback
            signature: "() â†Evoid"
            calls:
              - "DI: core.frameController.startPlayback"
              - "CALL: core.frameController.startPlayback()"
            method_notes:
              - "çµæœã¨ã—ã¦ uiState.runtime.isFramePlaying ãEtrue ã«ãªã‚‹ï¼ˆæ›´æ–°ã¯ core.frameController å´EE
              - "macro ã¸æˆ»ã™ãEã¯ core.frameController.startPlayback ã®è²¬å‹E
          - name: stopPlayback
            signature: "() â†Evoid"
            calls:
              - "DI: core.frameController.stopPlayback"
              - "CALL: core.frameController.stopPlayback()"
            method_notes:
              - "çµæœã¨ã—ã¦ uiState.runtime.isFramePlaying ãEfalse ã«ãªã‚‹ï¼ˆæ›´æ–°ã¯ core.frameController å´EE

        selection:
          - name: select
            signature: "(uuid:string, kind?:'points'|'lines'|'aux') â†E{kind:'points'|'lines'|'aux', uuid:string}|null"
            notes:
              - "visibilityController.isVisible(uuid) ãEfalse ã®å ´åˆãE null ã‚’è¿”ã—ã€core.selectionController.select ã‚’å‘¼ã°ãªãE
            calls:
              - "DI: core.visibilityController.isVisible"
              - "CALL: if (!core.visibilityController.isVisible(uuid)) return null"
              - "DI: core.selectionController.select"
              - "CALL: return core.selectionController.select(uuid, kind?)"

          - name: clear
            signature: "() â†Evoid"
            calls:
              - "DI: core.selectionController.clear"
              - "CALL: core.selectionController.clear()"
          - name: get
            signature: "() â†E{kind:'points'|'lines'|'aux', uuid:string}|null"
            calls:
              - "DI: core.selectionController.get"
              - "CALL: core.selectionController.get()"

        camera:
          - name: rotate
            signature: "(dTheta:number, dPhi:number) â†Evoid"
            calls:
              - "DI: core.cameraEngine.rotate"
              - "CALL: core.cameraEngine.rotate(dTheta, dPhi)"
          - name: pan
            signature: "(dx:number, dy:number) â†Evoid"
            calls:
              - "DI: core.cameraEngine.pan"
              - "CALL: core.cameraEngine.pan(dx, dy)"
          - name: zoom
            signature: "(delta:number) â†Evoid"
            calls:
              - "DI: core.cameraEngine.zoom"
              - "CALL: core.cameraEngine.zoom(delta)"
          - name: reset
            signature: "() â†Evoid"
            calls:
              - "DI: core.cameraEngine.reset"
              - "CALL: core.cameraEngine.reset()"
          - name: snapToAxis
            signature: "(axis:'x'|'y'|'z') â†Evoid"
            calls:
              - "DI: core.cameraEngine.snapToAxis"
              - "CALL: core.cameraEngine.snapToAxis(axis)"

          - name: focusOn
            signature: "(target:[number,number,number] | uuid:string, opts?) â†EcameraState"
            impl_note: |
              focusOn ã¯ cameraState ã ã‘ã‚’æ›´æ–°ã™ã‚‹EEode ã¯å¤‰æ›´ã—ãªãE¼‰ã€E
              uuid è§£æ±ºã‚Efocus state ç®—åEã¯ core.cameraController ãŒæ‹…ãE€E
              micro ä¾µå…¥ã¯ UI ãEmode.focus / micro.enter ã‚’åˆ¥é€”å‘¼ã¶ã€E
            calls:
              - "DI: core.cameraController.focusOn"
              - "CALL: core.cameraController.focusOn(target, opts?)"
          - name: setFOV
            signature: "(value:number) â†Evoid"
            calls:
              - "DI: core.cameraEngine.setFOV"
              - "CALL: core.cameraEngine.setFOV(value)"
          - name: setViewByName
            signature: "(name:string) â†Evoid"
            calls:
              - "DI: core.cameraEngine.setViewByName"
              - "CALL: core.cameraEngine.setViewByName(name)"
          - name: setViewPreset
            signature: "(index:number, opts?) â†Evoid"
            calls:
              - "DI: core.cameraEngine.setViewPreset"
              - "CALL: core.cameraEngine.setViewPreset(index, opts?)"
          - name: getViewPresetIndex
            signature: "() â†Enumber"
            calls:
              - "DI: core.cameraEngine.getViewPresetIndex"
              - "CALL: core.cameraEngine.getViewPresetIndex()"

          - name: setState
            signature: "(partialState:object) â†Evoid"
            calls:
              - "DI: core.cameraEngine.setState"
              - "CALL: core.cameraEngine.setState(partialState)"
          - name: getState
            signature: "() â†EcameraState"
            calls:
              - "DI: core.cameraEngine.getState"
              - "CALL: core.cameraEngine.getState()"
          - name: startAutoOrbit
            signature: "(opts?) â†Evoid"
            calls:
              - "DI: core.camera.startAutoOrbit"
              - "CALL: core.camera.startAutoOrbit(opts?)"
          - name: updateAutoOrbitSettings
            signature: "(opts?) â†Evoid"
            calls:
              - "DI: core.camera.updateAutoOrbitSettings"
              - "CALL: core.camera.updateAutoOrbitSettings(opts?)"
          - name: stopAutoOrbit
            signature: "() â†Evoid"
            calls:
              - "DI: core.camera.stopAutoOrbit"
              - "CALL: core.camera.stopAutoOrbit()"
        mode:
          - name: set
            signature: "(mode:'macro'|'micro', uuid?:string) â†E'macro'|'micro'"
            calls:
              - "DI: core.modeController.set"
              - "CALL: core.modeController.set(mode, uuid?)"
          - name: get
            signature: "() â†E'macro'|'micro'"
            calls:
              - "DI: core.modeController.get"
              - "CALL: core.modeController.get()"
          - name: canEnter
            signature: "(uuid:string) â†Eboolean"
            calls:
              - "DI: core.modeController.canEnter"
              - "CALL: core.modeController.canEnter(uuid)"
            rules:
              - "uiState.runtime ã‚’å‚ç…§ã™ã‚‹"

          - name: exit
            signature: "() â†E'macro'|'micro'"
            calls:
              - "DI: core.modeController.exit"
              - "CALL: core.modeController.exit()"

          - name: focus
            signature: "(uuid:string) â†E'macro'|'micro'"
            calls:
              - "DI: core.modeController.focus"
              - "CALL: core.modeController.focus(uuid)"

        micro:
          - name: enter
            signature: "(uuid:string) â†E'macro'|'micro'"
            calls:
              - "DI: core.modeController.set"
              - "CALL: core.modeController.set('micro', uuid)"
            method_notes:
             - "è¦ç¯E canEnter=false ã®å ´åˆãE no-opEˆçŠ¶æ…‹å¤‰æ›´ãªã—ï¼‰ã§ç¾åœ¨ã® mode ã‚’è¿”ã™ã€‚ä¾‹å¤–ãEç¦æ­¢ã€E

          - name: exit
            signature: "() â†E'macro'"
            calls:
              - "DI: core.modeController.set"
              - "CALL: core.modeController.set('macro')"
          - name: isActive
            signature: "() â†Eboolean"
            impl_note: "uiState.mode === 'micro' ã‚’è¦‹ã‚‹ã ã‘ï¼Eore æ‰€æœ‰ï¼E

        filters:
          - name: setTypeEnabled
            signature: "(kind:'points'|'lines'|'aux', enabled:boolean) â†Evoid"
            calls:
              - "DI: core.visibilityController.setTypeEnabled"
              - "CALL: core.visibilityController.setTypeEnabled(kind, enabled)"
              - "DI: core.recomputeVisibleSet"
              - "CALL: core.recomputeVisibleSet()"

          - name: setAuxModuleEnabled
            signature: "(module:'grid'|'axis'|'plate'|'shell'|'hud'|'extension', enabled:boolean) â†Evoid"
            calls:
              - "DI: core.visibilityController.setAuxModuleEnabled"
              - "CALL: core.visibilityController.setAuxModuleEnabled(module, enabled)"
              - "DI: core.recomputeVisibleSet"
              - "CALL: core.recomputeVisibleSet()"

          - name: get
            signature: "() â†EFiltersState"
            calls:
              - "DI: core.visibilityController.get"
              - "CALL: core.visibilityController.get()"

        runtime:
          - name: isFramePlaying
            signature: "() â†Eboolean"
            impl_note: "uiState.runtime.isFramePlaying ã‚’è¿”ã™ã€‚core.frame.startPlayback/stopPlayback å´ã§ãƒ•ãƒ©ã‚°ã‚’æ›´æ–°ã€E

          - name: isCameraAuto
            signature: "() â†Eboolean"
            impl_note: "uiState.runtime.isCameraAuto ã‚’è¿”ã™EEutoOrbit ä¸­ trueE‰ã€E

        # core ç›´ä¸‹ã«é–¢æ•°ã¨ã—ã¦ç”Ÿã‚„ã™ï¼Eub.core.recomputeVisibleSet()EE
        recomputeVisibleSet:
          - name: recomputeVisibleSet
            signature: "() â†Evoid"
            calls:
              - "DI: core.recomputeVisibleSet"
              - "CALL: core.recomputeVisibleSet()"
    # =========================
    # 2.3 core
    # =========================
      layer: core
      responsibility:
        - "indices ã‚’åEåŒE—ãEread-only æ¤œç´¢APIEEub ã¸æ¸¡ã™ï¼E
      exports:
        - name: createStructIndexFacade
          signature: "({ indices, document }) â†EstructIndex"
      structIndex:
        methods:
          - getCenter(uuid:string): [number,number,number] | null
          - getKind(uuid:string): 'points'|'lines'|'aux'|null
          - getItem(uuid:string): object|null


    - name: runtime/core/validator.js
      layer: core
      responsibility:
        - "AJV strict validator ã‚’åEæœŸåŒ–ã—ã€EDSS ã¨å‚çEæ•´åˆæ€§ã‚’æ¤œè¨¼ã™ã‚‹"
      exports:
        - name: initValidator
          signature: "() â†E{ validate3DSS, validateRefIntegrity }"
      constraints:
        - "doc ã‚’æ›¸ãæ›ãˆãªãE

    - name: runtime/core/deepFreeze.js
      layer: core
      responsibility:
        - "document ã‚Edeep freeze ã—ã¦ immutable æ‰±ãE«ã™ã‚‹"
      exports:
        - name: deepFreeze
          signature: "(obj) â†Eobj"
      constraints:
        - "Set/Map ç­Eruntime state ã«ã¯ä½¿ã‚ãªãE¼Eocument å°‚ç”¨EE

    - name: runtime/core/viewerSettingsController.js
      layer: core
      responsibility:
        - "uiState.viewerSettings ã®åˆæœŸå€¤ã‚’ç¢ºå®šã—ã€viewerSettings API ã‚’æä¾›ã™ã‚‹ï¼Etate æ‰€æœ‰ãE coreEE
        - "set*/toggle* ã§ uiState.viewerSettings ã‚’æ›´æ–°ã—ã€ç™»éŒ²æ¸ˆã¿ listener ã‚’é€šçŸ¥ã™ã‚‹"
        - "renderer ã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã¯ã—ãªãE¼ˆåæ˜ ã¯ hub ã® render loop ãEapplyViewerSettings ã§è¡Œã†EE
      exports:
        - name: createViewerSettingsController
          returns: viewerSettingsController
          signature: "({ uiState }) â†EviewerSettingsController"
      di_injected:
        - name: uiState
          source: "bootstrapViewer (createUiState result)"
      viewerSettingsController:
        methods:
          - setWorldAxesVisible(visible:boolean)
          - toggleWorldAxes()
          - getWorldAxesVisible(): boolean
          - onWorldAxesChanged(listener:(visible:boolean)=>void): () => void
          - setLineWidthMode(mode:'auto'|'fixed'|'adaptive')
          - getLineWidthMode(): 'auto'|'fixed'|'adaptive'
          - onLineWidthModeChanged(listener:(mode:'auto'|'fixed'|'adaptive')=>void): () => void
          - setMicroFXProfile(profile:'weak'|'normal'|'strong')
          - getMicroFXProfile(): 'weak'|'normal'|'strong'
          - onMicroFXProfileChanged(listener:(profile:'weak'|'normal'|'strong')=>void): () => void
      defaults:
        - "worldAxesVisible: true"
        - "lineWidthMode: 'auto'"
        - "microFXProfile: 'normal'"
      state:
        - "uiState.viewerSettings ã‚Ecanonical ã¨ã™ã‚‹"
        - "listeners ã¯ runtime-onlyEEiState ã«ã¯ä¿æŒã—ãªãE¼E
        - "onXChanged ã¯ unsubscribe é–¢æ•°ã‚’è¿”ã™EˆåŒä¸€ listener ã®äºŒé‡ç™»éŒ²ã‚’é˜²ããEã¯å®Ÿè£E»»æ„ã€‚ãŸã ã—è§£é™¤ã§ãã‚‹ã“ã¨ã¯å¿E ˆï¼‰ã€E
      constraints:
        - "viewerSettingsController ã¯ renderer ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¯ãªã‚‰ãªãE¼EetLineWidthMode ç­‰ã§ renderer.setXxx ã‚’å‘¼ã°ãªãE¼‰ã€‚åæ˜ ã¯ hub ã® render loop ãErenderer.applyViewerSettings(uiState.viewerSettings) ã§è¡Œã†ã€E
        - "setMicroFXProfile(profile) ã¯ uiState.viewerSettings.microFXProfile ã®ã¿æ›´æ–°ã™ã‚‹ã€‚lineWidthMode ç­‰ãEåˆ¥è¨­å®šã‚’æ›¸ãæ›ãˆã‚‹ã®ã¯ç¦æ­¢ã€‚renderer.setXxx ã‚’å‘¼ã¶ã®ã‚‚ç¦æ­¢Eˆåæ˜ ã¯ hub render loop ã® applyViewerSettings ã«ä¸€æœ¬åŒ–ï¼‰ã€E

    - name: runtime/core/cameraEngine.js
      layer: core
      calls:
        - "DI: modeController.set   # startAutoOrbit ã§ 'macro' å¼·åˆ¶"
      responsibility:
        - "uiState.cameraState ã‚’æ›´æ–°/å‚çEã—ã€renderer ã«æ¸¡ã™ãŸã‚ãEçŠ¶æ…‹ã‚’ä½œã‚‹"
        - "AutoOrbit ã‚’å«ã‚€ã‚«ãƒ¡ãƒ©çŠ¶æ…‹ãEæ›´æ–°EEuntime/mode ã¯è§¦ã‚‰ãªãE¼E

      exports:
        - name: createCameraEngine
          returns: cameraEngine
          signature: "({ uiState, modeController }) â†EcameraEngine"
      di_injected:
        - name: uiState
          source: "bootstrapViewer (createUiState result)"
        - name: modeController
          source: "bootstrapViewer (createModeController result)"
      cameraEngine:
        methods:
          - rotate(dTheta:number, dPhi:number)
          - pan(dx:number, dy:number)
          - zoom(delta:number)
          - reset()
          - snapToAxis(axis:'x'|'y'|'z')
          - setState(partialState:object)
          - getState(): cameraState
          - setFOV(value:number)
          - update(dtSeconds:number)
          - setViewByName(name:string)
          - setViewPreset(index:number, opts?)
          - getViewPresetIndex(): number
          - computeFocusState(target:[number,number,number], opts?): cameraState
          - startAutoOrbit(opts?)
          - updateAutoOrbitSettings(opts?)
          - stopAutoOrbit()
      called_by:
        - "runtime/viewerHub.jsEEore.camera.* çµŒç”±EE
        - "core/modeController.jsEˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹é·ç§»æ™‚ã«å‚çEã™ã‚‹å ´åˆãŒã‚ã‚Œã°EE
      state:
        - "uiState.cameraState ã‚Ecanonical ã¨ã—ã€cameraEngine ã¯ãã‚Œã‚’æ›´æ–°/å‚çEã™ã‚‹EˆåEéƒ¨ã«åˆ¥ã‚³ãƒ”ãEã¯æŒãŸãªãE¼E
        - "three.js ã® Camera ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ renderer ãŒä¿æŒã—ã€ã“ã® state ã‚’åæ˜ ã™ã‚‹ã ãE

    - name: runtime/core/cameraController.js
      layer: core
      responsibility:
        - "hub ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ camera faÃ§adeEEotate/pan/zoom/reset/preset/autoOrbit ç­‰ï¼‰ã‚’æä¾E
        - "uiState.runtime.isCameraAuto ã‚’ã“ã®å±¤ã ã‘ã§ç®¡çE™ã‚‹ï¼Eingle-writerEE
        - "startAutoOrbit ã¯ macro å¼·åˆ¶EEicro ä¸­ auto ç¦æ­¢ã®è¦ç¯E¼E
      exports:
        - name: createCameraController
          returns: cameraController
          signature: "({ uiState, cameraEngine, structIndex }) â†EcameraController"
      di_injected:
        - name: uiState
          source: "bootstrapViewer (createUiState result)"
        - name: cameraEngine
          source: "bootstrapViewer (createCameraEngine result)"
        - name: structIndex
          source: "bootstrapViewer (createStructIndexFacade result)"
      cameraController:
        methods:
          - focusOn(target:[number,number,number] | uuid:string, opts?): cameraState
      calls:
        - "DI: structIndex.getCenter"
        - "DI: cameraEngine.computeFocusState"
        - "DI: cameraEngine.setState"
      constraints:
        - "three.js ã‚Eimport ã—ã¦ã¯ãªã‚‰ãªãE
        - "renderer ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¯ãªã‚‰ãªãE
      called_by:
        - "runtime/viewerHub.jsEEore.camera.focusOn çµŒç”±EE

    - name: runtime/core/frameController.js
      layer: core
      responsibility:
        - "active frame ã‚’ç®¡çE™ã‚E
        - "frameRange ã‚’æ±ºå®šã—ã€uiState.frame ã«ä¿æŒã™ã‚‹"
        - "frameRange ã¯ structIndex.detectFrameRange() ã‚’ä½¿ãE€v1.1.0 ã® frames:number|number[] ã‚’è§£é‡ˆã—ã¦ç®—åEã™ã‚‹"
        - "åˆæœŸ activeFrame ã¯æ¬¡ã§çµ±ä¸€ã™ã‚‹:"
        - "  - frameRange === null ã®ã¨ãE activeFrame = nullEˆãƒ•ãƒ¬ãƒ¼ãƒ çµã‚Šè¾¼ã¿ç„¡ã—ï¼E
        - "  - frameRange !== null ã®ã¨ãE activeFrame = frameRange.minEˆæœ€åˆãEãƒ•ãƒ¬ãƒ¼ãƒ ã‹ã‚‰é–‹å§‹ï¼E
        - "startPlayback/stopPlayback ã§ uiState.runtime.isFramePlaying ã‚’æ›´æ–°ã™ã‚‹"
        - "startPlayback ã¯ modeController.set('macro') ã‚’å¿Ešå‘¼ã¶"
      constraints:
        - "uiState.runtime.isFramePlaying ã‚’ç›´æ¥ä»£å…¥ã—ã¦ã‚ˆã„ã®ã¯ frameController ã®ã¿EEingle-writerEE
      exports:
        - name: createFrameController
          returns: frameController
          signature: "({ uiState, frameRange, recomputeVisibleSet, modeController }) â†EframeController"
      di_injected:
        - name: uiState
          source: "bootstrapViewer (createUiState result)"
        - name: frameRange
          source: "bootstrapViewer (structIndex.detectFrameRange result)"
        - name: recomputeVisibleSet
          source: "bootstrapViewer (core.recomputeVisibleSet)"
        - name: modeController
          source: "bootstrapViewer (createModeController result)"

      frameController:
        methods:
          - setActive(frame:number|null)
          - getActive(): number|null
          - step(delta:number)
          - getRange(): {min:number,max:number} | null
          - startPlayback(): void
          - stopPlayback(): void


          - updatePlayback(dtSeconds:number): void

      playback_policy:
        - "startPlayback(): uiState.runtime.isFramePlaying = true; accumulator ã‚’ãƒªã‚»ãƒEƒˆ"
        - "stopPlayback(): uiState.runtime.isFramePlaying = false; accumulator ã‚’ãƒªã‚»ãƒEƒˆ"
        - "updatePlayback(dtSeconds): isFramePlaying===false ãªã‚Eno-opã€‚dt ã‚’ç©ç®—ã—ã¦å¿E¦ã‚¹ãƒEƒƒãƒ—ã ãEframe ã‚’é€²ã‚ã€ä¸Šé™åˆ°é”ã§ stopPlayback()"
        - "frame ã‚’é€²ã‚ã‚‹çµŒè·¯ã¯ setActive/å†Eƒ¨ setActive ã‚’é€šã—ã€çµæœã¨ã—ã¦ recomputeVisibleSet ã®æ­£è¦ãƒ«ãƒ¼ãƒˆãŒç¶­æŒã•ã‚Œã‚‹"
 
      internal_state:

        - "playbackAccumulatorSeconds: number  # frameController å†Eƒ¨ã«ã®ã¿ä¿æŒEEiState ã«ã¯ä¿æŒã—ãªãE¼E
        - "playbackStepSeconds: number  # æ—¢å®E1/30Eˆå®Ÿè£Eˆ¤æ–­ã§å¯ã€‚ä»•æ§˜ãEã€ä¸€å®šé–“éš”ã§ step ã™ã‚‹ã€ã‚’è¦æ±‚ï¼E

      method_notes:
        - "step(delta):"
        - "  - frameRange === null ã®ã¨ãEno-op"
        - "  - activeFrame === null ã®ã¨ãE"
        - "      delta > 0 â†EsetActive(frameRange.min)"
        - "      delta < 0 â†EsetActive(frameRange.max)"
        - "      delta = 0 â†Eno-op"
        - "  activeFrame !== null ã®ã¨ããE **å¿Eš clamp**EEin/max ã§æ‰“ã¡æ­¢ã‚E¼E
        - "setActive/step ã¯ activeFrame æ›´æ–°å¾Œã« recomputeVisibleSet() ã‚’å¿Ešå‘¼ã¶EErameå¤‰æ›´å¾ŒãEå”¯ä¸€ã®æ­£è¦ãƒ«ãƒ¼ãƒˆï¼E
      calls:
        - "DI: recomputeVisibleSet"
        - "CALL: recomputeVisibleSet()"
        - "DI: modeController.set"

        - "CALL: # updatePlayback ã¯ setActive/step ã‚’åEéƒ¨åˆ©ç”¨ã—ã¦é€²è¡Œã•ã›ã‚‹EEecomputeVisibleSet ã‚’å¿Ešé€šã™EE
 
      called_by:
        - "runtime/viewerHub.jsEEore.frame.* çµŒç”±EE
      state:
        - "activeFrame ã¨ frameRange ã‚EuiState.frame ã«ä¿æŒã™ã‚‹EEurrent:number|null, range:{min,max}|nullE‰ã€E

    - name: runtime/core/selectionController.js
      layer: core
      responsibility:
        - "ç¾åœ¨ã®é¸æŠè¦ç´ EEind, uuidE‰ãŠã‚ˆãE hover çŠ¶æ…‹ã‚’ç®¡çE™ã‚E
      exports:
        - name: createSelectionController
          returns: selectionController
          signature: "({ uiState, indices }) â†EselectionController"
      di_injected:
        - name: uiState
          source: "bootstrapViewer (createUiState result)"
        - name: indices
          source: "bootstrapViewer (structIndex.buildUUIDIndex result)"
      selectionController:
        methods:
          - select(uuid:string, kind?:'points'|'lines'|'aux'): {kind:'points'|'lines'|'aux', uuid:string} | null
          - clear()
          - get(): {kind:'points'|'lines'|'aux', uuid:string} | null
          - setHover(payload:{uuid:string|null,kind:'points'|'lines'|'aux'|null})
          - getHover(): {kind:'points'|'lines'|'aux'|null, uuid:string|null}
        method_notes:
          - "kind æœªæŒE®šãEå ´åˆãE indices ã‹ã‚‰æ¨å®šã™ã‚‹ã€‚uuid ä¸æEã€ã¾ãŸãE kind ä¸ä¸€è‡´ã®å ´åˆãE null ã‚’è¿”ã™ã€E
        calls: []
        called_by:
          - "runtime/viewerHub.jsEEore.selection.*EE
          - "core/modeController.js"
        state:
          - "uiState.selection ã‚’æ›´æ–°ã™ã‚‹EEelectionState|nullE‰ã€‚null ã¯æœªé¸æŠã€E
          - "uiState.hover ã‚’æ›´æ–°ã™ã‚‹EEoverState|nullE‰ã€‚null ã¯ hover ç„¡ã—ï¼Eover æ©ŸèEæ¡ç”¨æ™‚ï¼‰ã€E

    - name: runtime/core/modeController.js
      layer: core
      responsibility:
        - "modeEEacro/microE‰ã¨ micro ä¾µå…¥æ¡ä»¶ã®å„ªå…ˆãƒ«ãƒ¼ãƒ«ã‚’ç®¡çE™ã‚E
      exports:
        - name: createModeController
          returns: modeController
          signature: "({ uiState, selectionController, microController, visibilityController }) â†EmodeController"
      di_injected:
        - name: uiState
          source: "bootstrapViewer (createUiState result)"
        - name: selectionController
          source: "bootstrapViewer (createSelectionController result)"
        - name: microController
          source: "bootstrapViewer (createMicroController result)"
        - name: visibilityController
          source: "bootstrapViewer (createVisibilityController result)"
      modeController:
        methods:
          - set(mode:'macro'|'micro', uuid?:string): 'macro'|'micro'
          - get(): 'macro'|'micro'
          - canEnter(uuid:string): boolean
          - exit(): 'macro'|'micro'
          - focus(uuid:string): 'macro'|'micro'
        calls:
          - "DI: selectionController.select"
          - "DI: selectionController.get"
          - "DI: microController.refresh"
          # activeFrame ã¯ uiState.frame.current ã‚’å‚ç…§ã™ã‚‹EErameController ä¾å­˜ã‚’æŒãŸãªãE¼E
          - "DI: visibilityController.isVisible"
        called_by:
          - "runtime/viewerHub.jsEEore.mode.*, core.micro.*EE
        rules:
          - "uiState.runtime.isFramePlaying === true ã®é–“ãE canEnter(uuid) ã‚’å¿Eš false ã«ã™ã‚‹EEicro ä¾µå…¥ç¦æ­¢EE
          - "å†ç”Ÿé–‹å§‹æ™‚ã® mode='macro' å¼·åˆ¶ã¯ core.frameController.startPlayback ãŒæ‹…ä¿ã™ã‚E
          - "micro ã¯ visibleSet å†EEè¦ç´ ã«ã ã‘é©ç”¨ã•ã‚Œã‚E
          - "canEnter ã¯ isFramePlaying / isCameraAuto / visibilityController.isVisible(uuid) ã‚’ãƒã‚§ãƒE‚¯ã™ã‚‹EErame æ¡ä»¶ã¯ visibleSet ã«åæ˜ æ¸ˆã¿EE
          - "isFramePlaying / isCameraAuto ã¯ core æ‰€æœ‰ãE uiState.runtime ã‚’å‚ç…§ã—ã¦åˆ¤å®šã™ã‚E
          - "set('micro', uuid) ã¯å†Eƒ¨ã§å¿Eš canEnter(uuid) ã‚’è©•ä¾¡ã—ã€æº€ãŸã•ãªãE ´åˆãE **no-op**EˆçŠ¶æ…‹å¤‰æ›´ãªã—ï¼‰ã§ç¾åœ¨ã® mode ã‚’è¿”ã™Eˆä¾‹å¤–ç¦æ­¢EE
          - "mode ãE'macro' ã«é·ç§»ã—ãŸå ´åˆãE uiState.microState ã‚’å¿Eš null ã«ã™ã‚‹EEicroFX off ã‚’ä¿è¨¼EE
          - "set('micro') ã§ uuid ãŒæœªæŒE®šãEå ´åˆãE selection.uuid ã‚’ç”¨ãE‚‹ã€‚selection ãEnull ã®å ´åˆãE no-op ã§ç¾çŠ¶ mode ã‚’è¿”ã™ã€E
        state:
          - "uiState.mode ã‚’æ›´æ–°ã™ã‚‹"
          - "uiState.microState ã¯ microController.refresh() ã«ã‚ˆã‚Šæ›´æ–°ã™ã‚‹EEode==='micro' ã®é–“ãEæ­£è¦ãƒ«ãƒ¼ãƒˆï¼E

    - name: runtime/core/microController.js
      layer: core
      responsibility:
        - "selection + cameraState + indices ã‹ã‚‰ microStateEE MicroFXPayloadE‰ã‚’ç®—åEã™ã‚‹"
      exports:
        - name: createMicroController
          returns: microController
          signature: "({ uiState, indices }) â†EmicroController"
      di_injected:
        - name: uiState
          source: "bootstrapViewer (createUiState result)"
        - name: indices
          source: "bootstrapViewer (structIndex.buildUUIDIndex result)"
      microController:
        methods:
          - compute(selection, cameraState): MicroFXPayload | null   # optional: pure helper ã¨ã—ã¦æ®‹ã™ãªã‚‰æ®‹ã™
          - refresh(): MicroFXPayload | null
        notes:
          - "refresh() ã¯ uiState.microState ã‚’æ›´æ–°ã™ã‚‹EEode!=='micro' ã®ã¨ããE uiState.microState=null ã‚’ä¿è¨¼E‰ã€‚æˆ»ã‚Šå€¤ã¯æ›´æ–°å¾ŒãEå€¤EEicroFXPayload|nullE‰ã€E
          - "è¦ç¯E å‘¼ã³å‡ºã—åEã¯åŸå‰‡ã¨ã—ã¦ä»£å…¥ã—ãªãE¼Eefresh ã®å‰¯ä½œç”¨ã‚’æ­£ã¨ã™ã‚‹E‰ã€E
        calls: []
        called_by:
          - "core/modeController"
          - "core.recomputeVisibleSet()EEootstrapViewer ãEcore ã«ã¶ã‚‰ä¸‹ã’ã‚‹è£œåŠ©ãƒ¡ã‚½ãƒEƒ‰EE
          - "runtime/viewerHub.jsEEender loop å†E§ refreshEE
        constraints:
          - "three.js ã‚Eimport ã—ã¦ã¯ãªã‚‰ãªãE
          - "renderer ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¯ãªã‚‰ãªãE
        microState_shape:
          - "MicroFXPayload å‹ï¼EDSD-viewer.md 7.11 ç¯€E‰ã¨åŒå‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ã¾ãŸãE null ã‚’è¿”ã™"
          - "renderer ã¯ unknown ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãEç„¡è¦–ã—ã¦è‰¯ãE

    - name: runtime/core/visibilityController.js
      layer: core
      responsibility:
        - "appearance.visible / frames / filters ã‚’åˆæˆã—ã€visibleSet ã‚’è¨ˆç®—ã™ã‚E
        - "v1.1.0: appearance.visible ã¯ default ã‚’æŒãŸãªãEŸã‚ã€æœªæŒE®Eundefined)ã¯ true æ‰±ãE¨ã™ã‚‹EEalse ã®ã¨ããEã¿éè¡¨ç¤ºEE
        - "v1.1.0: appearance.frames ã¯ number | number[] ã‚’è¨±å®¹ã—ã€activeFrame ã¨ç…§åˆã—ã¦å¯è¦–åˆ¤å®šã™ã‚E
      rules:
        - "visible: undefined â‡Etrue / false â‡Ehidden"
        - "frames: undefined â‡Eå…¨ãƒ•ãƒ¬ãƒ¼ãƒ ã§å¯è¦E
        - "activeFrame === null ã®ã¨ãE frames ã¯åˆ¤å®šã«ä½¿ã‚ãšEEisible ã¨ filters ã®ã¿E‰å¯è¦–åˆ¤å®šã™ã‚E
        - "activeFrame !== null ã®ã¨ãE frames ãEnumber ãªã‚‰ä¸€è‡´æ™‚ãEã¿å¯è¦–ã€number[] ãªã‚‰å«ã¾ã‚Œã‚‹ã¨ãå¯è¦E
      exports:
        - name: createVisibilityController
          returns: visibilityController
          signature: "({ uiState, document, indices }) â†EvisibilityController"
      di_injected:
        - name: uiState
          source: "bootstrapViewer (createUiState result)"
        - name: document
          source: "bootstrapViewer (validated + deepFreeze æ¸ˆã¿ 3DSS)"
        - name: indices
          source: "bootstrapViewer (structIndex.buildUUIDIndex result)"

      visibilityController:
        methods:
          - recompute(): VisibleSet
          - isVisible(uuid:string): boolean
          - get(): FiltersState
          - setTypeEnabled(kind:'points'|'lines'|'aux', enabled:boolean)
          - setAuxModuleEnabled(module:'grid'|'axis'|'plate'|'shell'|'hud'|'extension', enabled:boolean)
      method_notes:
        - "setTypeEnabled/setAuxModuleEnabled ã¯ filters ã®çŠ¶æ…‹æ›´æ–°ã®ã¿è¡Œã†"
        - "visibleSet å†è¨ˆç®—ã¨ selection/micro å¾ŒåEçEE caller ãEcore.recomputeVisibleSet() ã‚’å‘¼ã‚“ã§ä¿è¨¼ã™ã‚‹Eˆå¾ªç’°ä¾å­˜å›é¿EE
        - "isVisible(uuid) ã¯ uiState.visibleSet ã® points/lines/aux ã® membership ã‚’è¦‹ã‚‹EEisibleSet ãEnull ã®å ´åˆãE falseEE
      calls: []
      called_by:
        - "runtime/viewerHub.jsEEore.filters.*EE
        - "core/recomputeVisibleSet"
        - "core/modeController"
      state:
        - "uiState.visibleSet ã¯ core.recomputeVisibleSet ãŒæ›´æ–°ã—ã€visibilityController ã¯å‚çEã®ã¿"
        - "uiState.filters ã‚E{points,lines,aux,auxModules?:Record<string,boolean>} ã¨ã—ã¦ä¿æŒã™ã‚‹"

    - name: runtime/core/uiState.js
      layer: core
      responsibility:
        - "viewer ã® UI çŠ¶æ…‹ã‚’ä¸€å…E®¡çE™ã‚‹ï¼Eocument ã¨ã¯åˆE›¢EE
      exports:
        - name: createUiState
          returns: uiState
          signature: "() â†EuiState"
      fields:
        - "frame: {current:number|null, range:{min:number,max:number}|null}"
        - "runtime: {isFramePlaying:boolean, isCameraAuto:boolean}"
        - "filters: {points:boolean, lines:boolean, aux:boolean, auxModules:Record<string,boolean>}"
        - "visibleSet: VisibleSet | null"
        - "mode: 'macro'|'micro'"
        - "selection: SelectionState | null"
        - "hover: HoverState | null"
        - "microState: MicroState | null"
        - "cameraState: CameraState"
        - "viewerSettings: {worldAxesVisible:boolean, lineWidthMode:'auto'|'fixed'|'adaptive', microFXProfile:'weak'|'normal'|'strong'}"
      types:
          VisibleSet:
            - "frame:number|null"
            - "points:Set<string>"
            - "lines:Set<string>"
            - "aux:Set<string>"
          SelectionState:
            - "uuid:string"
            - "kind:'points'|'lines'|'aux'"
          HoverState:
            - "uuid:string"
            - "kind:'points'|'lines'|'aux'"
      defaults:
        - "filters: { points:true, lines:true, aux:true, auxModules:{grid:true, axis:true, plate:true, shell:true, hud:true, extension:true} }"
        - "frame: { current:null, range:null }"
        - "visibleSet: null  # åˆæœŸåŒ–å¾Œã« core.recomputeVisibleSet() ã§ç¢ºå®E
        - "mode: 'macro'"
        - "selection: null"
        - "hover: null"
        - "runtime: {isFramePlaying:false, isCameraAuto:false}"
        - "viewerSettings: {worldAxesVisible:true, lineWidthMode:'auto', microFXProfile:'normal'}"

    - name: runtime/core/structIndex.js
      layer: core
      responsibility:
        - "3DSS document ã‹ã‚‰ uuid ã‚¤ãƒ³ãƒEƒƒã‚¯ã‚¹ã¨ frameRange ã‚’æ§‹ç¯‰ã™ã‚E
      exports:
        - name: buildUUIDIndex
          signature: "(document) â†E{ uuidToKind:Map<string,kind>, ... }"
        - name: getCenter
          signature: "(indices, uuid:string) â†E[number,number,number] | null"
          description: "pointã¯ããEåº§æ¨™ã€lineã¯ä¸­ç‚¹ã€auxã¯ä»£è¡¨ç‚¹Eˆå®Ÿè£E®šç¾©EE
        - name: detectFrameRange
          signature: "(document) â†E{min:number,max:number} | null"
          description: |
            v1.1.0: appearance.frames ã¯ number | number[]ã€E
            points/lines/aux å…¨è¦ç´ ã® frames ã‚’èµ°æŸ»ã—ã¦ min/max ã‚’è¿”ã™ã€E
            frames ãEä»¶ã‚‚ç„¡ãE ´åˆãE nullã€E
      called_by:
        - "bootstrapViewer"

    - name: runtime/core/recomputeVisibleSet.js
      layer: core
      responsibility:
        - "visibilityController.recompute() ã‚’å‘¼ã³ uiState.visibleSet ã‚’æ›´æ–°"
        - "selection ãŒä¸å¯è¦–ã«ãªã£ãŸå ´åˆãEä¸å¤‰æ¡ä»¶ã‚’ä¿è¨¼:"
        - "  - selectionController.clear() ã‚’å‘¼ã¶Eˆæ¨å¥¨Ešä¿æŒã—ãªãE¼E
        - "selection ãŒä¸å¯è¦–ã«ãªã£ãŸå ´åˆã€modeController.set('macro') ã§ micro ã‚’ç¢ºå®Ÿã«æŠœã‘ã‚E
        - "  - microState ã‚Enull ã«ã™ã‚‹"
        - "selection ãŒå¯è¦–ã§ mode ãEmicro ã®å ´åˆãE microController.refresh() ã§ microState ã‚’åEè¨ˆç®E
      exports:
        - name: createRecomputeVisibleSet
          signature: "({ uiState, visibilityController, selectionController, microController, modeController }) â†E{ recomputeVisibleSet }"
      di_injected:
        - name: uiState
          source: "bootstrapViewer (createUiState result)"
        - name: visibilityController
          source: "bootstrapViewer (createVisibilityController result)"
        - name: selectionController
          source: "bootstrapViewer (createSelectionController result)"
        - name: microController
          source: "bootstrapViewer (createMicroController result)"
        - name: modeController
          source: "bootstrapViewer (createModeController result)"
      calls:
        - "DI: visibilityController.recompute"
        - "CALL: canonicalVisibleSet = visibilityController.recompute()"
        - "CALL: uiState.visibleSet = canonicalVisibleSet  # single-writer"
        - "DI: selectionController.get"
        - "CALL: sel = selectionController.get()"
        - "DI: visibilityController.isVisible"
        - "CALL: if (sel && !visibilityController.isVisible(sel.uuid)) { selectionController.clear(); modeController.set('macro'); uiState.microState = null; return; }"
        - "DI: selectionController.clear  # selection ãŒä¸å¯è¦–ãªã‚E
        - "DI: modeController.set         # selection ä¸å¯è¦–ãªã‚E'macro' å¼·åˆ¶"
        - "DI: microController.refresh    # selection å¯è¦–ã‹ã¤ mode==='micro' ã®ã¨ãE
        - "CALL: if (uiState.mode === 'micro') microController.refresh()"
      notes:
        - "recomputeVisibleSet() ã¯ bootstrapViewer ã§ç”ŸæEã•ã‚Œã€ä»Ecore ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¸ DI ã§é…å¸E•ã‚Œã‚‹EEmport å‚çEã—ãªãE¼‰ã€E

    # =========================
    # 2.4 renderer
    # =========================
    - name: runtime/renderer/context.js
      layer: renderer
      responsibility:
        - "three.js renderer / scene / camera ã‚’åEæœŸåŒ–ã—ã€Core ã‹ã‚‰æ¸¡ã•ã‚ŒãŸçŠ¶æ…‹ã‚’æç”»ã™ã‚‹"
      exports:
        - name: createRendererContext
          returns: rendererContext
          signature: "({ canvas }) â†ErendererContext"
        - name: rendererContext
          methods:
            - syncDocument(document, indices)
            - getSceneMetrics(): {center:[number,number,number], radius:number} | null
            - applyFrame(visibleSet:VisibleSet|null)
            - updateCamera(cameraState)
            - applyViewerSettings(viewerSettings)
            - applyMicroFX(microState)
            - applySelection(selectionState:SelectionState|null)
            - pickObjectAt(ndcX:number, ndcY:number): {uuid:string, kind:'points'|'lines'|'aux', distance:number, point:[number,number,number]} | null
            - render()
            - resize(width:number, height:number)
            - dispose()
      internal_state:
        - "renderer: THREE.WebGLRenderer"
        - "scene: THREE.Scene"
        - "camera: THREE.PerspectiveCamera"
        - "ambientLight: THREE.AmbientLight"
        - "dirLight: THREE.DirectionalLight"
        - "pointObjects: Map<string,THREE.Object3D>  # key=uuid"
        - "lineObjects: Map<string,THREE.Object3D>  # key=uuid"
        - "auxObjects: Map<string,THREE.Object3D>   # key=uuid"
        - "baseStyle: Map<string,{color:THREE.Color,opacity:number, renderOrder:number}>  # color ã¯ clone ã‚’ä¿å­E
        - "raycaster: THREE.Raycaster"
        - "viewerSettingsCache: {worldAxesVisible:boolean,lineWidthMode:'auto'|'fixed'|'adaptive',microFXProfile:'weak'|'normal'|'strong'}"
        - "pickTargets: THREE.Object3D[]  # uuid ã‚’æŒã¤å¯¾è±¡ã ã‘åEã‚Œã‚‹"
        - "lastMicroState: MicroFXPayload | null"
      lifecycle:
        init:
          - "new THREE.WebGLRenderer({ canvas, antialias:true })"
          - "renderer.setPixelRatio(window.devicePixelRatio || 1)"
          - "renderer.setSize(canvas.clientWidth, canvas.clientHeight, false)"
          - "scene = new THREE.Scene()"
          - "camera = new THREE.PerspectiveCamera(fov, aspect, near, far) # åˆæœŸå€¤ã¯æš«å®šã€‚æœ€åˆãE updateCamera(cameraState) ã§ç¢ºå®šå€¤ã«ä¸Šæ›¸ãã•ã‚Œã‚‹"
          - "scene ã« AmbientLight / DirectionalLight ã‚’è¿½åŠ "
        syncDocument:
          - "å‰å›ã® point/line/aux ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ scene ã‹ã‚‰ remove"
          - "åEobject ã® geometry/material/texture ã‚EdisposeEˆå¯èƒ½ãªç¯E›²ã§EE
          - "Map ã‚Eclear"
          - "3DSS document ã® points/lines/aux ã‹ã‚‰ä¸‰æ¬¡å…E‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”ŸæEEˆæœªå®šç¾©ã¯ç©ºé…åEæ‰±ãE¼E
          - "åE‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã« userData.uuid ã‚’ä»˜ä¸ã—ã€å¯¾å¿œã™ã‚EMap ã«ç™»éŒ²"
          - "pick ã®ãŸã‚ã€å„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã« userData.kind = 'points'|'lines'|'aux' ã‚’ä»˜ä¸ã™ã‚E
          - "baseStyle Map ã«å…EE color(clone) / opacity / renderOrder ã‚’ä¿å­E
          - "pickTargets ã‚’åEæ§‹ç¯‰ï¼Euid ã‚’æŒã¤ object ã ã‘ï¼E
          - "lastMicroState = null"
        dispose:
          - "scene ã‹ã‚‰å…¨ object ã‚Eremove"
          - "geometry/material/texture ã‚’å¯èƒ½ãªç¯E›²ã§ dispose"
          - "WebGLRenderer.dispose() / forceContextLoss ã¯å®Ÿè£Eˆ¤æ–­Eˆå¯èƒ½ãªã‚Edev æ™‚ãEã¿EE
          - "Map / é…åE / cache ã‚Eclear"
          - "lastMicroState = null"
        applyFrame:
          - "visibleSetEEisibleSet|nullE‰ã‚’å—ã‘å–ã‚Šã€points/lines/aux ã® membership ã«å¾“ã£ã¦åE‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãE obj.visible ã‚’æ›´æ–°ã™ã‚‹"
          - "visibleSet===null ã®å ´åˆãEå®‰åEå´ã§å…¨éè¡¨ç¤ºEˆã¾ãŸãE no-opE‰ã«ã—ã¦ã‚ˆã„ãŒã€æ¨å¥¨ã¯å…¨éè¡¨ç¤ºEˆåEå›Erecompute å‰ãEãƒãƒ©ã¤ãé˜²æ­¢EE
        applyViewerSettings:
          - "viewerSettings.worldAxesVisible ã«å¾“ã„ã€world axes è¡¨ç¤ºEEUD/scene ã©ã¡ã‚‰ã§ã‚‚å¯E‰ã‚’ on/off"
          - "viewerSettings.lineWidthMode ã‚Erenderer å†Eƒ¨ã® line æç”»è¨­å®šã«åæ˜ Eˆå®Ÿè£E©³ç´°ã¯ä»»æ„ï¼E
          - "viewerSettings.microFXProfile ã‚Erenderer å†Eƒ¨ã«ä¿æŒã—ã€applyMicroFX ã®å¼·åº¦/é–¾å€¤ã«åæ˜ EEpplyMicroFX ã® signature ã¯å¤‰ãˆãªãE¼E
        applyMicroFX:
          - "microState ãEnull ã®å ´åE baseStyle ã«å¾“ã£ã¦ color/opacity/renderOrder ã‚’ãƒ•ãƒ«ãƒªã‚»ãƒEƒˆ"
          - "microState ãEMicroFXPayload ã®å ´åE **å¿Eš baseStyle ã‹ã‚‰é–‹å§‹ã—ã¦**EE å‰æ®µ selection ç­‰ãEæ®‹ã‚Šã‚’æ¶ˆã—ã¦ã‹ã‚‰EEfocus/connection/distance ç­‰ã«å¿œã˜ã¦ opacity/color ã‚’å¤‰æ›´ã™ã‚‹"
          - "lastMicroState = microState"
        updateCamera:
          - "camera.position / camera.up ã‚EcameraState ã‹ã‚‰è¨­å®E
          - "target ãƒ™ã‚¯ãƒˆãƒ«ã«å¯¾ã—ã¦ camera.lookAt(target)"
          - "near/far/fov ãŒå¤‰ã‚ã£ãŸå ´åˆãE camera.near/far/fov æ›´æ–° EEupdateProjectionMatrix()"
          - "è¦ç¯E updateCamera ã¯ camera.aspect ã‚’æ›´æ–°ã—ã¦ã¯ãªã‚‰ãªãE¼Espect ã¯ resize ã®è²¬å‹™ï¼‰ã€E
        applySelection:
          - "selectionStateEEelectionState|nullE‰ã‚’å—ã‘å–ã‚Šã€E*macro ç”¨**ã®è»½ãEselection ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’é©ç”¨ã—ã¦ã‚ˆã„EEull ãªã‚Eselection ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹EE
          - "å„ªå…ˆé E½E **microFX > selectionEEacroEE> baseStyle**"
          - "é˜²å¾¡çšE¦ç¯E lastMicroState != null ã®é–“ãE no-opEEicroFX å„ªå…ˆï¼‰ã€‚â€» mode åˆ¤å®šã‚„ uiState å‚çEã¯ renderer ã§è¡Œã‚ãªãE¼ˆå‘¼ã³å‡ºã—æ¡ä»¶ã¯ hub ãŒæ‹…ä¿ï¼E
        pickObjectAt:
          - "raycaster.setFromCamera({x:ndcX,y:ndcY}, camera)"
          - "raycaster.intersectObjects(pickTargets, true) ã®æœ€å‰é¢ãƒ’ãƒƒãƒˆã‹ã‚‰ã€parent ã‚’è¾¿ã£ã¦ userData.uuid ã‚’æŒã¤æœ€åˆãEãƒãEãƒ‰ã‚’æ¡ç”¨ã—ã¦è¿”ã™Eˆå­meshãƒ’ãƒƒãƒˆå¯¾ç­–ï¼E
        render:
          - "renderer.render(scene, camera)"
        resize:
          - "renderer.setSize(width, height, false)"
          - "camera.aspect = width/height; camera.updateProjectionMatrix()"
          - "è¦ç¯E aspect æ›´æ–°ã¯ resize ã®ã¿ã€‚updateCamera ã§ aspect ã‚’è§¦ã‚‰ãªãE€E
      calls: []
      called_by:
        - "bootstrapViewerEˆåEæœŸåŒ–EE
        - "runtime/viewerHub.js"
      constraints:
        - "3DSS document ã‚’æ›¸ãæ›ãˆã¦ã¯ãªã‚‰ãªãE
        - "visibleSet / microState / selectionState / cameraState ã® canonical æ‰€æœ‰è€EE core ã§ã‚ã‚Šã€renderer ã¯åEƒ•ãƒ¬ãƒ¼ãƒ ã§å—ã‘å–ã£ã¦åæ˜ ã™ã‚‹ã ãE
        - "mode ã‚Eselection ã®åˆ¤å®šãƒ­ã‚¸ãƒE‚¯ã‚’å®Ÿè£E—ã¦ã¯ãªã‚‰ãªãE
        - "UI layer ã¯ renderer ã‚’ç›´æ¥ import ã—ã¦ã¯ãªã‚‰ãªãE¼EickObjectAt ã‚‚å¿Eš viewerHub.pickObjectAt çµŒç”±EE
        - "å¤–éƒ¨å…¬é–EAPI ã¨ã—ã¦ã® highlight ã¯ applySelection/applyMicroFX ã®ã¿EEetHighlight/clearAllHighlights ã‚Eexport ã—ãªãE¼E

    # =========================
    # 2.5 UI Bridge
    # =========================
    # Pointer/Keyboard å…¥åŠ›ã‚‚å«ã‚ã¦ã€E
    # UI å±¤ã¯ã€ŒDOM å…¥åŠE/ UI â†Ehub.core.* / hub.pickObjectAt / hub.viewerSettings.*ã€ãEã¿ã‚’æ‹…å½“ã™ã‚‹ã€E

    - name: ui/gizmo.js
      layer: ui
      responsibility:
        - "ç”»é¢å³ä¸‹ãE HUD è»¸ã‚®ã‚ºãƒ¢ã‚’æç”»ã—ã€ã‚¯ãƒªãƒE‚¯ã§ camera snap/home ã‚’å‘¼ã¶"
      exports:
        - name: attachGizmo
          signature: "(wrapperElement:HTMLElement, hub) â†Evoid"
      calls:
        - "DI: hub.core.camera.snapToAxis"
        - "CALL: hub.core.camera.snapToAxis(axis)"
        - "DI: hub.core.camera.reset"
        - "CALL: hub.core.camera.reset()"
      called_by:
        - "viewerDevHarness.jsEEevEE
        - "Host: viewerHost.jsEErod hostã€‚gizmo æ¡ç”¨æ™‚ãEã¿EE
      constraints:
        - "three.js æœ¬ä½“ãE scene ã«ã¯å…¥ã‚‰ãšã€HUD overlay ã¨ã—ã¦ DOM ã§æç”»ã™ã‚‹"

    - name: ui/picker.js
      layer: ui
      responsibility:
        - "canvas ä¸ŠãEã‚¯ãƒªãƒE‚¯åº§æ¨™ã‹ã‚Euuid ã‚’å–å¾—ã—ã€selection ã‚’æ›´æ–°ã™ã‚‹"
      exports:
        - name: createPicker
          returns: picker
        - name: picker
          methods:
            - attach(domElement)
            - detach()
      calls:
        - "DI: hub.pickObjectAt"
        - "CALL: hit = hub.pickObjectAt(ndcX, ndcY)"
        - "DI: hub.core.selection.select"
        - "CALL: hub.core.selection.select(hit.uuid, hit.kind)"
      called_by:
        - "viewerDevHarness.jsEEevEE
        - "Host: viewerHost.jsEErod host ã® UI åˆæœŸåŒ–ã‚¨ãƒ³ãƒˆãƒªã€‚åç§°ã¯å®Ÿè£E«åˆã‚ã›ã‚‹EE

    - name: ui/timeline.js
      layer: ui
      responsibility:
        - "frame scrub / play/pause UI ã¨ core.frame.* ã‚’æ¥ç¶šã™ã‚‹ï¼Eev harness ã«ä¸€ä½“åŒ–ã—ã¦ã‚‚ã‚ˆãE¼E
      exports:
        - name: createTimeline
          returns: timeline
        - name: timeline
          methods:
            - attach(domRoot:HTMLElement)
            - detach()
      calls:
        - "DI: hub.core.frame.setActive"
        - "CALL: hub.core.frame.setActive(frame)"
        - "DI: hub.core.frame.next"
        - "CALL: hub.core.frame.next()"
        - "DI: hub.core.frame.prev"
        - "CALL: hub.core.frame.prev()"
        - "DI: hub.core.frame.getRange"
        - "CALL: hub.core.frame.getRange()"
        - "DI: hub.core.frame.startPlayback"
        - "CALL: hub.core.frame.startPlayback()"
        - "DI: hub.core.frame.stopPlayback"
        - "CALL: hub.core.frame.stopPlayback()"
      called_by:
        - "viewerDevHarness.jsEEevEE
        - "Host: viewerHost.jsEErod hostã€‚timeline æ¡ç”¨æ™‚ãEã¿EE

    - name: ui/pointerInput.js
      layer: ui
      responsibility:
        - "canvas ä¸ŠãE PointerEEouse/WheelE‰åEåŠ›ã‚’ hub.core.camera / hub.pickObjectAt ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹ UI å…¥åŠ›ãƒ¬ã‚¤ãƒ¤"
      exports:
        - name: PointerInput
          type: class
          constructor: "(canvas:HTMLCanvasElement, hub) â†EPointerInput"
          methods:
            - dispose()
      calls:
        - "DI: hub.core.camera.rotate"
        - "CALL: hub.core.camera.rotate(dTheta, dPhi)"
        - "DI: hub.core.camera.pan"
        - "CALL: hub.core.camera.pan(dx, dy)"
        - "DI: hub.core.camera.zoom"
        - "CALL: hub.core.camera.zoom(delta)"
        - "DI: hub.pickObjectAt"
        - "CALL: hit = hub.pickObjectAt(ndcX, ndcY)"
        - "DI: hub.core.selection.select"
        - "CALL: hub.core.selection.select(hit.uuid, hit.kind)"
        - "DI: hub.core.mode.set"
        - "CALL: hub.core.mode.set(mode, uuid?)"
      called_by:
        - "viewerDevHarness.jsEEevEE
        - "Host: viewerHost.jsEErod hostEE
      constraints:
        - "runtime/core ã‹ã‚‰ã¯ PointerInput ã‚Eimport ã—ã¦ã¯ãªã‚‰ãªãE¼EI å°‚ç”¨EE
        - "CameraEngine ã«ç›´æ¥è§¦ã‚‰ãšã€åŸå‰E¨ã—ã¦ hub.core.camera.* çµŒç”±ã§æ“ä½œã™ã‚‹ï¼ˆç§»è¡Œä¸­ã¯ cameraEngine ç›´å©ããEäº’æ›ã‚³ãƒ¼ãƒ‰ãŒæ®‹ã‚‹å ´åˆãŒã‚ã‚‹EE

    - name: ui/keyboardInput.js
      layer: ui
      responsibility:
        - "window ã® keydown ã‚E1 ç®E‰€ã«é›E´E—ã€hub.core.camera / hub.core.frame / hub.core.mode / hub.core.selection / hub.viewerSettings ã ã‘ã‚’å©ãE
      exports:
        - name: KeyboardInput
          type: class
          constructor: "(target:Window, hub) â†EKeyboardInput"
          methods:
            - dispose()
      calls:
        - "DI: hub.viewerSettings.toggleWorldAxes"
        - "CALL: hub.viewerSettings.toggleWorldAxes()"
        - "DI: hub.core.frame.step"
        - "CALL: hub.core.frame.step(delta)"
        - "DI: hub.core.frame.getRangeEˆå°E¥ã® UI ç”¨ã«äºˆç´E¼E
        - "CALL: hub.core.frame.getRange()"
        - "DI: hub.core.mode.set"
        - "CALL: hub.core.mode.set(mode, uuid?)"
        - "DI: hub.core.mode.get"
        - "CALL: hub.core.mode.get()"
        - "DI: hub.core.selection.get"
        - "CALL: hub.core.selection.get()"
        - "DI: hub.core.camera.rotate"
        - "CALL: hub.core.camera.rotate(dTheta, dPhi)"
        - "DI: hub.core.camera.zoom"
        - "CALL: hub.core.camera.zoom(delta)"
        - "DI: hub.core.camera.reset"
        - "CALL: hub.core.camera.reset()"
        - "DI: hub.core.camera.setViewPreset"
        - "CALL: hub.core.camera.setViewPreset(index, opts?)"
        - "DI: hub.core.camera.getViewPresetIndex"
        - "CALL: hub.core.camera.getViewPresetIndex()"
      called_by:
        - "viewerDevHarness.jsEEevEE
        - "Host: viewerHost.jsEErod hostã€‚keyboard æ¡ç”¨æ™‚ãEã¿EE
      keymap:
        - "C / c: viewerSettings.toggleWorldAxes()"
        - "Backslash / IntlYen / IntlRo / '\\' / 'Â¥': view preset index ã‚EÂ±1 å·¡å›ï¼Ehift ã§é€E–¹å‘ï¼E
        - "PageUp:   frame.step(+1)"
        - "PageDown: frame.step(-1)"
        - "Esc:      mode.set('macro')"
        - "Home:     camera.reset()"
        - "+ / NumpadAdd:      camera.zoom(-0.1)"
        - "- / NumpadSubtract: camera.zoom(+0.1)"
        - "ArrowLeft/Right/Up/Down: camera.rotate(Â±Î”Î¸,Â±Î”ÏEEEhift ã§å€é€Ÿï¼E
      constraints:
        - "INPUT / TEXTAREA ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹å ´åˆãEã‚­ãƒ¼ã‚’ç„¡è¦–ã™ã‚E
        - "runtime/core ã‹ã‚‰ã¯ KeyboardInput ã‚Eimport ã—ã¦ã¯ãªã‚‰ãªãE¼EI å°‚ç”¨EE

    # =========================
    # 2.6 Host / DevHarness
    # =========================

    - name: viewerDevHarness.js
      layer: ui
      responsibility:
        - "bootstrapViewerFromUrl ã§ hub ã‚’ç”ŸæˆE
        - "host_ui_attach.profiles.devHarness_full ã«å¾“ã£ã¦ UI ã‚Eattach"
        - "hub.start() ã‚’å‘¼ã¶"
        - "ResizeObserver ç­‰ã§ hub.resize(width,height) ã‚’å‘¼ã¶"
      calls:
        - "IMPORT: runtime/bootstrapViewer.bootstrapViewerFromUrl"
        - "CALL: hub = await bootstrapViewerFromUrl(canvasOrId, url, options)"
        - "IMPORT: ui/pointerInput.PointerInput"
        - "CALL: pointer = new PointerInput(canvas, hub)"
        - "IMPORT: ui/keyboardInput.KeyboardInput"
        - "CALL: keyboard = new KeyboardInput(window, hub)"
        - "IMPORT: ui/gizmo.attachGizmo"
        - "CALL: attachGizmo(wrapperEl, hub)"
        - "IMPORT: ui/picker.createPicker"
        - "CALL: picker = createPicker(hub); picker.attach(canvas)"
        - "IMPORT: ui/timeline.createTimeline"
        - "CALL: timeline = createTimeline(hub); timeline.attach(timelineRoot)"
        - "CALL: hub.start()"

    - name: viewerHost.js
    - name: viewerHostBoot.js
      layer: ui
      responsibility:
        - "æœ¬ç•ª Host ã® UI åˆæœŸåŒ–ã‚¨ãƒ³ãƒˆãƒª"
        - "é¸æŠã—ãEhost_ui_attach.profile ã«å¾“ã£ã¦ attach ã‚»ãƒEƒˆã‚’æ§‹ç¯E
      calls:
        - "IMPORT: runtime/bootstrapViewer.bootstrapViewer / bootstrapViewerFromUrl"
        - "CALL: hub = ..."
        - "CALL: if (profile==='prod_minimal') { new PointerInput(canvas, hub); attachGizmo(wrapperEl, hub); }"
        - "CALL: if (profile==='prod_full') { new PointerInput(canvas, hub); new KeyboardInput(window, hub); attachGizmo(wrapperEl, hub); createPicker(hub).attach(canvas); createTimeline(hub).attach(timelineRoot); }"
 
        - "CALL: hub.start()"



  # =========================================================
  # 3. Runtime ãƒ•ãƒ­ãƒ¼
  # =========================================================

  # =========================================================
  # 3.1 Host UI attach ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«EEev/prodEE
  # =========================================================

  host_ui_attach:

    # Host ã¯ã€Œhub ã‚’ç”Ÿæˆã™ã‚‹ã€ï¼‹ã€Œå¿E¦EUI ã‚Eattach ã™ã‚‹ã€ã ã‘ã‚’è²¬å‹™ã¨ã™ã‚‹
    principles:
      - "UI attach ã¯ Host/devHarness ã®è²¬å‹™ã€‚runtime(core/renderer/hub) ã¯ UI ã‚Eimport ã—ãªãE€E
      - "æ¡ç”¨ UI ã¯ profile ã§å®£è¨€ã—ã€startup ãƒ•ãƒ­ãƒ¼ã¯ profile ã«å¾“ã†ã€E
      - "profile ã«å«ã‚ãªãEUI ã¯ attach ã—ãªãE¼ˆæ©ŸèEå·®ã‚’æEç¤ºã™ã‚‹E‰ã€E

    profiles:

      devHarness_full:
        description: "é–‹ç™ºç”¨ãƒ•ãƒ«è£E‚™Eˆæ¤œè¨¼/ãƒEƒãƒE‚°å„ªå…ˆï¼E
        attach:
          - "ui/pointerInput.js: PointerInput(canvas, hub)"
          - "ui/keyboardInput.js: KeyboardInput(window, hub)"
          - "ui/gizmo.js: attachGizmo(wrapperEl, hub)"
          - "ui/picker.js: createPicker(hub).attach(canvas)"
          - "ui/timeline.js: createTimeline(hub).attach(timelineRoot)"
        notes:
          - "timeline ã¯ frameRange ãEnull ã®å ´åEUI ã‚Edisable è¡¨ç¤ºã«ã—ã¦ã‚ˆã„EEttach è‡ªä½“ãEå¯E‰ã€E

      prod_minimal:
        description: "æœ¬ç•ªæœ€å°ï¼ˆæ“ä½œã¨é–²è¦§ã®ã¿EE
        attach:
          - "ui/pointerInput.js: PointerInput(canvas, hub)"
          - "ui/gizmo.js: attachGizmo(wrapperEl, hub)"
        notes:
          - "picker ã¯æ¡ç”¨ã—ãªãE¼ˆã‚¯ãƒªãƒE‚¯é¸æŠãªã—é‹ç”¨E‰ã€E
          - "keyboard ã¯æ¡ç”¨ã—ãªãE¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒEƒˆç„¡ã—é‹ç”¨E‰ã€E
          - "timeline ã¯æ¡ç”¨ã—ãªãE¼Erame UI ãªã—é‹ç”¨E‰ã€E

      prod_full:
        description: "æœ¬ç•ªãƒ•ãƒ«Eˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚’å…¨éƒ¨æä¾›ï¼E
        attach:
          - "ui/pointerInput.js: PointerInput(canvas, hub)"
          - "ui/keyboardInput.js: KeyboardInput(window, hub)"
          - "ui/gizmo.js: attachGizmo(wrapperEl, hub)"
          - "ui/picker.js: createPicker(hub).attach(canvas)"
          - "ui/timeline.js: createTimeline(hub).attach(timelineRoot)"
        notes:
          - "å…¥åŠ›è¡çªE¼Eragä¸­ã‚¯ãƒªãƒE‚¯ç­‰ï¼‰ãEå„ªå…ˆé E½ãE UI å±¤ã§è§£æ±ºã™ã‚‹EEub/core ã«ãƒ­ã‚¸ãƒE‚¯ã‚’æŒã¡è¾¼ã¾ãªãE¼‰ã€E



  runtime_flow:
    startup:
      - "Host ãEbootstrapViewerFromUrl(canvas, url, options) or bootstrapViewer(canvas, doc, options) ã‚’å‘¼ã¶"
      - "æ¨å¥¨: bootstrapViewer(canvas, doc) ã‚’ä½¿ãE ´åˆã€Host ã¯äº‹å‰ã« strict validate æ¸ˆã¿ doc ã‚’æ¸¡ã™ï¼EootstrapViewer å´ã§ validate3DSS ã¯å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹EE
      - "bootstrapViewerFromUrl ãEJSON load â†EbootstrapViewer ã«æ¸¡ã™ï¼Ealidate/deepFreeze ã¯ bootstrapViewer ãŒè¡Œã†EE
      - "bootstrapViewer ãEuiState / indices / rendererContext / viewerHub ã‚’ç”Ÿæˆã™ã‚‹ï¼ˆé E validateâ†’deepFreezeâ†’buildUUIDIndex/detectFrameRangeâ†’controllersâ†’renderer.syncDocumentâ†’getSceneMetricsâ†’cameraEngine.setStateâ†’core.recomputeVisibleSetâ†’createViewerHubEE
      - "options.devBootLog === true ã®ã¨ãã€èµ·å‹•è¨ºæ–­ãƒ­ã‚°EEOOT/MODEL/CAMERA/LAYERS/FRAMEE‰ã‚’ 1 å›ãšã¤é€ã‚‹EEogger æœªæŒE®šãªã‚Econsole.log ç›¸å½“ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯EE
      - "Host / dev harness ãEPointerInput(canvas, hub) / KeyboardInput(window, hub) ã‚’æ§‹ç¯‰ã—ã€åEåŠ›ã‚¤ãƒ™ãƒ³ãƒˆã‚’ hub.core.* / hub.pickObjectAt / hub.viewerSettings ã«é›E´E™ã‚E
      - "Host / dev harness ãEgizmo / timeline / HUD ç­‰ãE ui/* ã‚’åEæœŸåŒ–ã—ã€hub.core.* / hub.pickObjectAt ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¥ç¶šã™ã‚E
      - "Host / dev harness ãEhub.start() ã‚’å‘¼ã³ã€render loop ã‚’é–‹å§‹ã™ã‚‹ï¼ˆè¤E•°å›å‘¼ã‚“ã§ã‚Eno-opE‰ã€E
      - "çµ‚äºE™‚ã¯ hub.stop()Eˆä¸€æ™‚åœæ­¢E‰ã¾ãŸãE hub.dispose()Eˆå®ŒåEç ´æ£E¼‰ã‚’å‘¼ã¶ã€E

    frame_update:
      - "UIEElider / ãƒœã‚¿ãƒ³ / KeyboardInput ã® PgUp/PgDnE‰ãŒ hub.core.frame.setActive / step ã‚’å‘¼ã¶"
      - "core.frameController ãEactiveFrame ã‚’æ›´æ–°ã™ã‚‹EEull ã‚’è¨±å®¹EE
      - "core.frameController ã¯æ›´æ–°å¾Œã« core.recomputeVisibleSet() ã‚’å‘¼ã³ã€visibleSet å†è¨ˆç®—ã¨ selection/micro ã®å¾ŒåEçE¼Elear/exit/microState null/refreshE‰ã‚’ä¿è¨¼ã™ã‚‹"
      - "æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ ã® hub tick ã§ renderer.applyFrame(uiState.visibleSet) ãŠã‚ˆã³ renderer.applyMicroFX(uiState.microState) ãŒå‘¼ã°ã‚Œã‚‹"
      - "playback ä¸­ã¯ hub tick ãEcore.frameController.updatePlayback(dtSeconds) ã‚’å‘¼ã³ã€setActive ã‚’é€šã˜ã¦ frame ã‚’é€²è¡Œã•ã›ã‚‹"

    selection_update:
      - "PointerInput / ui picker ãEcanvas åº§æ¨™ã‹ã‚ENDC åº§æ¨™ã‚’è¨ˆç®—ã—ã€hub.pickObjectAt(ndcX, ndcY) ã‚’å‘¼ã¶"
      - "viewerHub ãErenderer.pickObjectAt ã‚’å‘¼ã³ã€ãƒ’ãƒEƒˆã‚’å¾—ã‚‹"
      - "viewerHub ã¯ visibilityController.isVisible(uuid) ã‚’ç”¨ãE¦ä¸å¯è¦Euuid ã‚’é™¤å¤–ã—ã€å¯è¦–ãƒ’ãƒEƒˆã®ã¿ {uuid, kind, ...} ã¨ã—ã¦è¿”ã™Eˆç„¡ã‘ã‚Œã° nullEE
      - "selector ãEhub.core.selection.select(uuid, kind?) ã‚’å‘¼ã¶Eˆæˆ»ã‚Šå€¤ null ã¯ã€Œä¸å¯è¦Eä¸æ­£ã§é¸æŠä¸å¯ã€ã‚‚å«ã‚€E‰ã€‚é€šå¸¸ã¯ pickObjectAt å´ã§ä¸å¯è¦–ãEé™¤å¤–æ¸ˆã¿ã€E
      - "selectionController ãEuiState.selection ã‚’æ›´æ–°"
      - "UI ãEmicro ã«å…¥ã‚ŠãŸãE ´åˆãE hub.core.mode.focus(uuid) ã¾ãŸãE hub.core.micro.enter(uuid) ã‚’å‘¼ã¶"
      - "modeController ã¯å†Eƒ¨ã§ canEnterEEsFramePlaying / isCameraAuto / visibilityController.isVisible(uuid)E‰ã‚’æº€ãŸã™å ´åˆãEã¿ micro ã«é·ç§»ã—ã€microController.refresh() ã§ uiState.microState ã‚’æ›´æ–°ã™ã‚‹"
      - "æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ ã® hub tick ã§ renderer.applyMicroFX(uiState.microState) ãŒå‘¼ã°ã‚Œã‚‹"
      - "micro ã«å…¥ã‚ŠãŸãE ã‘ãªã‚Ehub.core.mode.focus(uuid) ã ã‘ã§ã‚‚ã‚ˆãE¼Eocus å´ã§ select ã‚’åEåŒE—ã¦ã‚ˆã„é‹ç”¨ã¨ã™ã‚‹E‰ã€E

    render_loop:
      - "viewerHub.start() ã¯ (disposed===false && isRunning===false) ã®ã¨ãã ãERAF ã‚’é–‹å§‹ã™ã‚‹ï¼ˆå¤šé‡ start ã¯ no-opE‰ã€E
      - "RAF ã¯ (isRunning===true && disposed===false) ã®é–“ã ã‘ç¶™ç¶šã—ã€stop/dispose ã§æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ ä»¥é™ã‚’æ­¢ã‚ã‚‹ã€E
      - "åEƒ•ãƒ¬ãƒ¼ãƒ  tickEEub å†Eƒ¨ã®é Eºè¦ç¯E¼E"
      - "  0) if disposed: returnEEore/renderer ã«è§¦ã‚‰ãªãE¼E
      - "  1) dtSeconds ã‚’ç®—åEEˆæ¨å¥¨: clampã€‚ä¾E 0ã€E.1EE
      - "  2) DI: core.frameController.updatePlayback(dtSeconds)EEsFramePlaying ã®ã¨ããEã¿ã€‚frame ã¯ setActive çµŒç”±ã§é€²è¡Œã•ã›ã‚‹EE
      - "  3) DI: core.camera.update(dtSeconds)EEutoOrbit/è£œé–“ãªã©EE"
      - "  4) if (uiState.mode === 'micro') DI: core.microController.refresh() else uiState.microState = null"
      - "  5) renderer.updateCamera(core.camera.getState())"
      - "  6) renderer.applyFrame(uiState.visibleSet)"
      - "  7) renderer.applyViewerSettings(uiState.viewerSettings)"
      - "  8) renderer.applyMicroFX(uiState.microState)"
      - "  9) if (uiState.mode === 'macro' && uiState.microState === null) renderer.applySelection(uiState.selection)"
      - " 10) renderer.render()"

      - "å„ªå…ˆé E½ï¼ˆè¦ç¯E¼E microFX > selectionEEacroEE> baseStyleEE ç«¶åˆã•ã›ãªãE€‚micro ä¸­ã¯ selection ã‚’é©ç”¨ã—ãªãE¼E

    resize_update:
      - "Host ãEcanvasEˆã¾ãŸãE wrapperE‰ãEã‚µã‚¤ã‚ºå¤‰åŒ–ã‚’æ¤œçŸ¥ã™ã‚‹EEesizeObserver æ¨å¥¨EE
      - "Host ãEwidth=canvas.clientWidth, height=canvas.clientHeight ã‚’è¨ˆç®—ã™ã‚E
      - "Host ãEhub.resize(width, height) ã‚’å‘¼ã¶EEIâ†’renderer ç›´çµãEç¦æ­¢ã®ãŸã‚ hub çµŒç”±ãŒæ­£è¦ãƒ«ãƒ¼ãƒˆï¼E
      - "hub.resize ãErenderer.resize(width,height) ã‚’å‘¼ã³ã€renderer ãEsetSize + camera.aspect æ›´æ–°ã‚’è¡Œã†"
      - "hub.resize ã¯ç¶šã‘ã¦ renderer.updateCamera(hub.core.camera.getState()) ã‚’å‘¼ã¶EEesize å¾ŒãEç¢ºå®šåæ˜ EE
