# 3DSL / Viewer / Modeler ― 三層構造の思想と責務

このドキュメントは、3DSL プロジェクト全体の設計議論が迷子になったときに**必ず戻る「岩盤」**として書く。
README やチュートリアルではなく、**役割分担・責務境界・SSOT（単一の真実）**を固定するためのもの。

---

## 0. 用語

- **3DSL**: 三次元構造言語。概念・関係・構造を表現するための**言語（データ契約）**。
- **3DSS**: 3DSL の実体データ（シーン/モデル）を表すスキーマ・フォーマット群。
- **Viewer**: 3DSS を「読む」アプリ。閲覧・理解・共有体験を最適化する。
- **Modeler**: 3DSS を「書く」アプリ。編集・検証・保存を最適化する。
- **SSOT**: Single Source of Truth。定義や契約の一次情報が置かれる場所。

---

## 1. 3DSL は「アプリ」ではなく「言語」である

3DSL の中心は UI ではない。中心は **schema / contract / content rules** という「言語の契約」である。

- UI は時代や環境で変わる
- データ契約は長期に安定して積み上がる
- したがって、データ契約が SSOT、UI はその実装である

この順序を崩すと「UI 都合でデータが壊れる」「移植できない」「閲覧者が増えるほど互換が破綻する」。

---

## 2. なぜ Viewer と Modeler を分離するのか

**Viewer と Modeler は、目的関数が違う。**

### Viewer の目的
- 読む（理解する）
- 見せる（共有する）
- 体験として気持ちよくする（UX）

### Modeler の目的
- 書く（編集する）
- 壊さない（検証する）
- 保存・差分・復元を安定させる（作業安全性）

両者を一つにすると、どちらの UX も中途半端になり、結果として「読む人」も「書く人」も増えない。

---

## 3. 責務境界（何をどこが決めるか）

### 3DSL / 3DSS（言語・契約）が決める
- スキーマ（必須/任意、型、制約）
- 命名・意味付け（signification 等）
- 互換性のルール（versioning、非推奨、拡張方針）
- 参照・メタデータ（rights, references 等）

### Viewer（読む装置）が決める
- 表示・演出・ナビゲーション（カメラ、ハイライト、アニメ等）
- 「読者」の導線（一覧、検索、戻る、共有）
- 互換の許容（古いデータの読み取り救済は Viewer 側が担当することがある）

### Modeler（書く装置）が決める
- 編集体験（選択、プロパティ、適用、Undo/Redo）
- 保存体験（Save/SaveAs、dirty、衝突回避）
- 検証体験（QuickCheck 等）
- 入力のショートハンド（UI のための入力は、保存時に正規化する）

---

## 4. SSOT → mirror → runtime の一本化

この repo は「編集して良い場所」と「生成される場所」を分ける。

- **SSOT**: 人間が編集する一次情報（例: `packages/docs/docs/**`, `apps/*/ssot/**`）
- **mirror**: SSOT を同期して配布・実行のために置く二次コピー（例: `apps/site/src/content/docs/**`, `apps/modeler/public/**`, `vendor` mirroring）
- **runtime**: ビルド・実行時に生成される成果物（例: `dist/**` など）

原則:
- mirror/runtime は**手編集しない**
- 変更は SSOT に戻す
- 同期スクリプト（sync）が境界の唯一の通路

---

## 5. 「public / dist / vendor を触るな」の理由

これらを手で触ると、次の問題が必ず起きる。

- 同期で上書きされ、変更が消える
- SSOT と乖離し、再現性が失われる
- 「どれが正しいのか」が人によって変わる（SSOT 崩壊）

よって、レビュー規範として **生成物/ミラーは触らない** を固定する。

---

## 6. 拡張（他 Viewer / 他 Modeler へ）

Viewer と Modeler の分離は、将来の拡張を可能にする。

- 別 UI・別実装でも、3DSS（契約）が同じなら互換になる
- Modeler は複数あって良い（用途別: 軽量 / 高機能 / バッチ変換）
- Viewer も複数あって良い（用途別: 埋め込み / プレゼン / VR）

ここでも中心は UI ではなく **契約（3DSS）**である。

---

## 7. 迷ったときの判断基準（YES/NO を切る）

1. それは SSOT を増やしていないか（重複定義してないか）
2. mirror/runtime を手編集していないか
3. Viewer と Modeler の責務を混ぜていないか
4. 保存されるデータはスキーマに正規化されているか
5. 将来「別実装」でも再現できるか

この 5 点のどれかが NO なら、設計を戻す。
