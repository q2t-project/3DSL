# 0. Purpose
本書は、3DSL プロジェクトにおける AI 実装系（Codex）を統制し、仕様解釈の逸脱・冗長化・責務混同を防ぐための行動指針を定める。
Codex はこの文書を常に仕様入力の前提とし、/specs/ 配下の文書を唯一の仕様源とみなす。

# 1. 役割定義（Roles of Agents）
| エージェント      | 機能              | 入力                              | 出力                       | 主責任      |
| ----------- | --------------- | ------------------------------- | ------------------------ | -------- |
| **ChatGPT** | 構造設計・仕様整理・文書整形  | 人間との対話・meta情報                   | `/specs/*.md`            | 仕様の一貫性維持 |
| **Codex**   | コード生成・UI構築・実装展開 | `/specs/*.md` `/schemas/*.json` | `/code/` 以下の構成物          | 実装の正確性   |
| **Human**   | 判断・操作・承認        | Codex出力・動作結果                    | Git commit・update_log.md | 意思決定と承認  |

# 2. 指令体系（Command Hierarchy）
## 2.1 指令文書の階層
 1. /specs/3DSD-sharedspec.md — 共通命名・依存規則・制約
 2. /specs/3DSD-modeler.md — Modeler 実装仕様
 3. /specs/3DSD-viewer.md — Viewer 実装仕様
 4. /specs/uml/3DSL_**.puml — データ構造のUML図
 5. /schemas/3DSS.schema.json — データ構造の厳密定義
- Codex は上記の順に優先解釈すること。この優先順位は、概念上の順位ではなく、コーディング統制を図るための処理順序である。
- CodexおよびChatGPTは、/specs/uml/ 内のPlantUMLファイルを構造解析対象とする。各 `.puml` は仕様整合性チェックおよびCodex Directive展開時に参照される。
- schema は最終チェックに用い、設計の判断基準には使わない。

# 3. 実行責務（Execution Responsibilities）
| 層       | 担当            | 内容                           | 備考                        |
| ------- | ------------- | ---------------------------- | ------------------------- |
| **仕様層** | ChatGPT＋Human | /specs/ および /schemas/ の編集・承認 | Gitで履歴管理                  |
| **生成層** | Codex         | 指令テンプレートに基づくコード出力            | `/code/` に限定              |
| **検証層** | Human         | 実機操作と結果観察                    | `/logs/runtime/` に保存      |
| **反映層** | ChatGPT＋Human | 仕様への改訂反映                     | `/meta/update_log.md` に記録 |

# 4. Codex 実行指令規約（Directive Protocol）
| 規約ID     | 名称      | 内容                                                           |
| -------- | ------- | ------------------------------------------------------------ |
| **D-01** | 仕様起点原則  | Codexは常に `/specs/*.md` を一次参照し、スキーマやコメントから仕様を推測しない。           |
| **D-02** | 出力領域固定  | `/code/` 以下のみ生成対象。 `/meta/`, `/specs/`, `/schemas/` は書き換え禁止。 |
| **D-03** | ログ分離原則  | 生成時と実行時のログを明確に分離。 `/logs/codex/` に記録。                        |
| **D-04** | 仕様タグ厳守  | 各仕様書のセクション見出し（例：`# 3. I/O 定義`）をコード上のモジュール名として解釈。             |
| **D-05** | 責務独立    | Modeler・Viewer 間でコードを共有しない。共通要素は sharedspec 由来として自動展開。       |
| **D-06** | 出力整合性検査 | Codex生成直後に自動 selftest を走らせ、失敗時は出力を中断する。                      |

# 5. データアクセス規約（Data Access Rules）
| 項目          | 規定                           |
| ----------- | ---------------------------- |
| **サンプルデータ** | `/data/sample/` 配下のみ利用可。     |
| **出力先**     | `/data/exports/` に限る。書き換え禁止。 |
| **外部通信**    | 一切禁止。API呼出・fetch等の自動生成を行わない。 |

# 6. 再生成ポリシー（Regeneration Policy）
- sharedspec 更新後、Codex は modeler・viewer のみ再生成対象とする。
- schema の変更は、sharedspec の §2 Validation に反映された後でのみ許可。
- proto 生成後に人間評価が済むまでは再生成禁止。

# 7. コード出力ガイドライン（Output Guidelines）
- HTML/CSS/JS の分離構造を守る。
- すべてのファイルは UTF-8（NFC）で保存。
- コメントは仕様節番号で統一（例：// §3.4 内部データ構造）。
- UI 文言・ログ出力は sharedspec に従う。
- ファイルヘッダに自動生成識別子を付与：
 // Auto-generated by Codex (based on 3DSD-modeler.md §3)
 // Do not edit manually.

# 8. 管理と監査（Governance）
- /meta/update_log.md に Codex の出力実行履歴を追記。
- ChatGPT は常に AGENTS.md を監査参照し、逸脱検出時に警告を出す。
- Codex は自動再試行を行わず、必ず人間操作を待つ。
- 指令実行が全て完了した後、最新のリポジトリの構成を/repo_structure.txtに追記更新する。